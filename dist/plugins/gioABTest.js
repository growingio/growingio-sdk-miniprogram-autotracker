var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t=function(e){return["undefined","null"].includes(d(e))},r=function(e){return"string"===d(e)},n=function(e){return"NaN"===c(Number(e))},i=function(e){return"number"===d(e)},o=function(e){return"[object Object]"==={}.toString.call(e)&&!t(e)},a=function(e){return Array.isArray(e)&&"array"===d(e)},c=function(e){return t(e)?"":"".concat(e)},s=function(e){return o(e)?Object.keys(e):[]},u=function(e,t){if(!o(e))return!1;try{if("string"===d(t))return delete e[t];if("array"===d(t))return t.map((function(t){return delete e[t]}));"object"===d(t)&&t.constructor===RegExp&&s(e).forEach((function(r){t.test(r)&&u(e,r)}))}catch(e){return!1}},g=function(e){return a(e)?0===e.length:o(e)?0===s(e).length:!e},d=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},l=/^\d+_gdp_abt_sign$/,f=/^\d+_gdp_abtd$/,v=function(e,t){console.log("%c[GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},m=function(e,t){if(["function","asyncfunction"].includes(d(e)))try{e(t)}catch(e){v("回调执行失败！".concat(e),"error")}},y=function(e){var r={};return o(e)&&(u(e,"&&sendTo"),function(e){s(e).forEach((function(n){return function(e,n){var i=c(n).slice(0,100);o(e)?r[i]=y(e):a(e)?(r[i]=function(e,t){if(void 0===t&&(t=!1),a(e)){for(var r=0,n=[],i=0,o=e;i<o.length;i++){var c=o[i];c&&!g(c)&&(n[r++]=c),t&&0===c&&(n[r++]=c)}return n}return e}(e.slice(0,100),!0),r[i]=r[i].join("||").slice(0,1e3)):function(e){return"date"===d(e)}(e)?r[i]=function(e){function t(e){return 10>e?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}(e):r[i]=t(e)?"":c(e).slice(0,1e3)}(e[n],n)}))}(e)),r},I=function(e,t){void 0===t&&(t=!1);var r=0;if(g(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r|=0,n++;return t?Math.abs(r):r},p={name:"gioABTest",method:function(t,a){var d=this;this.growingIO=t,this.timeoutCheck=function(e,t){d.requestInterval=i(Number(e))&&!n(Number(e))?Number(e):5,(d.requestInterval>1440||0>d.requestInterval)&&(d.requestInterval=5),d.requestTimeout=i(Number(t))&&!n(Number(t))?Number(t):1e3,(d.requestTimeout>5e3||100>d.requestTimeout)&&(d.requestTimeout=1e3)},this.abtStorageCheck=function(){var e,t=d.growingIO.minipInstance,r=(null===(e=t.minip)||void 0===e?void 0:e.getStorageInfoSync().keys)||[];r.filter((function(e){return l.test(e)})).forEach((function(e){var r=t.getStorageSync(e);r&&r>=Date.now()||t.removeStorageSync(e)})),r.filter((function(e){return f.test(e)})).forEach((function(e){g(t.getStorageSync(e))&&t.removeStorageSync(e)}))},this.getHashKey=function(e,t){var r=d.growingIO,n=r.userStore.getUid,i=r.vdsConfig.projectId;return I("".concat(e,"#").concat(i,"#").concat(n(),"#").concat(t),!0)},this.generateUrl=function(e,t){var n,i;d.newDevice&&!d.visitSids[e]&&(d.visitSids[e]=d.growingIO.userStore.getSessionId(e)),i="http",r(n=t)||(n=c(n)),n.slice(0,4)!==i?d.url[e]="https://".concat(t,"/diversion/specified-layer-variables"):d.url[e]="".concat(t,"/diversion/specified-layer-variables")},this.getABTest=function(e,t,r){if(g(d.url[e])&&d.generateUrl(e,"https://ab.growingio.com"),!t)return v("获取ABTest数据失败! 实验层Id不合法!","error"),void m(r,{});var n=d.growingIO.minipInstance,i=n.getStorageSync("".concat(d.getHashKey(e,t),"_gdp_abt_sign"))||0,o=n.getStorageSync("".concat(d.getHashKey(e,t),"_gdp_abtd"))||{};!i||i<Date.now()?d.initiateRequest(e,t,o,r):m(r,o)},this.initiateRequest=function(t,r,n,i){var o=d.growingIO,a=o.userStore,c=a.getUid,s=a.getSessionId,u=o.dataStore,g=o.minipInstance,l=u.getTrackerVds(t),f=l.projectId,y=l.dataSourceId;g.request({url:d.url[t],header:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{accountId:f,datasourceId:y,distinctId:c(),layerId:r,newDevice:d.visitSids[t]===s(t)},timeout:d.requestTimeout,success:function(o){var a=o.data;0===a.code?d.experimentVerify(t,e(e({},a),{layerId:r}),n,i):(v("获取ABTest数据失败! ".concat(a.errorMsg,"!"),"error"),m(i,{})),g.setStorageSync("".concat(d.getHashKey(t,r),"_gdp_abt_sign"),Date.now()+6e4*d.requestInterval)},fail:function(e){var o=e.errMsg;o.indexOf("timeout")>-1?(v("获取ABTest数据失败! 请求超时!","error"),m(i,{})):2>d.retryCount?(d.initiateRequest(t,r,n,i),d.retryCount+=1):(v("获取ABTest数据失败! ".concat(JSON.stringify(o).slice(0,30),"!"),"error"),m(i,{}))}})},this.experimentVerify=function(t,r,n,i){var o=r.layerId,a=r.strategyId,s=r.experimentId,g=r.layerName,l=r.experimentName,f=r.strategyName,v=r.variables,y="".concat(d.getHashKey(t,o),"_gdp_abtd"),p={layerId:c(o),strategyId:c(a),experimentId:c(s),variables:v},h=e({},n);u(h,["layerName","strategyName","experimentName"]);var S=I(JSON.stringify(p)),b=I(JSON.stringify(h)),w=e(e({},p),{layerName:g,strategyName:f,experimentName:l});d.growingIO.minipInstance.setStorageSync(y,w,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),S!==b&&a&&s&&d.buildExperimentHitEvent(t,w),m(i,w)},this.buildExperimentHitEvent=function(t,r){var n,i=d.growingIO.dataStore,o=i.eventContextBuilder,a=i.eventConverter,c=e({eventType:"CUSTOM",eventName:"$exp_hit"},o(t)),s=r.layerId,u=r.experimentId,g=r.strategyId,l=r.layerName,f=r.experimentName,v=r.strategyName;c.attributes=y(e(e({},null!==(n=c.attributes)&&void 0!==n?n:{}),{$exp_layer_id:s,$exp_id:u,$exp_strategy_id:g,$exp_layer_name:l,$exp_name:f,$exp_strategy_name:v})),a(c)},this.pluginVersion="4.3.2";var p=null!=a?a:{},h=p.abServerUrl,S=void 0===h?"https://ab.growingio.com":h,b=p.requestInterval,w=p.requestTimeout;this.timeoutCheck(b,w);var _=this.growingIO,N=_.emitter,O=_.userStore;this.growingIO.getABTest=this.getABTest,this.visitSids={},N.on("OPTION_INITIALIZED",(function(){g(S)?v("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(d.abtStorageCheck(),d.url={},r(S)?d.generateUrl(d.growingIO.trackingId,S):o(S)&&s(S).forEach((function(e){d.generateUrl(e,S[e])})))})),N.on("UID_UPDATE",(function(e){var t=e.newUId;if(!e.oldUId&&t)if(r(S)){var n=d.growingIO.trackingId,i=O.getSessionId(n);d.visitSids[n]=i}else o(S)&&s(S).forEach((function(e){var t=O.getSessionId(e);d.visitSids[e]=t}))})),this.retryCount=0}};export{p as default};
