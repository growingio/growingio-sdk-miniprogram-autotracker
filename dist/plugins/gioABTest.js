var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t=function(e){return["undefined","null"].includes(l(e))},r=function(e){return"string"===l(e)},n=function(e){return"NaN"===c(Number(e))},i=function(e){return"number"===l(e)},a=function(e){return"[object Object]"==={}.toString.call(e)&&!t(e)},o=function(e){return Array.isArray(e)&&"array"===l(e)},c=function(e){return t(e)?"":"".concat(e)},u=function(e){return a(e)?Object.keys(e):[]},s=function(e,t){if(!a(e))return!1;try{if("string"===l(t))return delete e[t];if("array"===l(t))return t.map((function(t){return delete e[t]}));"object"===l(t)&&t.constructor===RegExp&&u(e).forEach((function(r){t.test(r)&&s(e,r)}))}catch(e){return!1}},g=function(e){return o(e)?0===e.length:a(e)?0===u(e).length:!e},l=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},f=/^\d+_gdp_abt_sign$/,d=/^\d+_gdp_abtd$/,m=function(e,t){console.log("%c[GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},y=function(e,t){if(["function","asyncfunction"].includes(l(e)))try{e(t)}catch(e){m("回调执行失败！".concat(e),"error")}},v=function(e){var r={};return a(e)&&(s(e,"&&sendTo"),function(e){u(e).forEach((function(n){return function(e,n){var i=c(n).slice(0,100);a(e)?r[i]=v(e):o(e)?(r[i]=function(e,t){if(void 0===t&&(t=!1),o(e)){for(var r=0,n=[],i=0,a=e;i<a.length;i++){var c=a[i];c&&!g(c)&&(n[r++]=c),t&&0===c&&(n[r++]=c)}return n}return e}(e.slice(0,100),!0),r[i]=r[i].join("||").slice(0,1e3)):function(e){return"date"===l(e)}(e)?r[i]=function(e){function t(e){return 10>e?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}(e):r[i]=t(e)?"":c(e).slice(0,1e3)}(e[n],n)}))}(e)),r},p=function(e,t){void 0===t&&(t=!1);var r=0;if(g(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r|=0,n++;return t?Math.abs(r):r},h={name:"gioABTest",method:function(t,o){var l=this;this.growingIO=t,this.timeoutCheck=function(e,t){l.requestInterval=i(Number(e))&&!n(Number(e))?Number(e):5,(l.requestInterval>1440||0>l.requestInterval)&&(l.requestInterval=5),l.requestTimeout=i(Number(t))&&!n(Number(t))?Number(t):1e3,(l.requestTimeout>5e3||100>l.requestTimeout)&&(l.requestTimeout=1e3)},this.abtStorageCheck=function(){var e,t=l.growingIO.minipInstance,r=(null===(e=t.minip)||void 0===e?void 0:e.getStorageInfoSync().keys)||[];r.filter((function(e){return f.test(e)})).forEach((function(e){var r=t.getStorageSync(e);r&&r>=Date.now()||t.removeStorageSync(e)})),r.filter((function(e){return d.test(e)})).forEach((function(e){g(t.getStorageSync(e))&&t.removeStorageSync(e)}))},this.getHashKey=function(e,t){var r=l.growingIO,n=r.userStore.getUid,i=r.vdsConfig.projectId;return p("".concat(e,"#").concat(i,"#").concat(n(),"#").concat(t),!0)},this.generateUrl=function(e,t){var n,i;i="http",r(n=t)||(n=c(n)),n.slice(0,4)!==i?l.url[e]="https://".concat(t,"/diversion/specified-layer-variables"):l.url[e]="".concat(t,"/diversion/specified-layer-variables")},this.getABTest=function(e,t,r){if(g(l.url[e])&&l.generateUrl(e,"https://ab.growingio.com"),!t)return m("获取ABTest数据失败! 实验层Id不合法!","error"),void y(r,{});var n=l.growingIO.minipInstance,i=n.getStorageSync("".concat(l.getHashKey(e,t),"_gdp_abt_sign"))||0,a=n.getStorageSync("".concat(l.getHashKey(e,t),"_gdp_abtd"))||{};!i||i<Date.now()?l.initiateRequest(e,t,a,r):y(r,a)},this.initiateRequest=function(t,r,n,i){var a=l.growingIO,o=a.userStore.getUid,c=a.dataStore,u=a.minipInstance,s=c.getTrackerVds(t),g=s.projectId,f=s.dataSourceId;u.request({url:l.url[t],header:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{accountId:g,datasourceId:f,distinctId:o(),layerId:r},timeout:l.requestTimeout,success:function(a){var o=a.data;0===o.code?l.experimentVerify(t,e(e({},o),{layerId:r}),n,i):(m("获取ABTest数据失败! ".concat(o.errorMsg,"!"),"error"),y(i,{})),u.setStorageSync("".concat(l.getHashKey(t,r),"_gdp_abt_sign"),Date.now()+6e4*l.requestInterval)},fail:function(e){var a=e.errMsg;a.indexOf("timeout")>-1?(m("获取ABTest数据失败! 请求超时!","error"),y(i,{})):2>l.retryCount?(l.initiateRequest(t,r,n,i),l.retryCount+=1):(m("获取ABTest数据失败! ".concat(JSON.stringify(a).slice(0,30),"!"),"error"),y(i,{}))}})},this.experimentVerify=function(t,r,n,i){var a=r.layerId,o=r.strategyId,u=r.experimentId,g=r.layerName,f=r.experimentName,d=r.strategyName,m=r.variables,v="".concat(l.getHashKey(t,a),"_gdp_abtd"),h={layerId:c(a),strategyId:c(o),experimentId:c(u),variables:m},I=e({},n);s(I,["layerName","strategyName","experimentName"]);var S=p(JSON.stringify(h)),b=p(JSON.stringify(I)),w=e(e({},h),{layerName:g,strategyName:d,experimentName:f});l.growingIO.minipInstance.setStorageSync(v,w,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),S!==b&&o&&u&&l.buildExperimentHitEvent(t,w),y(i,w)},this.buildExperimentHitEvent=function(t,r){var n,i=l.growingIO.dataStore,a=i.eventContextBuilder,o=i.eventConverter,c=e({eventType:"CUSTOM",eventName:"$exp_hit"},a(t)),u=r.layerId,s=r.experimentId,g=r.strategyId,f=r.layerName,d=r.experimentName,m=r.strategyName;c.attributes=v(e(e({},null!==(n=c.attributes)&&void 0!==n?n:{}),{$exp_layer_id:u,$exp_id:s,$exp_strategy_id:g,$exp_layer_name:f,$exp_name:d,$exp_strategy_name:m})),o(c)},this.pluginVersion="4.3.0";var h=null!=o?o:{},I=h.abServerUrl,S=void 0===I?"https://ab.growingio.com":I,b=h.requestInterval,w=h.requestTimeout;this.timeoutCheck(b,w);var N=this.growingIO.emitter;this.growingIO.getABTest=this.getABTest,N.on("OPTION_INITIALIZED",(function(){g(S)?m("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(l.abtStorageCheck(),l.url={},r(S)?l.generateUrl(l.growingIO.trackingId,S):a(S)&&u(S).forEach((function(e){l.generateUrl(e,S[e])})))})),this.retryCount=0}};export{h as default};
