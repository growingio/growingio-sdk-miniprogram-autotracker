var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)},t=function(e){return["undefined","null"].includes(u(e))},r=function(e){return"NaN"===o(Number(e))},n=function(e){return"number"===u(e)},i=function(e){return"[object Object]"==={}.toString.call(e)&&!t(e)},o=function(e){return t(e)?"":""+e},a=function(e){return function(e){return Array.isArray(e)&&"array"===u(e)}(e)?0===e.length:i(e)?0===function(e){return i(e)?Object.keys(e):[]}(e).length:!e},u=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},s=function(e,t){console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},c=function(e,t){if(["function","asyncfunction"].includes(u(e)))try{e(t)}catch(e){s("回调执行失败！"+e,"error")}},g=function(e){var t=0;if(a(e)||"boolean"==typeof e)return t;for(var r=0;r<e.length;)t=(t<<5)-t+e.charCodeAt(r),t&=t,r++;return t},l={name:"gioABTest",method:function(t,i){var u=this;this.growingIO=t,this.timeoutCheck=function(e,t){u.requestInterval=n(Number(e))&&!r(Number.parseInt(e,10))?Number.parseInt(e,10):5,(u.requestInterval>1440||0>u.requestInterval)&&(u.requestInterval=5),u.requestTimeout=n(Number(t))&&!r(Number.parseInt(t,10))?Number.parseInt(t,10):1e3,(u.requestTimeout>5e3||100>u.requestTimeout)&&(u.requestTimeout=1e3)},this.abtStorageCheck=function(){var e,t=u.growingIO.minipInstance,r=(null===(e=t.minip)||void 0===e?void 0:e.getStorageInfoSync().keys)||[];r.filter((function(e){return/^\d+_gdp_abt_sign$/.test(e)})).forEach((function(e){var r=t.getStorageSync(e);r&&r>=Date.now()||t.removeStorageSync(e)})),r.filter((function(e){return/^\d+_gdp_abtd$/.test(e)})).forEach((function(e){a(t.getStorageSync(e))&&t.removeStorageSync(e)}))},this.getHashKey=function(e){var t=u.growingIO,r=t.userStore.uid,n=t.vdsConfig.projectId;return Math.abs(g(n+"#"+r+"#"+e))},this.generateUrl=function(e){var t;t="http",e.slice(0,4)!==t?u.url="https://"+e+"/diversion/specified-layer-variables":u.url=e+"/diversion/specified-layer-variables"},this.getABTest=function(e,t){if(u.url){if(!e)return s("获取ABTest数据失败! 实验层Id不合法!","error"),void c(t,{});var r=u.growingIO.minipInstance,n=r.getStorageSync(u.getHashKey(e)+"_gdp_abt_sign")||0,i=r.getStorageSync(u.getHashKey(e)+"_gdp_abtd")||{};!n||n<Date.now()?u.initiateRequest(e,i,t):c(t,i)}else c(t,{})},this.initiateRequest=function(t,r,n){var i=u.growingIO,o=i.userStore.uid,a=i.vdsConfig,g=a.projectId,l=a.dataSourceId,d=i.minipInstance;d.request({url:u.url,header:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{accountId:g,datasourceId:l,distinctId:o,layerId:t},timeout:u.requestTimeout,success:function(i){var o=i.data;0===o.code?u.experimentVerify(e(e({},o),{layerId:t}),r,n):(s("获取ABTest数据失败! "+o.errorMsg+"!","error"),c(n,{})),d.setStorageSync(u.getHashKey(t)+"_gdp_abt_sign",Date.now()+6e4*u.requestInterval)},fail:function(e){var i=e.errMsg;i.indexOf("timeout")>-1?(s("获取ABTest数据失败! 请求超时!","error"),c(n,{})):2>u.retryCount?(u.initiateRequest(t,r,n),u.retryCount+=1):(s("获取ABTest数据失败! "+JSON.stringify(i).slice(0,30)+"!","error"),c(n,{}))}})},this.experimentVerify=function(e,t,r){var n=e.layerId,i=e.strategyId,a=e.experimentId,s=e.variables,l=u.getHashKey(n)+"_gdp_abtd",d={layerId:o(n),strategyId:o(i),experimentId:o(a),variables:s};g(JSON.stringify(d))!==g(JSON.stringify(t))&&(u.growingIO.minipInstance.setStorageSync(l,d,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),i&&a&&u.buildExperimentHitEvent(o(n),o(a),o(i))),c(r,d)},this.buildExperimentHitEvent=function(t,r,n){var i=u.growingIO.dataStore,o=i.eventContextBuilder;(0,i.eventConverter)(e(e({eventType:"CUSTOM",eventName:"$exp_hit",attributes:{$exp_layer_id:t,$exp_id:r,$exp_strategy_id:n}},o()),{customEventType:0}))};var l=null!=i?i:{},d=l.abServerUrl,f=l.requestInterval,v=l.requestTimeout;this.timeoutCheck(f,v);var y=this.growingIO.emitter;this.growingIO.getABTest=this.getABTest,y.on("OPTION_INITIALIZED",(function(){d?(u.abtStorageCheck(),u.generateUrl(d)):s("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn")})),this.retryCount=0}};export default l;
