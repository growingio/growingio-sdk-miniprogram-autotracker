var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t=function(e){return["undefined","null"].includes(l(e))},r=function(e){return"string"===l(e)},n=function(e){return"NaN"===c(Number(e))},i=function(e){return"number"===l(e)},o=function(e){return"[object Object]"==={}.toString.call(e)&&!t(e)},a=function(e){return Array.isArray(e)&&"array"===l(e)},c=function(e){return t(e)?"":"".concat(e)},u=function(e){return o(e)?Object.keys(e):[]},s=function(e,t){if(!o(e))return!1;try{if("string"===l(t))return delete e[t];if("array"===l(t))return t.map((function(t){return delete e[t]}));"object"===l(t)&&t.constructor===RegExp&&u(e).forEach((function(r){t.test(r)&&s(e,r)}))}catch(e){return!1}},g=function(e){return a(e)?0===e.length:o(e)?0===u(e).length:!e},l=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},f=/^\d+_gdp_abt_sign$/,d=/^\d+_gdp_abtd$/,v=function(e,t){console.log("%c[GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},h=function(e,t){if(["function","asyncfunction"].includes(l(e)))try{e(t)}catch(e){v("回调执行失败！".concat(e),"error")}},y=function(e){var r={};return o(e)&&(s(e,"&&sendTo"),function(e,n){u(e).forEach((function(n){return function(e,n){var i=c(n).slice(0,100);o(e)?r[i]=y(e):a(e)?(r[i]=function(e,t){if(void 0===t&&(t=!1),a(e)){for(var r=0,n=[],i=0,o=e;i<o.length;i++){var c=o[i];c&&!g(c)&&(n[r++]=c),t&&0===c&&(n[r++]=c)}return n}return e}(e.slice(0,100),!0),r[i]=r[i].join("||").slice(0,1e3)):function(e){return"date"===l(e)}(e)?r[i]=function(e){function t(e){return 10>e?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}(e):r[i]=t(e)?"":c(e).slice(0,1e3)}(e[n],n)}))}(e)),r},p=function(e,t){void 0===t&&(t=!1);var r=0;if(g(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r|=0,n++;return t?Math.abs(r):r},I={name:"gioABTest",method:function(t,a){var s=this;this.growingIO=t,this.timeoutCheck=function(e,t){s.requestInterval=i(Number(e))&&!n(Number(e))?Number(e):5,(s.requestInterval>1440||0>s.requestInterval)&&(s.requestInterval=5),s.requestTimeout=i(Number(t))&&!n(Number(t))?Number(t):1e3,(s.requestTimeout>5e3||100>s.requestTimeout)&&(s.requestTimeout=1e3)},this.abtStorageCheck=function(){var e,t=s.growingIO.minipInstance,r=(null===(e=t.minip)||void 0===e?void 0:e.getStorageInfoSync().keys)||[];r.filter((function(e){return f.test(e)})).forEach((function(e){var r=t.getStorageSync(e);r&&r>=Date.now()||t.removeStorageSync(e)})),r.filter((function(e){return d.test(e)})).forEach((function(e){g(t.getStorageSync(e))&&t.removeStorageSync(e)}))},this.getHashKey=function(e,t){var r=s.growingIO,n=r.userStore.getUid,i=r.vdsConfig.projectId;return p("".concat(e,"#").concat(i,"#").concat(n(),"#").concat(t),!0)},this.generateUrl=function(e,t){var n,i;i="http",r(n=t)||(n=c(n)),n.slice(0,4)!==i?s.url[e]="https://".concat(t,"/diversion/specified-layer-variables"):s.url[e]="".concat(t,"/diversion/specified-layer-variables")},this.getABTest=function(e,t,r){if(g(s.url[e])&&s.generateUrl(e,"https://ab.growingio.com"),!t)return v("获取ABTest数据失败! 实验层Id不合法!","error"),void h(r,{});var n=s.growingIO.minipInstance,i=n.getStorageSync("".concat(s.getHashKey(e,t),"_gdp_abt_sign"))||0,o=n.getStorageSync("".concat(s.getHashKey(e,t),"_gdp_abtd"))||{};!i||i<Date.now()?s.initiateRequest(e,t,o,r):h(r,o)},this.initiateRequest=function(t,r,n,i){var o=s.growingIO,a=o.userStore.getUid,c=o.dataStore,u=o.minipInstance,g=c.getTrackerVds(t),l=g.projectId,f=g.dataSourceId;u.request({url:s.url[t],header:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:{accountId:l,datasourceId:f,distinctId:a(),layerId:r},timeout:s.requestTimeout,success:function(o){var a=o.data;0===a.code?s.experimentVerify(t,e(e({},a),{layerId:r}),n,i):(v("获取ABTest数据失败! ".concat(a.errorMsg,"!"),"error"),h(i,{})),u.setStorageSync("".concat(s.getHashKey(t,r),"_gdp_abt_sign"),Date.now()+6e4*s.requestInterval)},fail:function(e){var o=e.errMsg;o.indexOf("timeout")>-1?(v("获取ABTest数据失败! 请求超时!","error"),h(i,{})):2>s.retryCount?(s.initiateRequest(t,r,n,i),s.retryCount+=1):(v("获取ABTest数据失败! ".concat(JSON.stringify(o).slice(0,30),"!"),"error"),h(i,{}))}})},this.experimentVerify=function(e,t,r,n){var i=t.layerId,o=t.strategyId,a=t.experimentId,u=t.variables,g="".concat(s.getHashKey(e,i),"_gdp_abtd"),l={layerId:c(i),strategyId:c(o),experimentId:c(a),variables:u};p(JSON.stringify(l))!==p(JSON.stringify(r))&&(s.growingIO.minipInstance.setStorageSync(g,l,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),o&&a&&s.buildExperimentHitEvent(e,c(i),c(a),c(o))),h(n,l)},this.buildExperimentHitEvent=function(t,r,n,i){var o,a=s.growingIO.dataStore,c=a.eventContextBuilder,u=a.eventConverter,g=e({eventType:"CUSTOM",eventName:"$exp_hit"},c(t));g.attributes=y(e(e({},null!==(o=g.attributes)&&void 0!==o?o:{}),{$exp_layer_id:r,$exp_id:n,$exp_strategy_id:i})),u(g)},this.pluginVersion="4.2.0";var l=null!=a?a:{},I=l.abServerUrl,m=void 0===I?"https://ab.growingio.com":I,S=l.requestInterval,b=l.requestTimeout;this.timeoutCheck(S,b);var w=this.growingIO.emitter;this.growingIO.getABTest=this.getABTest,w.on("OPTION_INITIALIZED",(function(){g(m)?v("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(s.abtStorageCheck(),s.url={},r(m)?s.generateUrl(s.growingIO.trackingId,m):o(m)&&u(m).forEach((function(e){s.generateUrl(e,m[e])})))})),this.retryCount=0}};export{I as default};
