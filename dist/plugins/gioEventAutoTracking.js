var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var i in t=arguments[n])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,n=/^\d{1,10}$/,r=/^_[0-9a-z]+/,i=/^_n_[0-9]+$/,o=function(e){return"[object Object]"==={}.toString.call(e)&&!function(e){return["undefined","null"].includes(a(e))}(e)},a=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},l=function(e){var t;return"string"===a(e)?null!==(t=function(){try{return JSON.parse(e)}catch(e){return}}())&&void 0!==t?t:{}:null!=e?e:{}},c="ON_SEND_AFTER",u={name:"gioEventAutoTracking",method:function(u){var s=this;this.growingIO=u,this.circleOpen=!1,this.main=function(e,n){var r,i,o=s.growingIO,a=o.vdsConfig,l=o.platformConfig,c=o.plugins,u=o.emitter,d=o.trackingId;if(!(!a.autotrack||!n||t.get(e,"currentTarget.dataset.growingIgnore")||t.get(e,"target.dataset.growingIgnore")||!t.get(e,"target.dataset.growingTrack")&&"autoplay"===t.get(e,"detail.source")||e.type===(null===(r=s.prevEvent)||void 0===r?void 0:r.type)&&10>Math.abs(Number(e.timeStamp)-Number(null===(i=s.prevEvent)||void 0===i?void 0:i.timeStamp))||a.taro&&["eh"].includes(n))){s.prevEvent=e,a.uniVue&&(n=null==c?void 0:c.gioUniAppAdapter.getHandlerName(n,e)),a.debug&&console.log("Action：",e.type,Date.now()),u.emit("ON_COMPOSE_BEFORE",{event:n,params:null!=e?e:{}});var g=l.listeners.actions;g.click.includes(e.type)?s.buildClickEvent(d,e,n):g.change.includes(e.type)&&s.buildChangeEvent(d,e,n)}},this.getNodeXpath=function(e,t){var n,o,a,l=s.growingIO,c=l.gioPlatform,u=l.vdsConfig,d=(e.currentTarget||e.target).id;return(!d||"swan"===c&&r.test(d)||(o=(n=u.taro).Current,a=n.createComponent,n&&o&&!a&&i.test(d)))&&(d=""),"".concat(d,"#").concat(t)},this.buildClickEvent=function(r,i,o){var a,l,c,u,d=s.getNodeXpath(i,o);if(d){var g=s.growingIO.dataStore,v=g.eventContextBuilder,p=g.eventInterceptor,h=g.eventHooks,f=i.currentTarget||i.target,m=void 0;if(t.has(null==f?void 0:f.dataset,"index")&&""!==(null===(a=null==f?void 0:f.dataset)||void 0===a?void 0:a.index)){var I=t.toString(f.dataset.index);n.test(I)&&I-0>0&&2147483647>I-0?m=+I:(u="".concat(f.dataset.index,"，index标记应为 大于 0 且小于 2147483647 的整数！"),console.log("%c[GrowingIO]：".concat(u),"color: #F59E0B"))}var C=e({eventType:"VIEW_CLICK",element:[{xpath:d,index:m,textValue:null===(l=null==f?void 0:f.dataset)||void 0===l?void 0:l.title,hyperlink:null===(c=null==f?void 0:f.dataset)||void 0===c?void 0:c.src}]},v(r));C.attributes=h.currentPage.eventSetPageProps(r,C),p(C)}},this.buildTabClickEvent=function(n,r){var i=s.growingIO.dataStore,o=i.eventContextBuilder,a=i.eventInterceptor,l=i.eventHooks,c=e({eventType:"VIEW_CLICK",element:[{xpath:"#onTabItemTap",textValue:r.text,index:r.index+1,hyperlink:t.toString(r.pagePath)}]},o(n));c.attributes=l.currentPage.eventSetPageProps(n,c),a(c)},this.buildChangeEvent=function(n,r,i){var o,a,l=s.getNodeXpath(r,i);if(l){var c=s.growingIO.dataStore,u=c.eventContextBuilder,d=c.eventInterceptor,g=c.eventHooks,v=r.currentTarget||r.target,p=e({eventType:"VIEW_CHANGE",element:{xpath:l}},u(n)),h=t.get(r,"detail.value")||t.get(r,"target.attr.value");((null===(o=null==v?void 0:v.dataset)||void 0===o?void 0:o.growingTrack)||(null===(a=null==v?void 0:v.dataset)||void 0===a?void 0:a.growingtrack))&&(t.isNil(h)||(p.element.textValue=t.toString(h))),p.element=[p.element],p.attributes=g.currentPage.eventSetPageProps(n,p),d(p)}},this.listenForLunchEvent=function(){s.growingIO.emitter.on("MINIP_LIFECYCLE",(function(e){var t=e.event,n=e.params;["App onLaunch","App onShow"].includes(t)&&s.circleInit(n)}))},this.circleInit=function(e){var t,n=s.growingIO.emitter,r=l(null===(t=e.referrerInfo)||void 0===t?void 0:t.extraData);(null==r?void 0:r.gdpCircleRoomCollectUrl)&&(s.circleServerUrl!==(null==r?void 0:r.gdpCircleRoomCollectUrl)&&(s.circleServerUrl=null==r?void 0:r.gdpCircleRoomCollectUrl,n.off(c,s.collectorSendFn),n.on(c,s.collectorSendFn),s.showPromptModal("enter")),s.circleOpen=!0)},this.collectorSendFn=function(e){var t,n=e.requestData,r=e.trackingId,i=s.growingIO.uploader;if(s.circleOpen){var l=n.filter((function(e){return"CUSTOM"!==e.eventType&&r===s.growingIO.trackingId}));if(!(function(e){return Array.isArray(e)&&"array"===a(e)}(t=l)?0===t.length:o(t)?0===function(e){return o(e)?Object.keys(e):[]}(t).length:!t))if(i.requestingNum<i.requestLimit)s.circleRequest(l);else var c=setInterval((function(){i.requestingNum<i.requestLimit&&(s.circleRequest(l),clearInterval(c),c=void 0)}),500)}},this.circleClose=function(){s.circleOpen=!1,s.circleServerUrl="",s.growingIO.emitter.off(c,s.collectorSendFn)},this.showPromptModal=function(e,t){s.growingIO.minipInstance.minip.showModal({title:"GrowingIO提示",content:"error"===e?t:"您已进入圈选模式",showCancel:!1})},this.circleRequest=function(e){s.growingIO.minipInstance.request({url:s.circleServerUrl,header:{"content-type":"application/json;charset=UTF-8"},method:"POST",data:e,complete:function(e){var t=e.statusCode,n=e.data,r=e.errMsg;[200,204].includes(t)&&(null==n?void 0:n.success)||(s.showPromptModal("error",(null==n?void 0:n.message)||n||r||"圈选请求失败，请重试!"),s.circleClose())}})},this.pluginVersion="4.4.0",t=this.growingIO.utils,this.prevEvent={},this.listenForLunchEvent()}};export{u as default};
