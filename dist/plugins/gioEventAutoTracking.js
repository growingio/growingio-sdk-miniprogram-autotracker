var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var i in t=arguments[n])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,n=/^\d{1,10}$/,r=/^_[0-9a-z]+/,i=/^_n_[0-9]+$/,o=function(e){return"[object Object]"==={}.toString.call(e)&&!function(e){return["undefined","null"].includes(l(e))}(e)},l=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},a=function(e){try{return e()}catch(e){return}},c="ON_SEND_AFTER",u={},s={}.hasOwnProperty;function g(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function d(e){try{return encodeURIComponent(e)}catch(e){return null}}u.stringify=function(e,t){t=t||"";var n,r,i=[];for(r in"string"!=typeof t&&(t="?"),e)if(s.call(e,r)){if((n=e[r])||null!=n&&!isNaN(n)||(n=""),r=d(r),n=d(n),null===r||null===n)continue;i.push(r+"="+n)}return i.length?t+i.join("&"):""},u.parse=function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,r={};t=n.exec(e);){var i=g(t[1]),o=g(t[2]);null===i||null===o||i in r||(r[i]=o)}return r};var v={name:"gioEventAutoTracking",method:function(s){var g=this;this.growingIO=s,this.circleOpen=!1,this.main=function(e,n){var r,i,o=g.growingIO,l=o.vdsConfig,a=o.platformConfig,c=o.plugins,u=o.emitter,s=o.trackingId;if(!(!l.autotrack||!n||t.get(e,"currentTarget.dataset.growingIgnore")||t.get(e,"target.dataset.growingIgnore")||!t.get(e,"target.dataset.growingTrack")&&"autoplay"===t.get(e,"detail.source")||e.type===(null===(r=g.prevEvent)||void 0===r?void 0:r.type)&&10>Math.abs(Number(e.timeStamp)-Number(null===(i=g.prevEvent)||void 0===i?void 0:i.timeStamp))||l.taro&&["eh"].includes(n))){g.prevEvent=e,l.uniVue&&(n=null==c?void 0:c.gioUniAppAdapter.getHandlerName(n,e)),l.debug&&console.log("Action：",e.type,Date.now()),u.emit("ON_COMPOSE_BEFORE",{event:n,params:null!=e?e:{}});var d=a.listeners.actions;d.click.includes(e.type)?g.buildClickEvent(s,e,n):d.change.includes(e.type)&&g.buildChangeEvent(s,e,n)}},this.getNodeXpath=function(e,t){var n,o,l,a=g.growingIO,c=a.gioPlatform,u=a.vdsConfig,s=(e.currentTarget||e.target).id;return(!s||"swan"===c&&r.test(s)||(o=(n=u.taro).Current,l=n.createComponent,n&&o&&!l&&i.test(s)))&&(s=""),"".concat(s,"#").concat(t)},this.buildClickEvent=function(r,i,o){var l,a,c,u,s=g.getNodeXpath(i,o);if(s){var d=g.growingIO.dataStore,v=d.eventContextBuilder,p=d.eventInterceptor,f=d.eventHooks,h=i.currentTarget||i.target,m=void 0;if(t.has(null==h?void 0:h.dataset,"index")&&""!==(null===(l=null==h?void 0:h.dataset)||void 0===l?void 0:l.index)){var I=t.toString(h.dataset.index);n.test(I)&&I-0>0&&2147483647>I-0?m=+I:(u="".concat(h.dataset.index,"，index标记应为 大于 0 且小于 2147483647 的整数！"),console.log("%c[GrowingIO]：".concat(u),"color: #F59E0B"))}var C=e({eventType:"VIEW_CLICK",element:[{xpath:s,index:m,textValue:null===(a=null==h?void 0:h.dataset)||void 0===a?void 0:a.title,hyperlink:null===(c=null==h?void 0:h.dataset)||void 0===c?void 0:c.src}]},v(r));C.attributes=f.currentPage.eventSetPageProps(r,C),p(C)}},this.buildTabClickEvent=function(n,r){var i=g.growingIO.dataStore,o=i.eventContextBuilder,l=i.eventInterceptor,a=i.eventHooks,c=e({eventType:"VIEW_CLICK",element:[{xpath:"#onTabItemTap",textValue:r.text,index:r.index+1,hyperlink:t.toString(r.pagePath)}]},o(n));c.attributes=a.currentPage.eventSetPageProps(n,c),l(c)},this.buildChangeEvent=function(n,r,i){var o,l,a=g.getNodeXpath(r,i);if(a){var c=g.growingIO.dataStore,u=c.eventContextBuilder,s=c.eventInterceptor,d=c.eventHooks,v=r.currentTarget||r.target,p=e({eventType:"VIEW_CHANGE",element:{xpath:a}},u(n)),f=t.get(r,"detail.value")||t.get(r,"target.attr.value");((null===(o=null==v?void 0:v.dataset)||void 0===o?void 0:o.growingTrack)||(null===(l=null==v?void 0:v.dataset)||void 0===l?void 0:l.growingtrack))&&(t.isNil(f)||(p.element.textValue=t.toString(f))),p.element=[p.element],p.attributes=d.currentPage.eventSetPageProps(n,p),s(p)}},this.listenForLunchEvent=function(){g.growingIO.emitter.on("MINIP_LIFECYCLE",(function(e){var t=e.event,n=e.params;["App onLaunch","App onShow"].includes(t)&&g.circleInit(n)}))},this.getCircleUrlByTT=function(e){var t,n=e.query;if(n.q&&n.url){var r=a((function(){var e;return null===(e=JSON.parse(n.q))||void 0===e?void 0:e.gdpCircleRoomCollectUrl}));return r||(null!==(t=a((function(){var e;return null===(e=u.parse(n.url.split("?")[1]))||void 0===e?void 0:e.gdpCircleRoomCollectUrl})))&&void 0!==t?t:"")}},this.circleInit=function(e){var t,n=g.growingIO.emitter,r=function(e){var t;return"string"===l(e)?null!==(t=a((function(){return JSON.parse(e)})))&&void 0!==t?t:{}:null!=e?e:{}}((null===(t=e.referrerInfo)||void 0===t?void 0:t.extraData)||e.query||{}),i=(null==r?void 0:r.gdpCircleRoomCollectUrl)||g.getCircleUrlByTT(e);i&&(g.circleServerUrl!==i&&(g.circleServerUrl=i,n.off(c,g.collectorSendFn),n.on(c,g.collectorSendFn),g.showPromptModal("enter")),g.circleOpen=!0)},this.collectorSendFn=function(e){var t,n=e.requestData,r=e.trackingId,i=g.growingIO.uploader;if(g.circleOpen){var a=n.filter((function(e){return"CUSTOM"!==e.eventType&&r===g.growingIO.trackingId}));if(!(function(e){return Array.isArray(e)&&"array"===l(e)}(t=a)?0===t.length:o(t)?0===function(e){return o(e)?Object.keys(e):[]}(t).length:!t))if(i.requestingNum<i.requestLimit)g.circleRequest(a);else var c=setInterval((function(){i.requestingNum<i.requestLimit&&(g.circleRequest(a),clearInterval(c),c=void 0)}),500)}},this.circleClose=function(){g.circleOpen=!1,g.circleServerUrl="",g.growingIO.emitter.off(c,g.collectorSendFn)},this.showPromptModal=function(e,t){g.growingIO.minipInstance.minip.showModal({title:"GrowingIO提示",content:"error"===e?t:"您已进入圈选模式",showCancel:!1})},this.circleRequest=function(e){g.growingIO.minipInstance.request({url:g.circleServerUrl,header:{"content-type":"application/json;charset=UTF-8"},method:"POST",data:e,complete:function(e){var t=e.statusCode,n=e.data,r=e.errMsg;[200,204].includes(t)&&(null==n?void 0:n.success)||(g.showPromptModal("error",(null==n?void 0:n.message)||n||r||"圈选请求失败，请重试!"),g.circleClose())}}),console.log(e,"-----\x3ecircleRequest")},this.pluginVersion="4.4.2",t=this.growingIO.utils,this.prevEvent={},this.listenForLunchEvent()}};export{v as default};
