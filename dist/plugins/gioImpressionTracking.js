var e,t=function(){return t=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},t.apply(this,arguments)},r=function(e){return"[object Object]"==={}.toString.call(e)&&!function(e){return["undefined","null"].includes(i(e))}(e)},n=function(e){return Array.isArray(e)&&"array"===i(e)},i=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},o=function(e){var t,i=0;if((n(t=e)?0===t.length:r(t)?0===function(e){return r(e)?Object.keys(e):[]}(t).length:!t)||"boolean"==typeof e)return i;for(var o=0;o<e.length;)i=(i<<5)-i+e.charCodeAt(o),i&=i,o++;return i},s={name:"gioImpressionTracking",method:function(r){var i=this;this.growingIO=r,this.traverseListen=function(t){var r=i.growingIO.minipInstance;if(e.isFunction(null==t?void 0:t.selectAllComponents)){var n=null==t?void 0:t.selectAllComponents(".growing_collect_imp_component");e.isEmpty(n)||n.forEach((function(e){i.traverseListen(e)}))}r.initImpression(t)},this.isEqualRects=function(e,t,r){var s,a,c,u,l=(null!==(a=(null!==(s=i.rects[t])&&void 0!==s?s:{})[r])&&void 0!==a?a:[]).map((function(e){return o(JSON.stringify(e))})),v=(null!=e?e:[]).map((function(e){return o(JSON.stringify(e))}));return u=v,!(!n(c=l)||!n(u)||c.length!==u.length)&&c.every((function(e,t){return e===u[t]}))},this.rectobserve=function(t,r,n){var o=r.__wxExparserNodeId__,s=r.route?r:i.growingIO.minipInstance.getCurrentPage(),a=!1;if(s.route){var c=i.isEqualRects(t,s.route,o),u=e.get(i.observerIds,s.route+"."+o+"._disconnected");a=!c||!1!==u}e.isArray(t)&&!e.isEmpty(t)&&!e.isNil(t[0])&&a&&(e.isEmpty(i.rects[s.route])&&(i.rects[s.route]={}),i.rects[s.route][o]=t,i.creatObserver(r,n))},this.main=function(t,r){var n,o,s=i.growingIO.gioPlatform,a=t.route?null===(n=i.growingIO.minipInstance.minip)||void 0===n?void 0:n.createSelectorQuery():null===(o=i.growingIO.minipInstance.minip)||void 0===o?void 0:o.createSelectorQuery().in(t);["ks","qq"].includes(s)?(a.selectAll(".growing_collect_imp").boundingClientRect((function(n){var o=n[0];o=e.isNil(o)||e.isArray(o)?o:[o],i.rectobserve(o,t,r)})),a.exec()):(a.selectAll(".growing_collect_imp").boundingClientRect(),a.exec((function(e){var n=e[0];i.rectobserve(n,t,r)})))},this.creatObserver=function(t,r){var n,o,s=i.growingIO,a=s.gioPlatform,c=s.minipInstance,u=((n={})[r]=!0,n);["tb","my"].includes(a)&&e.compareVersion(my.SDKVersion,"2.7.0")>=-1&&(u.dataset=!0);var l=t.__wxExparserNodeId__,v=t;!t.isComponent&&t.route&&"component"!==t.mpType||(v=c.getCurrentPage()),i.observerIds[v.route]||(i.observerIds[v.route]={});var g=i.observerIds[v.route][l];g&&!g._disconnected&&g.disconnect();var p="jd"===a?null===(o=c.minip)||void 0===o?void 0:o.createIntersectionObserver(t,u):t.createIntersectionObserver(u);p=p.relativeToViewport(),i.observerIds[v.route][l]=p,i.targetObserve(p,v)},this.targetObserve=function(t,r){var n=i.growingIO.vdsConfig.taro;t.observe(".growing_collect_imp",(function(t){if(!e.isEmpty(t)&&t.intersectionRatio>0){var o=t.dataset;n&&e.isTaro3(n)&&(o=i.getTaro3Dataset(r.route,t.id));var s=i.getImpressionProperties(o),a=t.id;if(a){if("once"===o.gioImpType&&e.has(i.sentImps,a))return;i.sentImps[a]=s}s.eventId?i.buildImpEvent(s):e.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}}))},this.getImpressionProperties=function(t){var r={eventId:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return r;if(r.eventId=t.gioImpTrack,e.has(t,"gioImpAttrs"))r.properties=e.niceTry((function(){return e.isObject(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs)}));else{var n=/^gioTrack(.+)/;for(var i in t){var o=void 0,s=i.match(n);s&&"track"!==(o=e.lowerFirst(s[1]))&&(r.properties[o]=t[i])}}return r.properties=e.limitObject(r.properties),/^\w+$/.test(r.eventId)&&!Number.isInteger(Number.parseInt(e.head(r.eventId.split("")),10))||(r.eventId=null,r={}),r},this.getTaro3Dataset=function(t,r){var n,o=null===(n=i.growingIO)||void 0===n?void 0:n.taro3VMs[t];if(!o)return!1;var s={},a=function(t){t.some((function(t){var n;return t.uid!==r&&t.sid!==r||-1>=(null===(n=t.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))||e.isEmpty(t.dataset)?!!Array.isArray(t.childNodes)&&a(t.childNodes):(s=t.dataset,!0)}))};return a(o.childNodes),s},this.buildImpEvent=function(e){var r=e.eventId,n=e.properties,o=i.growingIO.dataStore,s=o.eventContextBuilder;(0,o.eventInterceptor)(t(t({eventType:"CUSTOM",eventName:r,attributes:n},s()),{customEventType:0}))},e=this.growingIO.utils,this.observerIds={},this.rects={},this.sentImps={};var s=this.growingIO,a=s.emitter,c=s.minipInstance;this.growingIO.updateImpression=function(e){e||(e=c.getCurrentPage()),c.initImpression(e)},a.on("minipLifecycle",(function(e){var t,r=e.event,n=e.params,o=i.growingIO.minipInstance;if("Page onShowEnd"===r){var s=o.getCurrentPage();i.traverseListen(s)}if(["Page onHide","Page onUnload"].includes(r)){var a=n.page.route;Object.values(null!==(t=i.observerIds[a])&&void 0!==t?t:{}).forEach((function(e){return e.disconnect()}))}}))}};export default s;
