var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,r=/^gioTrack(.+)/,n=/^[a-zA-Z_][0-9a-zA-Z_]{0,100}$/,i=function(e){return["undefined","null"].includes(p(e))},o=function(e){return"string"===p(e)},s=function(e){return"[object Object]"==={}.toString.call(e)&&!i(e)},c=function(e){return Array.isArray(e)&&"array"===p(e)},a=function(e,t){if(void 0===t&&(t=!1),c(e)){for(var r=0,n=[],i=0,o=e;i<o.length;i++){var s=o[i];s&&!d(s)&&(n[r++]=s),t&&0===s&&(n[r++]=s)}return n}return e},u=function(e){return i(e)?"":"".concat(e)},l=function(e){return s(e)?Object.keys(e):[]},g=function(e,t){if(!s(e))return!1;try{if("string"===p(t))return delete e[t];if("array"===p(t))return t.map((function(t){return delete e[t]}));"object"===p(t)&&t.constructor===RegExp&&l(e).forEach((function(r){t.test(r)&&g(e,r)}))}catch(e){return!1}},d=function(e){return c(e)?0===e.length:s(e)?0===l(e).length:!e},p=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},v=function(e){try{return e()}catch(e){return}},f=function(e){var t={};return s(e)&&(g(e,"&&sendTo"),function(e,r){l(e).forEach((function(r){return function(e,r){var n=u(r).slice(0,100);s(e)?t[n]=f(e):c(e)?(t[n]=a(e.slice(0,100),!0),t[n]=t[n].join("||").slice(0,1e3)):function(e){return"date"===p(e)}(e)?t[n]=function(e){function t(e){return 10>e?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}(e):t[n]=i(e)?"":u(e).slice(0,1e3)}(e[r],r)}))}(e)),t},m=function(e,t){void 0===t&&(t=!1);var r=0;if(d(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r|=0,n++;return t?Math.abs(r):r},I={name:"gioImpressionTracking",method:function(i){var l=this;this.growingIO=i,this.traverseListen=function(e){var r=l.growingIO.minipInstance;if(t.isFunction(null==e?void 0:e.selectAllComponents)){var n=null==e?void 0:e.selectAllComponents(".growing_collect_imp_component");t.isEmpty(n)||n.forEach((function(e){l.traverseListen(e)}))}r.initImpression(e)},this.isEqualRects=function(e,t,r){var n,i,o,s,a=(null!==(i=(null!==(n=l.rects[t])&&void 0!==n?n:{})[r])&&void 0!==i?i:[]).map((function(e){return m(JSON.stringify(e))})),u=(null!=e?e:[]).map((function(e){return m(JSON.stringify(e))}));return s=u,!(!c(o=a)||!c(s)||o.length!==s.length)&&o.every((function(e,t){return e===s[t]}))},this.getNodeId=function(e){switch(l.growingIO.gioPlatform){case"wx":case"qq":case"ks":case"jd":return e.__wxExparserNodeId__;case"my":case"tb":return e.$page?"".concat(e.$page.$id,"-").concat(e.$id):e.$id;case"swan":return e.route?u(m(e.route)):e.nodeId;case"tt":return e.route?u(m(e.route)):e.__nodeId__}},this.rectobserve=function(e,r,n){var i=l.growingIO.gioPlatform;if("tt"===i&&r.__nodeId__||"ks"===i&&r.is)return!1;var o=l.getNodeId(r),s=r.route?r:l.growingIO.minipInstance.getCurrentPage(),c=!1;if(s.route){var a=l.isEqualRects(e,s.route,o),u=t.get(l.observerIds,"".concat(s.route,".").concat(o,"._disconnected"));c=!a||!1!==u}t.isArray(e)&&!t.isEmpty(e)&&!t.isNil(e[0])&&c&&(t.isEmpty(l.rects[s.route])&&(l.rects[s.route]={}),l.rects[s.route][o]=e,l.creatObserver(r,n))},this.main=function(e,r){var n,i,o=l.growingIO.gioPlatform,s=e.route?null===(n=l.growingIO.minipInstance.minip)||void 0===n?void 0:n.createSelectorQuery():null===(i=l.growingIO.minipInstance.minip)||void 0===i?void 0:i.createSelectorQuery().in(e);["ks","qq"].includes(o)?(s.selectAll(".growing_collect_imp").boundingClientRect((function(n){var i=n[0],o=void 0===i?[]:i;o=t.isArray(o)?o:[o],d(o)||l.rectobserve(o,e,r)})),s.exec()):(s.selectAll(".growing_collect_imp").boundingClientRect(),s.exec((function(t){var n=t[0];d(n)||l.rectobserve(n,e,r)})))},this.creatObserver=function(e,r){var n,i,o=l.growingIO,s=o.gioPlatform,c=o.minipInstance,a=((n={})[r]=!0,n);["tb","my"].includes(s)&&t.compareVersion(my.SDKVersion,"2.7.0")>=-1&&(a.dataset=!0);var u=l.getNodeId(e),g=e;!e.isComponent&&e.route&&"component"!==e.mpType||(g=c.getCurrentPage()),l.observerIds[g.route]||(l.observerIds[g.route]={});var d=l.observerIds[g.route][u];d&&!d._disconnected&&d.disconnect();var p=["swan","jd"].includes(s)?null===(i=c.minip)||void 0===i?void 0:i.createIntersectionObserver(e,a):e.createIntersectionObserver(a);p=p.relativeToViewport(),l.observerIds[g.route][u]=p,l.targetObserve(p,g)},this.targetObserve=function(e,r){var n=l.growingIO.vdsConfig.taro;e.observe(".growing_collect_imp",(function(e){if(!t.isEmpty(e)&&e.intersectionRatio>0){var i=e.dataset;n&&t.isTaro3(n)&&(i=l.getTaro3Dataset(r.route,e.id));var s=l.getImpressionProperties(i),u=e.id;if(u){if("once"===i.gioImpType&&t.has(l.sentImps,u))return;l.sentImps[u]=s}if(s.eventName){var g=[];i.gioImpSendto&&(g=a(c(i.gioImpSendto)?i.gioImpSendto:v((function(){return JSON.parse(i.gioImpSendto)}))||[]),d(g)&&v((function(){return i.gioImpSendto.split(",").forEach((function(e){(e=o(e)&&e.trim().replace("[","").replace("]",""))&&g.push(e)}))}))),l.buildImpEvent(s,g)}else t.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}}))},this.getImpressionProperties=function(e){var i,s,c={eventName:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return c;if(c.eventName=e.gioImpTrack,t.has(e,"gioImpAttrs"))c.properties=t.niceTry((function(){return t.isObject(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs)}));else for(var a in e){var u=void 0,l=a.match(r);l&&"track"!==(u=t.lowerFirst(l[1]))&&(c.properties[u]=e[a])}return c.properties=t.limitObject(c.properties),i=c.eventName,s=function(){return c},(o(i)&&!d(i)&&i.match(n)?s():(console.log("%c[GrowingIO]：事件名格式不正确，只能包含数字、字母和下划线，且不能以数字开头，字符总长度不能超过100!","color: #EF4444"),!1))||(c.eventName=null,c={}),c},this.getTaro3Dataset=function(e,r){var n,i=null===(n=l.growingIO)||void 0===n?void 0:n.taro3VMs[e];if(!i)return!1;var o={},s=function(e){e.some((function(e){var n;return e.uid!==r&&e.sid!==r||-1>=(null===(n=e.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))||t.isEmpty(e.dataset)?!!Array.isArray(e.childNodes)&&s(e.childNodes):(o=e.dataset,!0)}))};return s(i.childNodes),o},this.buildImpEvent=function(t,r){var n,i=t.eventName,o=t.properties,c=l.growingIO,a=c.trackingId,u=c.dataStore,g=u.eventContextBuilder,p=u.eventConverter,v=c.plugins,m=e({eventType:"CUSTOM",eventName:i},g(a));m.attributes=f(e(e({},null!==(n=m.attributes)&&void 0!==n?n:{}),s(o)&&!d(o)?o:{})),v.gioMultipleInstances&&!d(r)&&(m["&&sendTo"]=r),p(m)},this.pluginVersion="4.3.0",t=this.growingIO.utils,this.observerIds={},this.rects={},this.sentImps={};var g=this.growingIO,p=g.emitter,I=g.minipInstance;this.growingIO.updateImpression=function(e){e||(e=I.getCurrentPage()),I.initImpression(e)},p.on("MINIP_LIFECYCLE",(function(e){var t,r=e.event,n=e.params,i=l.growingIO.minipInstance;if("Page onShowEnd"===r){var o=i.getCurrentPage();l.traverseListen(o)}if(["Page onHide","Page onUnload"].includes(r)){var s=n.page.route;Object.values(null!==(t=l.observerIds[s])&&void 0!==t?t:{}).forEach((function(e){return e.disconnect()}))}}))}};export{I as default};
