var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,r=/^gioTrack(.+)/,n=/^[a-zA-Z_][0-9a-zA-Z_]{0,100}$/,i=function(e){return["undefined","null"].includes(l(e))},o=function(e){return"string"===l(e)},s=function(e){return"[object Object]"==={}.toString.call(e)&&!i(e)},a=function(e){return Array.isArray(e)&&"array"===l(e)},c=function(e){return i(e)?"":"".concat(e)},u=function(e){return a(e)?0===e.length:s(e)?0===function(e){return s(e)?Object.keys(e):[]}(e).length:!e},l=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},g=function(e){try{return e()}catch(e){return}},d=function(e,t){void 0===t&&(t=!1);var r=0;if(u(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r|=0,n++;return t?Math.abs(r):r},p={name:"gioImpressionTracking",method:function(i){var s=this;this.growingIO=i,this.traverseListen=function(e){var r=s.growingIO.minipInstance;if(t.isFunction(null==e?void 0:e.selectAllComponents)){var n=null==e?void 0:e.selectAllComponents(".growing_collect_imp_component");t.isEmpty(n)||n.forEach((function(e){s.traverseListen(e)}))}r.initImpression(e)},this.isEqualRects=function(e,t,r){var n,i,o,c,u=(null!==(i=(null!==(n=s.rects[t])&&void 0!==n?n:{})[r])&&void 0!==i?i:[]).map((function(e){return d(JSON.stringify(e))})),l=(null!=e?e:[]).map((function(e){return d(JSON.stringify(e))}));return c=l,!(!a(o=u)||!a(c)||o.length!==c.length)&&o.every((function(e,t){return e===c[t]}))},this.getNodeId=function(e){switch(s.growingIO.gioPlatform){case"wx":case"qq":case"ks":case"jd":return e.__wxExparserNodeId__;case"my":case"tb":return e.$page?"".concat(e.$page.$id,"-").concat(e.$id):e.$id;case"swan":return e.route?c(d(e.route)):e.nodeId;case"tt":return e.route?c(d(e.route)):e.__nodeId__}},this.rectobserve=function(e,r,n){var i=s.growingIO.gioPlatform;if("tt"===i&&r.__nodeId__||"ks"===i&&r.is)return!1;var o=s.getNodeId(r),a=r.route?r:s.growingIO.minipInstance.getCurrentPage(),c=!1;if(a.route){var u=s.isEqualRects(e,a.route,o),l=t.get(s.observerIds,"".concat(a.route,".").concat(o,"._disconnected"));c=!u||!1!==l}t.isArray(e)&&!t.isEmpty(e)&&!t.isNil(e[0])&&c&&(t.isEmpty(s.rects[a.route])&&(s.rects[a.route]={}),s.rects[a.route][o]=e,s.creatObserver(r,n))},this.main=function(e,r){var n,i,o=s.growingIO.gioPlatform,a=e.route?null===(n=s.growingIO.minipInstance.minip)||void 0===n?void 0:n.createSelectorQuery():null===(i=s.growingIO.minipInstance.minip)||void 0===i?void 0:i.createSelectorQuery().in(e);["ks","qq"].includes(o)?(a.selectAll(".growing_collect_imp").boundingClientRect((function(n){var i=n[0],o=void 0===i?[]:i;o=t.isArray(o)?o:[o],u(o)||s.rectobserve(o,e,r)})),a.exec()):(a.selectAll(".growing_collect_imp").boundingClientRect(),a.exec((function(t){var n=t[0];u(n)||s.rectobserve(n,e,r)})))},this.creatObserver=function(e,r){var n,i,o=s.growingIO,a=o.gioPlatform,c=o.minipInstance,u=((n={})[r]=!0,n);["tb","my"].includes(a)&&t.compareVersion(my.SDKVersion,"2.7.0")>=-1&&(u.dataset=!0);var l=s.getNodeId(e),g=e;!e.isComponent&&e.route&&"component"!==e.mpType||(g=c.getCurrentPage()),s.observerIds[g.route]||(s.observerIds[g.route]={});var d=s.observerIds[g.route][l];d&&!d._disconnected&&d.disconnect();var p=["swan","jd"].includes(a)?null===(i=c.minip)||void 0===i?void 0:i.createIntersectionObserver(e,u):e.createIntersectionObserver(u);p=p.relativeToViewport(),s.observerIds[g.route][l]=p,s.targetObserve(p,g)},this.targetObserve=function(e,r){var n=s.growingIO.vdsConfig.taro;e.observe(".growing_collect_imp",(function(e){if(!t.isEmpty(e)&&e.intersectionRatio>0){var i=e.dataset;n&&t.isTaro3(n)&&(i=s.getTaro3Dataset(r.route,e.id));var c=s.getImpressionProperties(i),l=e.id;if(l){if("once"===i.gioImpType&&t.has(s.sentImps,l))return;s.sentImps[l]=c}if(c.eventName){var d=[];i.gioImpSendto&&(d=function(e,t){if(void 0===t&&(t=!1),a(e)){for(var r=0,n=[],i=0,o=e;i<o.length;i++){var s=o[i];s&&!u(s)&&(n[r++]=s),t&&0===s&&(n[r++]=s)}return n}return e}(a(i.gioImpSendto)?i.gioImpSendto:g((function(){return JSON.parse(i.gioImpSendto)}))||[]),u(d)&&g((function(){return i.gioImpSendto.split(",").forEach((function(e){(e=o(e)&&e.trim().replace("[","").replace("]",""))&&d.push(e)}))}))),s.buildImpEvent(c,d)}else t.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}}))},this.getImpressionProperties=function(e){var i,s,a={eventName:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return a;if(a.eventName=e.gioImpTrack,t.has(e,"gioImpAttrs"))a.properties=t.niceTry((function(){return t.isObject(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs)}));else for(var c in e){var l=void 0,g=c.match(r);g&&"track"!==(l=t.lowerFirst(g[1]))&&(a.properties[l]=e[c])}return a.properties=t.limitObject(a.properties),i=a.eventName,s=function(){return a},(o(i)&&!u(i)&&i.match(n)?s():(console.log("%c[GrowingIO]：事件名格式不正确，只能包含数字、字母和下划线，且不能以数字开头，字符总长度不能超过100!","color: #EF4444"),!1))||(a.eventName=null,a={}),a},this.getTaro3Dataset=function(e,r){var n,i=null===(n=s.growingIO)||void 0===n?void 0:n.taro3VMs[e];if(!i)return!1;var o={},a=function(e){e.some((function(e){var n;return e.uid!==r&&e.sid!==r||-1>=(null===(n=e.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))||t.isEmpty(e.dataset)?!!Array.isArray(e.childNodes)&&a(e.childNodes):(o=e.dataset,!0)}))};return a(i.childNodes),o},this.buildImpEvent=function(t,r){var n=t.eventName,i=t.properties,o=s.growingIO,a=o.trackingId,c=o.dataStore,l=c.eventContextBuilder,g=c.eventConverter,d=o.plugins,p=e({eventType:"CUSTOM",eventName:n,attributes:i},l(a));d.gioMultipleInstances&&!u(r)&&(p["&&sendTo"]=r),g(p)},t=this.growingIO.utils,this.observerIds={},this.rects={},this.sentImps={};var l=this.growingIO,p=l.emitter,v=l.minipInstance;this.growingIO.updateImpression=function(e){e||(e=v.getCurrentPage()),v.initImpression(e)},p.on("MINIP_LIFECYCLE",(function(e){var t,r=e.event,n=e.params,i=s.growingIO.minipInstance;if("Page onShowEnd"===r){var o=i.getCurrentPage();s.traverseListen(o)}if(["Page onHide","Page onUnload"].includes(r)){var a=n.page.route;Object.values(null!==(t=s.observerIds[a])&&void 0!==t?t:{}).forEach((function(e){return e.disconnect()}))}}))}};export{p as default};
