const e={autotrack:{type:"boolean",default:!0},cml:{type:"object",default:!1},comAsPage:{type:"boolean",default:!1},dataCollect:{type:"boolean",default:!0},debug:{type:"boolean",default:!1},followShare:{type:"boolean",default:!0},forceLogin:{type:"boolean",default:!1},subpackage:{type:"boolean",default:!1},keepAlive:{type:"number",default:3e5},remax:{type:"object",default:!1},taro:{type:"object",default:!1},taroVue:{type:["object","function"],default:!1},tbConfig:{type:"object",default:{cloudFuncSend:!1,cloudFuncName:"httpTunnel",cloudFuncHandler:"main",cloudAppId:void 0,path:void 0}},uniVue:{type:["object","function"],default:!1},version:{type:"string",default:"1.0.0"},wepy:{type:"function",default:!1}},t={compress:{type:"boolean",default:!0},enableIdMapping:{type:"boolean",default:!1},extraParams:{type:"array",default:[]},gtouchHost:{type:"string",default:""},host:{type:"string",default:""},ignoreFields:{type:"array",default:[]},scheme:{type:"string",default:"https"},uploadInterval:{type:"number",default:1e3}},i={},s=["clearUserId","enableDebug","getGioInfo","getOption","identify","init","setAutotrack","setDataCollect","setOption","setUserId","track","setLocation","setGeneralProps","clearGeneralProps","setTrackerHost","setTrackerScheme","setUserAttributes","registerPlugins","getDeviceId"],n=["autotrack","dataCollect","debug","host","scheme"],o={autotrack:"无埋点",dataCollect:"数据采集",debug:"调试模式"},r=["setConfig","collectImp","setPlatformProfile","getLocation"],a=["deviceBrand","deviceModel","deviceType","networkState","screenHeight","screenWidth","operatingSystem"],l=[...a,"appChannel","language","platformVersion"],g=e=>null==e||void 0===e,u=e=>"string"==typeof e,h=e=>"number"==typeof e,d=e=>"boolean"==typeof e,c=e=>"[object Object]"==={}.toString.call(e)&&!g(e),p=e=>"function"==typeof e,m=e=>Array.isArray(e)&&"[object Array]"==={}.toString.call(e),v=e=>{try{return Array.from(e)[0]}catch(e){return}},f=e=>{try{const t=Array.from(e);return t[t.length-1]}catch(e){return}},I=(e,t=1)=>m(e)&&h(t)?e.slice(t>0?t:1,e.length):e,S=e=>{if(m(e)){let t=0;const i=[];for(const s of e)s&&!x(s)&&(i[t++]=s);return i}return e},y=e=>g(e)?"":""+e,O=(e,t)=>"string"==typeof e?e.split(t):e,w=e=>{if(u(e)){const t=O(e,"");return`${v(t).toLowerCase()}${I(t).join("")}`}return e},b=(e,t)=>e.slice(0,t.length)===t,E=(e,t)=>{const{length:i}=e;let s=i;s>i&&(s=i);const n=s;return s-=t.length,s>=0&&e.slice(s,n)===t},C={}.hasOwnProperty,P=(e,t)=>!g(e)&&C.call(e,t),A=e=>"object"===j(e)?Object.keys(e):[],_=(e,t)=>{A(e).forEach((i=>t(e[i],i)))},T=(e,t)=>{const i=A(e);return!(!c(e)||!c(t)||i.length!==A(t).length||i.map(((i,s)=>c(e[i])?T(e[i],t[i]):e[i]===t[i])).includes(!1))},k=(e,t,i)=>{let s=e;return c(e)?(t.split(".").forEach((e=>{s=s?s[e]:i})),s):i},N=(e,t)=>{if(!c(e))return!1;try{if("string"===j(t))return delete e[t];if("array"===j(t))return t.map((t=>delete e[t]));"object"===j(t)&&t.constructor===RegExp&&A(e).forEach((i=>{t.test(i)&&N(e,i)}))}catch(e){return!1}},q=(e,t=250,i,s)=>{let n,o=0;return"boolean"!=typeof i&&(s=e,e=i,i=void 0),function(...r){let a=this,l=Date.now()-o;function g(){o=Date.now(),e.apply(a,r)}s&&!n&&g(),n&&clearTimeout(n),void 0===s&&l>t?g():!0!==i&&(n=setTimeout(s?function(){n=void 0}:g,void 0===s?t-l:t))}},x=e=>m(e)?0===e.length:c(e)?0===A(e).length:!e,j=e=>{const t=typeof e;return"object"===t?null===e?"null":m(e)?"array":t:t};var F=Object.freeze({__proto__:null,isNil:g,isString:u,isNumber:h,isBoolean:d,isObject:c,isFunction:p,isArray:m,isDate:e=>"[object Date]"==={}.toString.call(e),fixed:(e,t)=>h(e)?Number(e.toFixed(h(t)?t:2)):u(e)&&"NaN"!==y(Number(e))?Number(Number(e).toFixed(h(t)?t:2)):e,head:v,last:f,drop:I,dropWhile:(e,t)=>m(e)?e.filter((e=>!t(e))):e,compact:S,find:(e,t)=>{if(m(e)){const i=e.findIndex(t);return 0>i?void 0:e[i]}},toString:y,split:O,lowerFirst:w,upperFirst:e=>{if(u(e)){const t=O(e,"");return`${v(t).toUpperCase()}${I(t).join("")}`}return e},startsWith:b,endsWith:E,hasOwnProperty:C,has:P,keys:A,forEach:_,isEqual:T,get:k,unset:N,throttle:q,isEmpty:x,typeOf:j,formatDate:e=>{function t(e){return 10>e?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}});const L=(e,t)=>{console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},D=e=>{try{return e()}catch(e){return}},H=e=>{const t={};return c(e)&&_(e,((e,i)=>{const s=y(i).slice(0,50);c(e)?t[s]=H(e):m(e)?(t[s]=e.slice(0,100),"cdp"===(global||$global).gioEnvironment?t[s]=t[s].join("||"):t[s]=y(t[s])):t[s]=g(e)?"":y(e).slice(0,1e3)})),t},R=e=>u(e)?e.trim().substring(0,100):e;var U=Object.freeze({__proto__:null,consoleText:L,niceTry:D,limitObject:H,limitString:R});const B=e=>u(e)&&e.length>0||h(e)&&e>0,$=e=>!e.vdsConfig&&!e.gioSDKInitialized||(L("SDK重复初始化，请检查是否重复加载SDK或接入其他平台SDK导致冲突!","warn"),!1),K=e=>!!S(e)||(L('SDK初始化失败，请使用 gdp("init", "您的GrowingIO项目 accountId", "您项目的 dataSourceId", "你的应用 AppId", options); 进行初始化!',"error"),!1),G=e=>{const t=e[0];let i=f(e);return B(t)?(c(i)&&i||(i={}),{projectId:t,userOptions:i}):(L("SDK初始化失败，accountId 参数不合法!","error"),!1)},V=e=>{const t=e[1];let i=e[2];const s=f(e);return t&&u(t)?(i=(e=>(B(e)||(e="",L("检测到应用 AppId 未填写或不合法，将自动为您获取!")),e))(i),c(s)&&s.host?{dataSourceId:t,appId:i,cdpOptions:s}:(L("SDK初始化失败，未在配置中指定 host!","error"),!1)):(L("SDK初始化失败，dataSourceId 参数不合法!","error"),!1)},Q=/^((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})){3}/i,M=/^(https?:\/\/)|(([a-zA-Z0-9_-])+(\.)?)*(:\d+)?(\/((\.)?(\?)?=?&?[a-zA-Z0-9_-](\?)?)*)*$/i;let W;var z={name:"gioTaobaoSendAdapter",method:class{constructor(e){this.growingIO=e,this.singleInvoke=()=>{const{vdsConfig:e,emitter:t,uploader:i}=this.growingIO,s=[...i.hoardingQueue,...i.requestQueue].filter((e=>(i.retryIds[e.globalSequenceId||e.esid]||0)<i.retryLimit));if(W.isEmpty(s))return;let n=s.shift();e.debug&&console.log("[GrowingIO Debug]:",JSON.stringify(n,null,2)),t.emit("onSendBefore",{requestData:n}),this.cloudFuncInvoke(n)},this.cloudFuncInvoke=e=>{var t,i;const{vdsConfig:s,emitter:n,uploader:o}=this.growingIO;let r;try{r=getApp()}catch(e){r=$global}if(r||(r=$global),null===(i=null===(t=null==r?void 0:r.cloud)||void 0===t?void 0:t.function)||void 0===i?void 0:i.invoke){const{host:t,projectId:i,tbConfig:a}=s;o.requestingNum+=1,null==r||r.cloud.function.invoke(a.cloudFuncName,{domain:t,path:`/v3/projects/${i}/collect`,params:{stm:Date.now()},body:e},a.cloudFuncHandler).then((t=>{o.requestingNum-=1,t.success?n.emit("onSendAfter",{result:t}):(o.requestFailFn(e),W.consoleText("请求失败! "+JSON.stringify(t),"error")),o.initiateRequest()})).catch((t=>{o.requestingNum-=1,o.requestFailFn(e),W.consoleText("请求失败! "+JSON.stringify(t),"error"),o.initiateRequest()}))}else W.consoleText("请求失败!当前应用不支持淘宝云函数!","error")},W=this.growingIO.utils}tbCloudAppInvoke(e){var t,i;const{vdsConfig:s,emitter:n,uploader:o}=this.growingIO;let r;try{r=getApp()}catch(e){r=$global}if(r||(r=$global),null===(i=null===(t=null==r?void 0:r.cloud)||void 0===t?void 0:t.application)||void 0===i?void 0:i.httpRequest){const{host:t,projectId:i,tbConfig:a}=s;o.requestingNum+=1,r.cloud.application.httpRequest({path:a.path,method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"},params:{host:t,projectId:i,stm:Date.now()},body:e,exts:{cloudAppId:a.cloudAppId}}).then((t=>{o.requestingNum-=1,t.success?n.emit("onSendAfter",{result:t}):(W.isArray(e)?e.forEach((e=>{o.requestFailFn(e)})):o.requestFailFn(e),W.consoleText("请求失败! "+JSON.stringify(t),"error")),o.initiateRequest()})).catch((t=>{o.requestingNum-=1,W.isArray(e)?e.forEach((e=>{o.requestFailFn(e)})):o.requestFailFn(e),W.consoleText("请求失败! "+JSON.stringify(t),"error"),o.initiateRequest()}))}else W.consoleText("请求失败!当前应用不支持淘宝云应用!","error")}}};let J;const Z={};function Y(e,t,i){var s=e;t.map((function(e,n){s[e]=n==t.length-1?i:s[e]||{},s=s[e]}))}Y(Z,["plugins","gioCustomTracking"],{name:"gioCustomTracking",method:class{constructor(e){this.growingIO=e,this.getValidResourceItem=e=>{if(e&&J.isObject(e)&&e.id&&e.key){const t={id:J.isString(e.id)?e.id:J.toString(e.id),key:J.isString(e.key)?e.key:J.toString(e.key)};return e.attributes&&(t.attributes=e.attributes),t}},this.getDynamicAttributes=e=>(J.isNil(e)||J.keys(e).forEach((t=>{J.isFunction(e[t])?e[t]=e[t]():J.isArray(e[t])||(e[t]=J.toString(e[t]))})),e),this.buildCustomEvent=(e,t,i)=>{var s;if(J.isString(e)&&e.match(/^[a-zA-Z_][0-9a-zA-Z_]{0,50}$/)){const{dataStore:{eventContextBuilder:n,eventInterceptor:o,eventHooks:r}}=this.growingIO;o(Object.assign({eventType:"CUSTOM",eventName:e,pageShowTimestamp:null===(s=null==r?void 0:r.currentPage)||void 0===s?void 0:s.time,attributes:J.limitObject(this.getDynamicAttributes(J.isObject(t)&&!J.isEmpty(t)?t:void 0)),resourceItem:J.limitObject(this.getValidResourceItem(i))},n()))}else J.consoleText("埋点事件格式不正确，事件名只能包含数字、字母和下划线，且不能以数字开头!","warn")},this.buildUserAttributesEvent=e=>{const{dataStore:{eventContextBuilder:t,eventInterceptor:i,lastVisitEvent:s}}=this.growingIO,n=Object.assign({eventType:"LOGIN_USER_ATTRIBUTES",attributes:J.limitObject(e)},t());n.path||(n.path=s.path,n.query=s.query,n.title=s.title),i(n)},J=this.growingIO.utils}}}),Y(Z,["plugins","gioTaobaoSendAdapter"],z);class X{constructor(e){this.growingIO=e,this.innerPluginInit=()=>{A(Z.plugins).forEach((e=>{const{name:t,method:i}=Z.plugins[e];this.pluginItems.find((e=>e.name===t))||this.pluginItems.push({name:w(t||e),method:i||(e=>{})})})),x(this.pluginItems)||this.installAll()},this.install=(e,t,i)=>{var s;const n=t||this.pluginItems.find((t=>t.name===e));if(null===(s=this.growingIO)||void 0===s?void 0:s.plugins[e])return L(`重复加载插件 ${e} 或插件重名，已跳过加载!`,"warn"),!1;if(!n)return L(`插件加载失败!不存在名为 ${e} 的插件!`,"error"),!1;try{return this.growingIO.plugins[e]=new n.method(this.growingIO,i),"cdp"===this.growingIO.gioEnvironment&&t&&L("加载插件："+e,"info"),!0}catch(e){return L("插件加载异常："+e,"error"),!1}},this.installAll=e=>{(e||this.pluginItems).forEach((t=>this.install(t.name,e?t:void 0,t.options)))},this.uninstall=e=>{var t;N(this.pluginItems,e);const i=N(null===(t=this.growingIO)||void 0===t?void 0:t.plugins,e);return i||L(`卸载插件 ${e} 失败!`,"error"),i},this.uninstallAll=()=>{this.pluginItems.forEach((e=>this.uninstall(e.name)))},this.lifeError=(e,t)=>L(`插件执行错误 ${e.name} ${t}`,"error"),this.onComposeBefore=e=>{this.pluginItems.forEach((t=>{var i;const s=null===(i=this.growingIO.plugins[t.name])||void 0===i?void 0:i.onComposeBefore;if(s&&p(s))try{s(e)}catch(e){this.lifeError(t,e)}}))},this.onComposeAfter=e=>{this.pluginItems.forEach((t=>{var i;const s=null===(i=this.growingIO.plugins[t.name])||void 0===i?void 0:i.onComposeAfter;if(s&&p(s))try{s(e)}catch(e){this.lifeError(t,e)}}))},this.onSendBefore=e=>{this.pluginItems.forEach((t=>{var i;const s=null===(i=this.growingIO.plugins[t.name])||void 0===i?void 0:i.onSendBefore;if(s&&p(s))try{s(e)}catch(e){this.lifeError(t,e)}}))},this.onSendAfter=e=>{this.pluginItems.forEach((t=>{var i;const s=null===(i=this.growingIO.plugins[t.name])||void 0===i?void 0:i.onSendAfter;if(s&&p(s))try{s(e)}catch(e){this.lifeError(t,e)}}))},this.pluginItems=[],this.growingIO.emitter.on("onComposeBefore",this.onComposeBefore),this.growingIO.emitter.on("onComposeAfter",this.onComposeAfter),this.growingIO.emitter.on("onSendBefore",this.onSendBefore),this.growingIO.emitter.on("onSendAfter",this.onSendAfter)}}var ee={},te={}.hasOwnProperty;function ie(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function se(e){try{return encodeURIComponent(e)}catch(e){return null}}ee.stringify=function(e,t){t=t||"";var i,s,n=[];for(s in"string"!=typeof t&&(t="?"),e)if(te.call(e,s)){if((i=e[s])||null!=i&&!isNaN(i)||(i=""),s=se(s),i=se(i),null===s||null===i)continue;n.push(s+"="+i)}return n.length?t+n.join("&"):""},ee.parse=function(e){for(var t,i=/([^=?#&]+)=?([^&]*)/g,s={};t=i.exec(e);){var n=ie(t[1]),o=ie(t[2]);null===n||null===o||n in s||(s[n]=o)}return s};const ne=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),oe=e=>e.pixelRatio?Math.round(e.screenWidth*e.pixelRatio):e.screenWidth,re=(e,t)=>{if(e){const i=e.toLowerCase();return-1!==i.indexOf("android")?t+"-Android":-1!==i.indexOf("ios")?t+"-iOS":e}},ae=e=>A(e).filter((e=>e.indexOf("__sub")>-1&&e.indexOf("gio__")>-1)).sort(),le=()=>{let e=D((()=>getApp({allowDefault:!0})));return e||(e=global||$global),e};class ge{constructor(e){var t;this.growingIO=e,this.initUserInfo=()=>{const{minipInstance:e}=this.growingIO;this.uid=e.getStorageSync(this.uidStorageName)||ne(),this.userId=e.getStorageSync(this.userIdStorageName),this.userKey=e.getStorageSync(this.userKeyStorageName),this.gioId=e.getStorageSync(this.gioIdStorageName)},this.syncUserInfo=()=>{const{minipInstance:e}=this.growingIO;e.setStorageSync(this.uidStorageName,this.uid),e.setStorageSync(this.userIdStorageName,this.userId),e.setStorageSync(this.userKeyStorageName,this.userKey),e.setStorageSync(this.gioIdStorageName,this.gioId)};const{inPlugin:i}=this.growingIO;this.uidStorageName=i?"_growing_plugin_uid_":"_growing_uid_",this.userIdStorageName=i?"_growing_plugin_userId_":"_growing_userId_",this.userKeyStorageName=i?"_growing_plugin_userKey_":"_growing_userKey_",this.gioIdStorageName=i?"_growing_plugin_gioId_":"_growing_gioId_",this._sessionId=ne(),this._uid=void 0,this._userId=void 0,this._userKey=void 0,this._gioId=void 0,"quickapp"!==(null===(t=this.growingIO)||void 0===t?void 0:t.gioPlatform)&&this.initUserInfo()}get sessionId(){return this._sessionId||(this._sessionId=ne()),this._sessionId}set sessionId(e){const t=this._sessionId;this._sessionId=e||ne(),t!==this._sessionId&&this.growingIO.emitter.emit("SESSIONID_UPDATE",{newSessionId:this._sessionId,oldSessionId:t})}get uid(){return this._uid}set uid(e){const t=this._uid;this._uid=e,this.growingIO.minipInstance.setStorage(this.uidStorageName,this._uid),t!==this._uid&&this.growingIO.emitter.emit("UID_UPDATE",{newUId:e,oldUId:t})}get userId(){return this._userId}set userId(e){const t=this._userId;this._userId=e,this.growingIO.minipInstance.setStorage(this.userIdStorageName,this._userId),t!==this._userId&&this.growingIO.emitter.emit("USERID_UPDATE",{newUserId:e,oldUserId:t}),e&&(this.gioId=e)}get userKey(){return this._userKey}set userKey(e){const t=this._userKey;this._userKey=e,this.growingIO.minipInstance.setStorage(this.userKeyStorageName,this._userKey),t!==this._userKey&&this.growingIO.emitter.emit("USERKEY_UPDATE",{newUserKey:e,oldUserKey:t})}get gioId(){return this._gioId}set gioId(e){const t=this._gioId;this._gioId=e,this.growingIO.minipInstance.setStorage(this.gioIdStorageName,this._gioId),t!==this._gioId&&this.growingIO.emitter.emit("GIOID_UPDATE",{newGioId:e,oldGioId:t})}}const ue={scnPrefix:"",appHandlers:["onLaunch","onShow","onHide","onError","onPageNotFound"],pageHandlers:["onLoad","onShow","onReady","onHide","onShareAppMessage","onTabItemTap"],componentHandlers:["created","attached","detached","onShareAppMessage","onTabItemTap","show","hide"],actionEventTypes:["onclick","tap","longpress","longTap","blur","change","submit","confirm","getuserinfo","getphonenumber","contact"],originalApp:D((()=>App)),originalPage:D((()=>Page)),originalComponent:D((()=>Component)),originalBehavior:D((()=>Behavior)),canHook:!0,hooks:{App:!0,Page:!0,Component:!0,Behavior:!0},listeners:{app:{appLaunch:"onLaunch",appShow:"onShow",appClose:"onHide",appError:"onError",appPageNotFound:"onPageNotFound"},page:{pageLoad:"onLoad",pageShow:"onShow",pageReady:"onReady",pageHide:"onHide",tabTap:"onTabItemTap",shareApp:"onShareAppMessage",comCreated:"created",comAttached:"attached",comDetached:"detached",comShow:"show",comHide:"hide"},actions:{click:["onclick","tap","longpress","longTap","getuserinfo","getphonenumber","contact"],change:["blur","change","confirm"],submit:["submit"]}}},he=Object.assign(Object.assign({},ue),{listeners:Object.assign({},ue.listeners),name:"Alipay",platform:"alip",scnPrefix:"alip_",componentHandlers:["onInit","didMount","didUnmount"],hooks:Object.assign(Object.assign({},null==ue?void 0:ue.hooks),{Behavior:!1})});function de(e,t,i,s){return new(i||(i=Promise))((function(n,o){function r(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((s=s.apply(e,t||[])).next())}))}he.listeners.page=Object.assign(Object.assign({},he.listeners.page),{comCreated:"onInit",comAttached:"didMount",comDetached:"didUnmount"});class ce extends class{constructor(e){this.growingIO=e,this.minip=D((()=>my)),this.getAppId=()=>"",this.navigateTo=e=>{var t;return null===(t=this.minip)||void 0===t?void 0:t.navigateTo(e)},this.switchTab=e=>{var t;null===(t=this.minip)||void 0===t||t.switchTab(e)},this.navigateToMiniProgram=e=>{var t;return null===(t=this.minip)||void 0===t?void 0:t.navigateToMiniProgram(e)},this.onAppShow=e=>{var t;null===(t=this.minip)||void 0===t||t.onAppShow(e)},this.onAppHide=e=>{var t;null===(t=this.minip)||void 0===t||t.onAppHide(e)},this.getImageInfo=({src:e,success:t,fail:i,complete:s})=>{var n;return null===(n=this.minip)||void 0===n?void 0:n.getImageInfo({src:e,success:t,fail:i,complete:s})},this.initImpression=e=>{var t,i;null===(i=null===(t=this.growingIO.plugins)||void 0===t?void 0:t.gioImpressionTracking)||void 0===i||i.main(e,"observeAll")},this.getCurrentPage=()=>D((()=>f(getCurrentPages())))||{},this.getCurrentPath=()=>{const e=this.getCurrentPage();return(null==e?void 0:e.route)||(null==e?void 0:e.uri)||(null==e?void 0:e.__route__)||""},this.getPageTitle=e=>{var t,i;return u(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.gioPageTitle)?R(null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.gioPageTitle):""},this.getStorageSync=e=>{var t;return null===(t=this.minip)||void 0===t?void 0:t.getStorageSync(e)},this.getStorage=e=>new Promise((t=>{var i;null===(i=this.minip)||void 0===i||i.getStorage({key:e,success:({data:e})=>t(e),fail:()=>t("")})})),this.setStorageSync=(e,t)=>{var i;null===(i=this.minip)||void 0===i||i.setStorageSync(e,t)},this.setStorage=(e,t)=>{var i;null===(i=this.minip)||void 0===i||i.setStorage({key:e,data:t})},this.removeStorageSync=e=>{var t;null===(t=this.minip)||void 0===t||t.removeStorageSync(e)},this.removeStorage=e=>{var t;null===(t=this.minip)||void 0===t||t.removeStorage(e)},this.getNetworkType=()=>de(this,void 0,void 0,(function*(){const e=this;return yield new Promise((t=>{var i;null===(i=this.minip)||void 0===i||i.getNetworkType({success:i=>{e.network=i,t(i)},fail:()=>t(null)})}))})),this.request=({url:e,data:t,header:i,timeout:s,method:n,success:o,fail:r,complete:a})=>{var l;const g=null===(l=this.minip)||void 0===l?void 0:l.request({url:e,data:t,header:i,timeout:s,method:n,success:o,fail:r,complete:a}),u=setTimeout((()=>{null==g||g.abort(),clearTimeout(u)}),(s||1e4)+10);return g},this.getSystemInfo=()=>de(this,void 0,void 0,(function*(){const e=this;return yield new Promise((t=>{var i;null===(i=this.minip)||void 0===i||i.getSystemInfo({success:i=>{e.systemInfo=i,t(i)},fail:()=>t(null)})}))})),this.getSetting=()=>new Promise((e=>{var t;null===(t=this.minip)||void 0===t||t.getSetting({success:e,fail:e})}));const{platformConfig:{platform:t,scnPrefix:i}}=this.growingIO;this.platform=t,this.scnPrefix=i,this.getNetworkType().then((()=>{var e;return null===(e=this.growingIO.dataStore)||void 0===e?void 0:e.eventReleaseInspector()})),this.getSystemInfo().then((()=>{var e;return null===(e=this.growingIO.dataStore)||void 0===e?void 0:e.eventReleaseInspector()}))}}{constructor(e){super(e),this.growingIO=e,this.getAppId=()=>{if(my.getAppIdSync){const{appId:e}=my.getAppIdSync();return e}return L("当前支付宝版本过低，无法获取AppId，请升级最新版本支付宝!","warn"),""},this.initImpression=e=>{var t,i;null===(i=null===(t=this.growingIO.plugins)||void 0===t?void 0:t.gioImpressionTracking)||void 0===i||i.main(e,"selectAll")},this.getStorageSync=e=>{const{data:t}=my.getStorageSync({key:e});return t},this.setStorageSync=(e,t)=>{var i;null===(i=this.minip)||void 0===i||i.setStorageSync({key:e,data:t})}}}class pe{constructor(e){this.growingIO=e,this.main=e=>{var t,i,s,n;const{sdkVersion:o,vdsConfig:r,platformConfig:a,minipInstance:l,userStore:g,dataStore:{eventHooks:u,locationData:h,lastVisitEvent:d}}=this.growingIO,{systemInfo:c={},network:p={}}=l,{brand:m,model:v,platform:f,language:I,version:S}=c,y={appChannel:"scn:"+(u.scene||"NA"),appVersion:r.version,dataSourceId:r.dataSourceId,deviceBrand:m,deviceId:g.uid,deviceModel:v,deviceType:re(f,a.name),domain:r.appId||l.getAppId(),gioId:g.gioId,language:I,latitude:null==h?void 0:h.latitude,longitude:null==h?void 0:h.longitude,networkState:(null==p?void 0:p.networkType)||(null==p?void 0:p.type),operatingSystem:re(f,a.name),path:(null===(t=u.currentPage)||void 0===t?void 0:t.path)?null===(i=u.currentPage)||void 0===i?void 0:i.path:d.path,platform:a.platform,platformVersion:a.name+(S?" "+S:""),query:(null===(s=u.currentPage)||void 0===s?void 0:s.path)?null===(n=u.currentPage)||void 0===n?void 0:n.query:d.query,screenHeight:(O=c,O.pixelRatio?Math.round(O.screenHeight*O.pixelRatio):O.screenHeight),screenWidth:oe(c),sdkVersion:o,sessionId:g.sessionId,title:l.getPageTitle(l.getCurrentPage()),timestamp:Date.now(),userId:g.userId};var O;return r.enableIdMapping&&(y.userKey=g.userKey),x(r.ignoreFields)||r.ignoreFields.forEach((e=>{N(y,e)})),x(e)?y:Object.assign(Object.assign({},y),e)}}}const me=e=>{const t=e.split(/[\r\n]/);return(e=>{const t=[];if(e&&e.length>0)for(let i=0;i<e.length;i++){const s=e[i];if(t[0]=e[i-1],t[1]=s,/at /.test(s))break}if(t.some((e=>!e)))return;const i=t[0].split(/: ?/);if(!i||2>i.length)return;const s=t[1].match(/at (.*?) \((.*)\)/);return s&&s.length>=3?{key:i[0],error:i[1],function:s[1],page:s[2]}:void 0})(t)||(e=>{let t;if(e&&e.length>1){const i=e[1].split(";");if(i&&i.length>1){const s=i[1].match(/at ([^ ]+) page (.*) function/);t={key:e[0],error:i[0]},s&&s.length>2&&(t.page=s[1],t.function=s[2])}}return t})(t)||(e=>{if(e&&e.length>0)return{error:e.join("")}})(t)};class ve{constructor(e){this.growingIO=e,this.main=(e,t)=>{var i;const{userStore:s,vdsConfig:n,platformConfig:o,dataStore:{eventHooks:r,lastVisitEvent:a}}=this.growingIO;n.debug&&console.log("App:",e,Date.now());const l=o.listeners.app;if(!r.shareOut)switch(this.growingIO.emitter.emit("onComposeBefore",{event:"App "+e,params:null!==(i=t[0])&&void 0!==i?i:{}}),e){case l.appCreate:case l.appShow:if(x(a)&&t[0]){const{path:e="",query:i={}}=t[0];this.growingIO.dataStore.lastVisitEvent={path:e,query:ee.stringify(i)}}this.parseScene(t),r.lastCloseTime?(Date.now()-r.lastCloseTime>r.keepAlive||r.lastScene&&r.scene!==r.lastScene)&&(s.sessionId="",this.buildVisitEvent(t[0])):this.buildVisitEvent(t[0]);break;case l.appClose:r.lastScene=r.scene,r.lastCloseTime=Date.now(),s.syncUserInfo(),this.buildCloseEvent(),this.growingIO.vdsConfig.forceLogin||this.growingIO.uploader.initiateRequest(!0);break;case l.appError:case l.appPageNotFound:case l.appUnhandledRejection:t&&t.length>0&&u(t[0])&&this.buildErrorEvent(t[0])}},this.parseScene=e=>{var t;const{minipInstance:i,gioPlatform:s,emitter:n,dataStore:{eventHooks:o}}=this.growingIO,r=o.scene;let a;if("quickapp"===s){const{extra:e,type:t}=i.getAppSource();a=(null==e?void 0:e.scene)||t}else if(e.length>0){const i=e[0];(null===(t=null==i?void 0:i.query)||void 0===t?void 0:t.wxShoppingListScene)?a=i.query.wxShoppingListScene:(null==i?void 0:i.scene)?a=i.scene:o.scene="NA"}o.scene=a,a!==r&&n.emit("SCENE_UPDATE",{newScene:a,oldScene:r})},this.buildVisitEvent=e=>{const{dataStore:t}=this.growingIO,{eventContextBuilder:i,eventInterceptor:s}=t;s(Object.assign({eventType:"VISIT"},i({path:(null==e?void 0:e.path)||(null==e?void 0:e.p)||"",query:c(null==e?void 0:e.query)?ee.stringify((null==e?void 0:e.query)||{}):(null==e?void 0:e.query)||(null==e?void 0:e.q)||""})))},this.buildCloseEvent=()=>{const{dataStore:{eventContextBuilder:e,eventInterceptor:t}}=this.growingIO;t(Object.assign({eventType:"APP_CLOSED"},e()))},this.buildErrorEvent=e=>{const{dataStore:{eventContextBuilder:t,eventInterceptor:i,eventHooks:s}}=this.growingIO;i(Object.assign({eventType:"CUSTOM",pageShowTimestamp:s.currentPage.time,eventName:"onError",attributes:me(e)},t()))}}}class fe{constructor(){this.parsePage=(e,t)=>{var i;this.path=e.route||e.uri||e.__route__||(null===(i=null==e?void 0:e.$page)||void 0===i?void 0:i.fullPath)||"",x(t)?this.query=void 0:this.query=this.getQuery(t),this.time=Date.now()},this.getQuery=e=>S(Object.keys(e||{})).filter((e=>"wxShoppingListScene"!==e)).map((t=>`${t}=${e[t]}`)).join("&"),this.updateShareResult=(e,t)=>{const{vdsConfig:i,currentPage:s,minipInstance:n,userStore:o}=e;if(null==i?void 0:i.followShare){const e=o.uid;t||(t={}),t.title||(t.title=n.getPageTitle(n.getCurrentPage()));const[i,r]=(e=>{if(u(e)){const t=e.indexOf("?");return-1!==t?[e.substring(0,t),e.substring(t+1)]:[e,""]}return["",""]})(P(t,"path")?t.path:s.path),a=ee.parse(r||(P(t,"path")?t.query:s.query)||"")||{};P(t,"path")||A(a).forEach((e=>{(["gioPreShareId","gioShareId","suid"].includes(e)||e.toLowerCase().startsWith("utm_"))&&delete a[e]}));const[l,g]=this.buildShareQuery(a,e,t);t.query=l,t.path=(e=>u(e)?e.startsWith("/")?e:"/"+e:"")(i+"?"+l),t.attributes=g}return t},this.updateQueryShareId=e=>{e.gioShareId&&(this.queryShareId=e.gioShareId)},this.query=void 0}buildShareQuery(e,t,i){const s={gioShareId:ne(),suid:t},n=Object.assign({},e,s),o=i.contentType||n.contentType,r=i.contentId||n.contentId;return o&&(s.contentType=o),r&&(s.contentId=r),this.queryShareId&&(s.gioPreShareId=this.queryShareId),[ee.stringify(n),s]}}class Ie{constructor(e){this.growingIO=e,this.main=(e,t,i)=>{var s,n,o,r,a,l,g,u;const{minipInstance:h,plugins:d,vdsConfig:c,platformConfig:m,dataStore:{eventHooks:v}}=this.growingIO,{currentPage:f,shareOut:I,toggleShareOut:S}=v;if(this.prevEvent[t]&&50>Date.now()-Number(this.prevEvent[t]))return;this.prevEvent[t]=Date.now(),c.wepy&&(e.route=e.$is),e.route||(e.route=h.getCurrentPath(e)),c.debug&&console.log("Page:",e.route,"#",t,Date.now());const y=m.listeners.page;this.growingIO.emitter.emit("onComposeBefore",{page:e,event:"Page "+t,params:null!==(s=i[0])&&void 0!==s?s:{}});const O=e.route||e.uri||e.__route__||(null===(n=null==e?void 0:e.$page)||void 0===n?void 0:n.fullPath)||"";switch(t){case y.comShow:if(!c.comAsPage)break;case y.pageLoad:this.argQuery[O]=i[0]||k(e,"__displayReporter.query")||k(e,"$page.query")||k(e,"$wx.__displayReporter.query")||{};break;case y.pageShow:f.parsePage(e,this.argQuery[O]),I?S():this.buildPageEvent(),f.updateQueryShareId(this.argQuery[O]),h.initImpression(h.getCurrentPage());break;case y.pageReady:c.taro&&(e=>{const{Current:t,createComponent:i}=e;return!(!e||!t||i)})(c.taro)&&(null===(r=null===(o=this.growingIO.plugins)||void 0===o?void 0:o.gioTaroAdapter)||void 0===r||r.saveFullPage(document.body),h.initImpression(h.getCurrentPage()));break;case y.comHide:case y.pageHide:(null===(a=null==d?void 0:d.gioImpressionTracking)||void 0===a?void 0:a.impressionObserver)&&(null===(g=null===(l=null==d?void 0:d.gioImpressionTracking)||void 0===l?void 0:l.impressionObserver)||void 0===g||g.disconnect(),this.growingIO.plugins.gioImpressionTracking.impressionObserver=null);break;case y.shareApp:case y.shareTime:S(!0),c.followShare&&this.buildPageShareEvent(i);break;case y.tabTap:{const e=null===(u=null==d?void 0:d.gioEventAutoTracking)||void 0===u?void 0:u.buildTabClickEvent;c.autotrack&&e&&p(e)&&e(i[0]);break}}},this.buildPageEvent=()=>{const{minipInstance:e,dataStore:{lastPageEvent:t,eventContextBuilder:i,eventInterceptor:s,eventHooks:n}}=this.growingIO,{scene:o,currentPage:r}=n;s(Object.assign(Object.assign({eventType:"PAGE",referralPage:(null==t?void 0:t.path)||(null==t?void 0:t.p)||(o?`scn:${e.scnPrefix}${o}`:null)},i()),{timestamp:r.time}))},this.buildPageShareEvent=e=>{var t;let i,s;2>e.length?1===e.length&&(e[0].from?i=e[0]:e[0].title&&(s=e[0])):(i=e[0],s=e[1]);const{dataStore:{eventContextBuilder:n,eventInterceptor:o,eventHooks:r}}=this.growingIO;o(Object.assign({eventType:"CUSTOM",eventName:"onShareAppMessage",pageShowTimestamp:r.currentPage.time,attributes:Object.assign({from:null==i?void 0:i.from,target:null===(t=null==i?void 0:i.target)||void 0===t?void 0:t.id,title:null==s?void 0:s.title,path:decodeURI((null==s?void 0:s.path)||"")},null==s?void 0:s.attributes)},n()))},this.prevEvent={},this.argQuery={}}}class Se{constructor(e){var t,i,s;this.growingIO=e,this.toggleShareOut=e=>{d(e)?this.shareOut=e:this.shareOut=!this.shareOut},this.isNormalFc=(e,t)=>p(t)&&"constructor"!==e,this.objectTraverse=(e,t)=>{Object.getOwnPropertyNames(e).forEach((i=>t(i,e))),P(e,"methods")&&Object.getOwnPropertyNames(e.methods).forEach((i=>{e[i]||t(i,e.methods)})),P(e,"lifetimes")&&Object.getOwnPropertyNames(e.lifetimes).forEach((i=>{e[i]||t(i,e.lifetimes)})),P(e,"pageLifetimes")&&Object.getOwnPropertyNames(e.pageLifetimes).forEach((i=>{e[i]||t(i,e.pageLifetimes)}))},this.supLifeFcs=(e,t)=>{m(this[t+"Handlers"])&&this[t+"Handlers"].forEach((t=>{p(e[t])||["onShareAppMessage","onShareTimeline"].includes(t)||(e[t]=()=>{})}))},this.lifeFcEffects=(e,t,i)=>{const s=this;return function(){return de(this,arguments,void 0,(function*(){let n;try{["onShareAppMessage","onShareTimeline"].includes(e)&&(n=yield t.apply(this,arguments),s.growingIO.vdsConfig.followShare&&(n=s.currentPage.updateShareResult(Object.assign(Object.assign({},s),s.growingIO),n)));const o=[].slice.call(arguments);n&&o.push(n),s[`def${i}Cbs`][e].apply(this,o)}catch(e){L(e,"error")}return["onShareAppMessage","onShareTimeline"].includes(e)||(n=t.apply(this,arguments)),n}))}},this.customFcEffects=(e,t)=>{const i=this;return function(){var s,n;let o;try{let t=arguments[0]||{};P(t,"type")&&((null==t?void 0:t.currentTarget)||(null==t?void 0:t.target))||(t=arguments[arguments.length-1]),((null==t?void 0:t.currentTarget)||(null==t?void 0:t.target))&&i.actionEventTypes.includes(t.type)&&(p(i.actionEffects)||(i.actionEffects=(null===(n=null===(s=i.growingIO.plugins)||void 0===s?void 0:s.gioEventAutoTracking)||void 0===n?void 0:n.main)||function(){}),null==i||i.actionEffects(t,e))}catch(e){L(e,"error")}return o=t.apply(this,arguments),o}},this.appApplyProxy=(e,t)=>this.appHandlers.includes(e)?this.lifeFcEffects(e,t,"App"):this.customFcEffects(e,t),this.pageApplyProxy=(e,t)=>this.pageHandlers.includes(e)?this.lifeFcEffects(e,t,"Page"):this.customFcEffects(e,t),this.componentApplyProxy=(e,t)=>this.componentHandlers.includes(e)?this.lifeFcEffects(e,t,"Component"):this.customFcEffects(e,t),this.appOverriding=e=>(this.supLifeFcs(e,"app"),this.objectTraverse(e,((e,t)=>{this.isNormalFc(e,t[e])&&(t[e]=this.appApplyProxy(e,t[e]))})),e),this.pageOverriding=e=>(this.supLifeFcs(e,"page"),this.objectTraverse(e,((e,t)=>{this.isNormalFc(e,t[e])&&(t[e]=this.pageApplyProxy(e,t[e]))})),e),this.componentOverriding=e=>{const{vdsConfig:{comAsPage:t}}=this.growingIO;return t&&("my"===this.growingIO.gioPlatform?this.supLifeFcs(e,"component"):(e.lifetimes||(e.lifetimes={}),this.supLifeFcs(e.lifetimes,"component"),e.pageLifetimes||(e.pageLifetimes={}),this.supLifeFcs(e.pageLifetimes,"component"))),this.objectTraverse(e,((e,i)=>{this.isNormalFc(e,i[e])&&(i[e]=t?this.componentApplyProxy(e,i[e]):this.pageApplyProxy(e,i[e]))})),e},this.growingApp=e=>this.originalApp(this.appOverriding(e)),this.growingPage=e=>this.originalPage(this.pageOverriding(e)),this.growingComponent=e=>this.originalComponent(this.componentOverriding(e)),this.growingBehavior=e=>this.originalBehavior(this.componentOverriding(e)),this.nativeGrowing=()=>{const e=this,{platformConfig:t}=this.growingIO,i=t.hooks;try{i.App&&!this.appHooked&&(App=function(){return e.growingApp(arguments[0])},this.appHooked=!0)}catch(e){}try{i.Page&&!this.pageHooked&&(Page=function(){return e.growingPage(arguments[0])},this.pageHooked=!0)}catch(e){}try{i.Component&&!this.componentHooked&&(Component=function(){return e.growingComponent(arguments[0])},this.componentHooked=!0)}catch(e){}try{i.Behavior&&!this.behaviorHooked&&(Behavior=function(){return e.growingBehavior(arguments[0])},this.behaviorHooked=!0)}catch(e){}},this.initEventHooks=()=>{const e=this,{platformConfig:t,gioPlatform:i}=this.growingIO;this.appHandlers.forEach((t=>{this.defAppCbs[t]=function(){e.appEffects.main(t,arguments)}})),this.pageHandlers.forEach((t=>{this.defPageCbs[t]=function(){e.pageEffects.main(this,t,arguments)}})),this.componentHandlers.forEach((t=>{this.defComponentCbs[t]=function(){e.pageEffects.main(this,t,arguments)}})),t.canHook?this.nativeGrowing():"quickapp"===i&&(window.GioApp=function(){return e.appOverriding(arguments[0])},window.GioPage=function(){return e.pageOverriding(arguments[0])},window.GioComponent=function(){return e.componentOverriding(arguments[0])}),this.growingIO.App=D((()=>App)),this.growingIO.Page=D((()=>Page)),this.growingIO.Component=D((()=>Component)),this.growingIO.Behavior=D((()=>Behavior)),"quickapp"===i&&(this.growingIO.GioApp=window.GioApp,this.growingIO.GioPage=window.GioPage,this.growingIO.GioComponent=window.GioComponent)};const n=null===(t=this.growingIO)||void 0===t?void 0:t.platformConfig;this.defAppCbs={},this.defPageCbs={},this.defComponentCbs={},this.appHandlers=n.appHandlers,this.pageHandlers=n.pageHandlers,this.componentHandlers=n.componentHandlers,this.actionEventTypes=n.actionEventTypes,this.originalApp=n.originalApp,this.originalPage=n.originalPage,this.originalComponent=n.originalComponent,this.originalBehavior=null!==(i=n.originalBehavior)&&void 0!==i?i:function(){},this.appEffects=new ve(this.growingIO),this.pageEffects=new Ie(this.growingIO),this.currentPage=new fe,this.shareOut=!1,this.keepAlive=null===(s=this.growingIO)||void 0===s?void 0:s.vdsConfig.keepAlive}}class ye extends class{constructor(s){this.growingIO=s,this.ALLOW_SETTING=Object.assign({},e,"saas"===this.growingIO.gioEnvironment?i:t),this.allowOptKeys=Object.keys(this.ALLOW_SETTING),this.initStorageId=()=>{const e=le();let t=e.gio_esid?e.gio_esid:this.growingIO.minipInstance.getStorageSync(this.esidStorageName);t=c(t)&&!g(t)?t:{},this._esid={},A(t).forEach((e=>{this._esid[e]=Number.isNaN(Number(t[e]))||t[e]>=1e9||1>t[e]?1:t[e]})),T(t,this._esid)||this.growingIO.minipInstance.setStorageSync(this.esidStorageName,this._esid);const i=e.gio_gsid?e.gio_gsid:Number.parseInt(this.growingIO.minipInstance.getStorageSync(this.gsidStorageName),10);this._gsid=Number.isNaN(i)||i>=1e9||1>i?1:i,i!==this._gsid&&this.growingIO.minipInstance.setStorageSync(this.gsidStorageName,this._gsid)},this.initOptions=e=>{var t,i,s,n,o;const{projectId:r,dataSourceId:g,appId:u}=e,h={};this.allowOptKeys.forEach((t=>{const i=this.ALLOW_SETTING[t].type;(m(i)?i.includes(j(e[t])):j(e[t])===this.ALLOW_SETTING[t].type)?"ignoreFields"===t?h.ignoreFields=e.ignoreFields.filter((e=>a.includes(e))):"extraParams"===t?h.extraParams=e.extraParams.filter((e=>l.includes(e))):h[t]=e[t]:h[t]=this.ALLOW_SETTING[t].default})),h.uploadInterval=Math.round(h.uploadInterval),(Number.isNaN(h.uploadInterval)||0>h.uploadInterval||h.uploadInterval>2e3)&&(h.uploadInterval=1e3),this.growingIO.vdsConfig=Object.assign(Object.assign({},h),{projectId:r,dataSourceId:g,appId:u}),this.growingIO.inPlugin&&(this.growingIO.vdsConfig.autotrack=!1),this.eventHooks=new Se(this.growingIO),this.growingIO.inPlugin||this.eventHooks.initEventHooks();const{plugins:d}=this.growingIO,{cml:c,uniVue:p,wepy:v,taro:f,remax:I}=h;c&&(null===(t=null==d?void 0:d.gioChameleonAdapter)||void 0===t||t.main()),p&&(null===(i=null==d?void 0:d.gioUniAppAdapter)||void 0===i||i.main()),v&&(null===(s=null==d?void 0:d.gioWepyAdapter)||void 0===s||s.main()),f&&(null===(n=null==d?void 0:d.gioTaroAdapter)||void 0===n||n.main()),I&&(null===(o=null==d?void 0:d.gioRemaxAdapter)||void 0===o||o.main())},this.setOption=(e,t)=>{var i;const{vdsConfig:s,callError:n,uploader:o,emitter:r}=this.growingIO,a=u(e)&&this.allowOptKeys.includes(e),l=a&&typeof t===(null===(i=this.ALLOW_SETTING[e])||void 0===i?void 0:i.type);if(a&&l){if("dataCollect"===e&&!1===s.dataCollect&&!0===t){const e=setTimeout((()=>{this.sendVisit(),this.sendPage(),clearTimeout(e)}))}return s[e]=t,["host","scheme"].includes(e)&&(null==o||o.generateURL()),r.emit("OPTION_CHANGE",{optionName:e,optionValue:t}),!0}return n("setOption > "+e),!1},this.getOption=e=>{const{vdsConfig:t,callError:i}=this.growingIO;return e&&P(t,y(e))?t[y(e)]:g(e)?Object.assign({},t):void i("getOption > "+e)},this.sendVisit=()=>{this.eventHooks.appEffects.buildVisitEvent(this.lastVisitEvent)},this.sendPage=()=>{this.eventHooks.pageEffects.buildPageEvent()},this.eventInterceptor=e=>{const{systemInfo:t,network:i}=this.growingIO.minipInstance;x(t)||x(i)?this.interceptEvents.push(e):x(this.interceptEvents)?this.eventConverter(e):([...this.interceptEvents,e].forEach((e=>{const t=Object.assign(Object.assign({},e),this.eventContextBuilder({path:e.path,query:e.query}));this.eventConverter(t)})),this.interceptEvents=[])},this.eventReleaseInspector=()=>{const{minipInstance:{systemInfo:e,network:t}}=this.growingIO;e&&t&&!x(this.interceptEvents)&&([...this.interceptEvents].forEach((e=>{const t=Object.assign(Object.assign({},e),this.eventContextBuilder({path:e.path,query:e.query}));this.eventConverter(t)})),this.interceptEvents=[])},this.esidStorageName="_growing_esid_",this.gsidStorageName="_growing_gsid_",this.initStorageId(),this.eventContextBuilder=new pe(this.growingIO).main,this.lastVisitEvent={},this.lastPageEvent={},this.locationData={},this.generalProps={},this.interceptEvents=[],this.growingIO.emitter.on("onComposeAfter",(({composedEvent:e})=>{"VISIT"!==e.eventType&&"vst"!==e.t||(this.lastVisitEvent=e),"PAGE"!==e.eventType&&"page"!==e.t||(this.lastPageEvent=e)}))}get esid(){const e=le(),t=ae(e);return!x(t)&&e.gio_esid?e.gio_esid:this._esid}set esid(e){const t={};A(e).forEach((i=>{t[i]=Number.isNaN(e[i])||e[i]>=1e9||1>e[i]?1:e[i]})),T(t,this._esid)||(this._esid=t,le().gio_esid=this._esid,this.growingIO.minipInstance.setStorageSync(this.esidStorageName,this._esid))}get gsid(){const e=le(),t=ae(e);return!x(t)&&e.gio_gsid?e.gio_gsid:this._gsid}set gsid(e){const t=Number.parseInt(e,10);this._gsid=Number.isNaN(t)||e>=1e9||1>e?1:e,le().gio_gsid=this._gsid,this.growingIO.minipInstance.setStorageSync(this.gsidStorageName,this._gsid)}}{constructor(e){super(e),this.growingIO=e,this.eventConverter=e=>{const{vdsConfig:t,dataStore:i,uploader:s}=this.growingIO;if(t.dataCollect){e.globalSequenceId=i.gsid,e.eventSequenceId=i.esid[e.eventType]||1;const t={};_(e,((e,i)=>{var s;if("element"===i){const i=null!==(s=v(e))&&void 0!==s?s:{};_(i,((e,i)=>{x(e)&&0!==e||(t[i]=e)}))}else x(e)&&0!==e||(t[i]=e)})),this.growingIO.dataStore.gsid+=1,this.growingIO.dataStore.esid=Object.assign(Object.assign({},this.growingIO.dataStore.esid),{[t.eventType]:(this.growingIO.dataStore.esid[t.eventType]||1)+1}),this.growingIO.emitter.emit("onComposeAfter",{composedEvent:t}),s.commitRequest(t)}}}}class Oe extends class{constructor(e){this.growingIO=e,this.commitRequest=e=>{const t=Object.assign({},e),{vdsConfig:i}=this.growingIO;i.forceLogin?this.hoardingQueue.push(t):(this.requestQueue.push(t),this.initiateRequest())},this.initiateRequest=e=>{var t,i;const{plugins:s,vdsConfig:n}=this.growingIO;[...this.hoardingQueue,...this.requestQueue].length>0&&this.requestingNum<this.requestLimit&&((null===(t=null==n?void 0:n.tbConfig)||void 0===t?void 0:t.cloudFuncSend)?null===(i=null==s?void 0:s.gioTaobaoSendAdapter)||void 0===i||i.singleInvoke():e?this.batchInvoke():this.batchInvokeThrottle())},this.batchInvoke=()=>{var e,t,i;const{vdsConfig:s,plugins:n,emitter:o}=this.growingIO;let r=[...this.hoardingQueue,...this.requestQueue];r.length>50?(r=r.slice(0,50),this.hoardingQueue.length>50?this.hoardingQueue=this.hoardingQueue.slice(50):(this.hoardingQueue=[],this.requestQueue=this.requestQueue.slice(50-this.hoardingQueue.length))):(this.hoardingQueue=[],this.requestQueue=[]);let a=r.filter((e=>(this.retryIds[e.globalSequenceId||e.esid]||0)<=this.retryLimit));if(x(a))return;s.debug&&console.log("[GrowingIO Debug]:",JSON.stringify(a,null,2));const l={"content-type":"application/json;charset=UTF-8"};if(o.emit("onSendBefore",{requestData:a}),null===(e=null==s?void 0:s.tbConfig)||void 0===e?void 0:e.cloudAppId)null===(t=null==n?void 0:n.gioTaobaoSendAdapter)||void 0===t||t.tbCloudAppInvoke(a);else{let e=[...a];s.compress&&(null===(i=null==n?void 0:n.gioCompress)||void 0===i?void 0:i.compressToUTF16)&&(e=n.gioCompress.compressToUTF16(JSON.stringify(a)),l["X-Compress-Codec"]="1"),this.normalBatchInvoke({header:l,data:e})}},this.batchInvokeThrottle=q(this.batchInvoke,this.growingIO.vdsConfig.uploadInterval,!1,!1),this.normalBatchInvoke=({header:e,data:t})=>{this.requestingNum+=1,this.growingIO.minipInstance.request({url:`${this.requestURL}?stm=${Date.now()}`,header:e,method:"POST",data:t,timeout:this.requestTimeout,fail:e=>{[200,204].includes(e.code)||(m(t)?t.forEach((e=>{this.requestFailFn(e)})):this.requestFailFn(t),L("请求失败!"+JSON.stringify(e),"error"))},complete:e=>{this.requestingNum-=1,this.growingIO.emitter.emit("onSendAfter",{result:e}),this.initiateRequest()}})},this.requestFailFn=e=>{this.retryIds[e.globalSequenceId||e.esid]||(this.retryIds[e.globalSequenceId||e.esid]=0),this.retryIds[e.globalSequenceId||e.esid]+=1,this.requestQueue.some((t=>t.globalSequenceId===e.globalSequenceId&&t.esid===e.esid))||this.requestQueue.push(e)},this.hoardingQueue=[],this.requestQueue=[],this.requestLimit=3,this.requestTimeout=5e3,this.retryLimit=2,this.retryIds={},this.requestingNum=0,this.requestURL=""}}{constructor(e){super(e),this.growingIO=e,this.generateURL=()=>{let{scheme:e,host:t="",projectId:i}=this.growingIO.vdsConfig;e?E(y(e),"://")||(e+="://"):e="https://",b(t,"http")&&(t=t.substring(t.indexOf("://")+(E(y(e),"://")?4:1))),this.requestURL=`${e}${t}/v3/projects/${i}/collect`},this.generateURL()}}const we=new class extends class{constructor(){var e;this.init=e=>(L("Gio小程序SDK 初始化中...","info"),e.appId||(e.appId=this.minipInstance.getAppId()||e.projectId),this.dataStore.initOptions(e),this.gioSDKInitialized=!0,this.vdsConfig.subpackage||(le().__gio__=this),null==this||this.initCallback(),this.emitter.emit("SDK_INITIALIZED",this),L("Gio小程序SDK 初始化完成！","success"),this.vdsConfig.forceLogin&&L("forceLogin已开启，请调用 identify 方法设置 openId 以继续上报!","info"),this.inPlugin&&this.dataStore.sendVisit(),!0),this.setDataCollect=e=>{this.setOption("dataCollect",!!e),this.notRecommended()},this.setAutotrack=e=>{this.setOption("autotrack",!!e),this.notRecommended()},this.enableDebug=e=>{this.setOption("debug",!!e),this.notRecommended()},this.setOption=(e,t)=>{if(n.includes(e)){const i=this.dataStore.setOption(e,t);return i&&o[e]&&L(`已${t?"开启":"关闭"}${o[e]}`,"info"),i}return L(`不存在可修改的配置项：${e}，请检查后重试!`,"warn"),!1},this.getDeviceId=()=>this.userStore.uid,this.getOption=e=>this.dataStore.getOption(e),this.getGioInfo=()=>{const{uid:e,userId:t,userKey:i,sessionId:s,gioId:n}=this.userStore,{projectId:o,appId:r,dataSourceId:a,dataCollect:l,enableIdMapping:g,extraParams:u,ignoreFields:h}=this.vdsConfig,d={gioappid:r,giocs1:t||"",gioplatform:this.platformConfig.platform,gioprojectid:o,gios:s,giou:e};return"cdp"===this.gioEnvironment&&(d.giodatacollect=l,d.giodatasourceid=a,d.gioid=n||"",g&&(d.giouserkey=i),x(u)||u.forEach((e=>{h.includes(e)||(d["gio"+e]=this.dataStore.lastVisitEvent[e])}))),ee.stringify(d)},this.setLocation=(e,t)=>{const i={latitude:e,longitude:t},s=this.dataStore.locationData,n=e=>e>=-180&&180>=e;n(e)&&n(t)&&(s.latitude!==e||s.longitude!==t)&&(this.dataStore.locationData=i,this.dataStore.sendVisit())},this.setGeneralProps=e=>{c(e)&&!x(e)?(this.dataStore.generalProps=Object.assign(Object.assign({},this.dataStore.generalProps),e),A(this.dataStore.generalProps).forEach((e=>{[void 0,null].includes(this.dataStore.generalProps[e])&&(this.dataStore.generalProps[e]="")}))):this.callError("setGeneralProps")},this.clearGeneralProps=e=>{m(e)&&!x(e)?e.forEach((e=>{N(this.dataStore.generalProps,e)})):this.dataStore.generalProps={}},this.notRecommended=()=>L("不推荐的方法使用，建议使用 gio('setOption', [optionName], [value])!","info"),this.callError=(e,t=!0,i="参数不合法")=>L(`${t?"调用":"设置"} ${e} 失败，${i}!`,"warn"),this.utils=Object.assign(Object.assign(Object.assign({},F),U),{qs:ee}),this.emitter={all:e=e||new Map,on:function(t,i){var s=e.get(t);s?s.push(i):e.set(t,[i])},off:function(t,i){var s=e.get(t);s&&(i?s.splice(s.indexOf(i)>>>0,1):e.set(t,[]))},emit:function(t,i){var s=e.get(t);s&&s.slice().map((function(e){e(i)})),(s=e.get("*"))&&s.slice().map((function(e){e(t,i)}))}},this.gioPlatform="my",this.gioEnvironment="cdp",this.sdkVersion="3.8.6";try{("quickapp"===this.gioPlatform||p(getApp)&&App)&&(this.inPlugin=!1)}catch(e){this.inPlugin=!0,L("未检测到小程序实例，自动切换为插件模式!","info")}this.platformConfig=he,this.minipInstance=new ce(this),this.userStore=new ge(this),this.plugins=new X(this),this.plugins.innerPluginInit()}}{constructor(){super(),this.registerPlugins=e=>{this.plugins.pluginItems=[...this.plugins.pluginItems,...e],this.plugins.installAll(e)},this.initCallback=()=>{this.uploader=new Oe(this),this.vdsConfig.enableIdMapping||(this.userStore.userKey="")},this.setTrackerScheme=e=>{["http","https"].includes(e)?(this.dataStore.setOption("scheme",e),this.notRecommended()):this.callError("scheme",!1)},this.setTrackerHost=e=>{Q.test(e)||M.test(e)?(this.dataStore.setOption("host",e),this.notRecommended()):this.callError("host",!1)},this.identify=e=>{if(this.vdsConfig.forceLogin){if(!B(e))return void this.callError("identify");const t=y(e).slice(0,1e3);this.userStore.uid=t,this.uploader.hoardingQueue.forEach(((e,i)=>this.uploader.hoardingQueue[i].deviceId=t)),this.dataStore.setOption("forceLogin",!1),this.uploader.initiateRequest(!0)}else this.callError("identify",!1,"forceLogin未开启")},this.setUserAttributes=e=>{var t,i;!x(e)&&c(e)?null===(i=null===(t=this.plugins)||void 0===t?void 0:t.gioCustomTracking)||void 0===i||i.buildUserAttributesEvent(e):this.callError("setUserAttributes")},this.setUserId=(e,t)=>{if(B(e)){const i=this.userStore.gioId;e=y(e).slice(0,1e3),t=y(t).slice(0,1e3),this.userStore.userId=e,this.vdsConfig.enableIdMapping&&(this.userStore.userKey=g(t)?"":t),this.reissueLogic(i,e)}else this.callError("setUserId")},this.clearUserId=()=>{this.userStore.userId=void 0,this.userStore.userKey=void 0},this.track=(e,t,i)=>{var s,n;((null===(n=null===(s=this.plugins)||void 0===s?void 0:s.gioCustomTracking)||void 0===n?void 0:n.buildCustomEvent)||function(){})(e,Object.assign(Object.assign({},this.dataStore.generalProps),c(t)&&!x(t)?t:{}),i)},this.reissueLogic=(e,t)=>{e&&e!==t&&(this.userStore.sessionId="",this.dataStore.sendVisit()),e||e===t||this.dataStore.sendVisit()},this.dataStore=new ye(this)}},be=function(){const e=arguments[0];if(u(e)&&s.includes(e)&&we[e]){const t=I(Array.from(arguments));if("init"===e){const e=$(we),i=K(t),s=G(t),n=V(t);if(e&&i&&s&&n){const{projectId:e}=s,{dataSourceId:t,appId:i,cdpOptions:o}=n;return i||"quickapp"!==we.gioPlatform?we.init(Object.assign(Object.assign({},o),{projectId:e,dataSourceId:t,appId:i})):(L("请填写AppId(packageName)!","error"),!1)}}else if("registerPlugins"===e)we.registerPlugins(t[0]);else{if(we.gioSDKInitialized&&we.vdsConfig)return we[e](...t);L("SDK未初始化!","error")}}else r.includes(e)?L(`方法 ${y(e)} 已被弃用!`,"warn"):L(`不存在名为 ${y(e)} 的方法调用!`,"error")};(global||$global).gdp=be,(global||$global).gioEnvironment="cdp",(global||$global).gioSDKVersion=we.sdkVersion;export{be as default};
