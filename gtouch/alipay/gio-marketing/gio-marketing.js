(global||$global).gTouchVersion="3.8.1";const e=getApp()?.__gio__||(global||$global)?.__gio__||{},{dataStore:t,emitter:s,gioEnvironment:i,minipInstance:r,userStore:n,utils:o,vdsConfig:a,track:g}=e;let{appId:l,debug:u,gtouchHost:p,projectId:h,scheme:d}=a||{};const{getImageInfo:c,getStorageSync:m,navigateTo:v,navigateToMiniProgram:f,request:T,setStorageSync:b}=r||{getImageInfo:()=>{},getStorageSync:()=>{},navigateTo:()=>{},navigateToMiniProgram:()=>{},request:()=>{},setStorageSync:()=>{}},{compact:S,endsWith:D,head:w,isArray:y,isEmpty:I,isString:E,keys:$,qs:_,startsWith:R}=o||{},U=(e,t)=>{console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},M=e=>u&&console.log("[GrowingIO Debug]:",JSON.stringify(e,null,2));e&&e.gioSDKInitialized||U("未集成或未初始化加载 Gio小程序SDK! GioMarketing 加载失败！","error");let F="";"saas"===i?F=`https://messages.growingio.com/v3/${h}/notifications`:p&&E(p)?(d?D(toString(d),"://")||(d+="://"):d="https://",R(p,"http")&&(p=p.substring(p.indexOf("://")+(D(toString(d),"://")?4:1))),F=`${d}${p}/marketing/automation/v3/${h}/notifications`):U("如果您需要使用触达功能，请在 Gio小程序SDK 中配置 gtouchHost!","info");class k{get=(e,t)=>{const s=m(`push-user-status#${e}${t?"#"+t:""}`)||{},i="userAttrs"===e?432e7:864e5;return Date.now()>s.startAt+i?(this.set(e,0,t),0):s.value};set=(e,t,s)=>{const i=new Date;i.setHours(0),i.setMinutes(0),i.setSeconds(0),b(`push-user-status#${e}${s?"#"+s:""}`,{startAt:i.getTime(),value:t})}}class C{get=(e,t)=>{const s=m(`#push-status#${e}#${t||""}`)||{},i={showTimes:0,showDate:Date.now(),recommendIdx:0,recommendDate:null};let r={};return r=s?{...i,...s}:i,this.set(e,t,r),r};set=(e,t,s)=>{b(`#push-status#${e}#${t||""}`,s)}}const A=function(e){if("t"===e)return!0;if("f"===e)return!1;e="("+e.replace(/&+/g,"&").replace(/\|+/g,"|")+")";const t=[];for(let s=0;s<e.length;s++){let i,r;t.push(e[s]);let n=[];for(;")"===e[s]&&"("!==i&&(i=t.pop(),void 0!==i);)["&","|"].includes(i)?r=i:["t","f",!0,!1].includes(i)&&n.push(i);if(r&&n.length){const e=n.reduce(((e,t)=>{const s=format(e),i=format(t);return"&"===r?s&&i:"|"===r?s||i:void 0}),format(n[0]));t.push(e)}}return t.pop()},x=e=>{const t=e.substr(0,4),s=e.substr(4,2),i=e.substr(6,2);return new Date(`${t}-${s}-${i}`).getTime()};class P{constructor(){U("GioMarketing 初始化中...","info"),this.popupUserStore=new k,this.popupStore=new C,this.isRequested=!1,this.retryTimes=0,this.isPreview=!1,this.isConsuming=!1,this.originData=[],this.triggerConditions=[],this.unResolvedEvents=[],this.renderQueue=[],this.isRendering=!1,this.renderFn=void 0,s&&(s.on("onComposeAfter",(({composedEvent:e})=>this.persistentEvents(e))),s.on("USERID_UPDATE",(()=>{this.activateInit()})))}activateInit=()=>{this.saveOriginData([]),this.isRequested=!1;const e=this.previewVerify();I(e)?(this.getMarketingData(),clearTimeout(this.t),this.t=null,this.t=setTimeout((()=>{this.activateInit(),clearTimeout(this.t)}),18e5)):(this.isPreview=!0,this.getPreviewMarketingData(e))};previewVerify=()=>{const e=_.parse(t.eventHooks.currentPage.query||"");if(e&&e.scene&&e.scene.gioMessageId){const t={s:"splash",pw:"popupWindow",p:"push",b:"banner",ab:"abTest"};return{messageId:e.scene.gioMessageId,msgType:t[e.scene.mt||""]}}return{}};emitterDestroy=()=>s.all.clear();persistentEvents=e=>{switch(e.t||e.eventType){case"vst":case"vstr":case"ppl":case"VISIT":case"LOGIN_USER_ATTRIBUTES":this.userVariable(e);break;case"cstm":case"CUSTOM":(I(this.triggerConditions)||this.triggerConditions.includes(e.n||e.eventName))&&(this.cstmVariable(e),!I(this.originData)&&this.isRequested?this.consumeUnResolvedEvents(e):this.unResolvedEvents.push(e))}};userVariable=e=>{const{userId:t}=n,s=e.var||e.attributes,i=this.popupUserStore.get("userAttrs",t)||[];s&&this.popupUserStore.set("userAttrs",[...i,...$(s).map((e=>({key:e,value:s[e]})))],t)};cstmVariable=e=>{const{userId:t}=n,s=e.var||e.attributes,i=this.popupUserStore.get("triggerAttrs",t)||[];this.popupUserStore.set("triggerAttrs",[...i,{key:e.n||e.eventName,value:"",event_variable:s?$(s).map((e=>({key:e,value:s[e]}))):[]}],t)};persistentGroupingData=({bu:e,bcs:t})=>{this.popupUserStore.set("bu",e),this.popupUserStore.set("bcs",t)};generateURL=()=>{const{uid:e,userId:t,gioId:s}=n,i={bu:this.popupUserStore.get("bu",t),bcs:this.popupUserStore.get("bcs",t),u:e,cs:t,gioId:s};let r=`${F}?url_scheme=${l}&enableRecommend=1`;return $(i).forEach((e=>r+=i[e]?`&${e}=${i[e]}`:"")),r};getMarketingData=()=>{T({url:this.generateURL(),header:{"X-Timezone":(((new Date).toString()||"").match(/GMT\+[0-9]+/g)||[])[0]},success:({data:e,statusCode:t})=>{200!==t||I(e)||(this.persistentGroupingData(e.idMappings||{}),this.isPreview=!!e.previewStatus,this.isPreview?this.getPreviewMarketingData(e.previewStatus):this.saveOriginData(e.popupWindows),this.isRequested=!0,this.consumeUnResolvedEvents())},fail:()=>{this.retryTimes+=1,3>this.retryTimes&&this.getMarketingData()},timeout:5e3})};getPreviewMarketingData=({messageId:e,msgType:t})=>{T({url:`${F}/preview?url_scheme=${l}&message_id=${e}&msgType=${t}${"cdp"===i?"&enableRecommend=1":""}`,success:({data:e,statusCode:t})=>{200!==t||I(e)||(this.persistentGroupingData(e.idMappings||{}),this.isRequested=!0)},fail:()=>{this.retryTimes+=1,3>this.retryTimes&&this.getPreviewMarketingData({messageId:e,msgType:t})},timeout:5e3})};verifyOnline=(e,t)=>{const{userId:s}=n;return this.validAbNeedShow(e)&&this.validTimeRange(e)&&this.validTimes(e,s)&&this.validTriggerCd(e,s)&&this.validUserFilter(e)&&this.validTriggerFilter(e,t)};verifyPreview=(e,t)=>this.validAbNeedShow(e)&&this.validTriggerFilter(e,t);validAbNeedShow(e){const t=!(e.abTest&&e.abTest.ctrlGroup);return M(`${e.name} validAbNeedShow ${t}`),t}validTimeRange(e){const t=Date.now(),s=(e.rule.startAt||0)<=t&&t<(e.rule.endAt||t+1);return M(`${e.name} validTimeRange ${s}`),s}validTimes(e,t){const s=this.popupStore.get(e.id,t).showTimes<e.rule.limit;return M(`${e.name} validTimes ${s}`),s}validTriggerCd(e,t){const s=this.popupStore.get(e.id,t).showDate<Date.now();return M(`${e.name} validTriggerCd  ${s}`),s}validUserFilter(e){let t;if(e.rule.filters&&e.rule.filters.expr&&e.rule.filters.exprs&&e.rule.filters.exprs.length){const s=this.getUserFilterMaps(e.rule.filters.exprs),i=this.getBoolExprs(s,e.rule.filters.expr);t=A(i)}else t=!0;return M(`${e.name} validUserFilter ${t}`),t}validTriggerFilter(e,t){let s;if(e.rule.triggerFilter&&e.rule.triggerFilter.conditionExpr&&e.rule.triggerFilter.conditions&&e.rule.triggerFilter.conditions.length){const i=this.getTriggerFilterMaps(t,e.rule.triggerFilter.conditions),r=this.getBoolExprs(i,e.rule.triggerFilter.conditionExpr);s=A(r)}else s=!0;return M(`${e.name} validTriggerFilter ${s}`),s}mergeUserAttrs(e){let t={};return e.forEach((e=>{t[e.key]=e})),Object.values(t)}getUserFilterMaps(e){const{userId:t}=n,s=this.mergeUserAttrs(this.popupUserStore.get("userAttrs",t)||[]);return e.map((e=>({symbol:e.symbol,result:s.some(this.validUserFilterExpression.bind(this,e))?"t":"f"})))}getTriggerFilterMaps(e,t){const{userId:s}=n,i=this.popupUserStore.get("triggerAttrs",s)||[],r=e.eventName||e.n;return t.map((e=>{const t=i.filter((t=>t.key===e.key));return{symbol:e.alias,result:r===e.key&&t.length&&this.validTriggerFilterExpression(e,t)?"t":"f"}}))}getBoolExprs(e,t){return e.reduce(((e,t)=>e.replace(RegExp(t.symbol,"g"),t.result)),t)}validUserFilterExpression(e,t){return t.key===e.key&&this.validExpression(t.value,e)}validTriggerFilterExpression(e,t){const s=e.dimFilters||[];return{count:()=>{const i=this.validDimFilters(t,s).length;return this.validExpression(i,e)},sum:()=>{const i=e.attribute;if(!i)return!1;let r=0;if(s.length){const e=this.validDimFilters(t,s);r=this.sumAttribute(e,i)}else r=this.sumAttribute(t,i);return this.validExpression(r,e)}}[e.aggregator]()||!1}validDimFilters(e,t=[]){return t.length?e.filter((e=>{const s=e.event_variable||[];return t.every((e=>s.some((t=>this.validExpression(t.value,e)))))})):e}sumAttribute(e,t){let s=0;return e.forEach((e=>{(e.event_variable||[]).forEach((e=>{e.key===t&&(s+=Number(e.value)||0)}))})),s}validExpression(e,t){let s=t.values;return"date"===t.valueType&&(s=s.map(x),e=x(e)),"=="===t.op?e==s[0]:"<"===t.op?e<s[0]:">"===t.op?e>s[0]:"<="===t.op?e<=s[0]:">="===t.op?e>=s[0]:"!="===t.op?e!=s[0]:"between"===t.op?e<=s[1]&&e>=s[0]:"in"===t.op?s.find((t=>t===e)):"not in"===t.op&&!s.find((t=>t===e))}saveOriginData=e=>{this.originData=e.sort(((e,t)=>t.updateAt-e.updateAt)),this.originData.forEach((e=>{const t=e?.rule?.triggerFilter?.conditions??[];I(t)||t.forEach((e=>{this.triggerConditions.push(e.key)}))})),this.triggerConditions=Array.from(new Set(S(this.triggerConditions)))};consumeUnResolvedEvents=e=>{let t={};I(e)||this.unResolvedEvents.push(e),I(this.unResolvedEvents)||(t=this.unResolvedEvents.shift());const s=t.n||t.eventName||"";I(t)||this.isConsuming||I(this.originData)||0===s.indexOf("in_app_message_")||(this.isConsuming=!0,this.eventVerify(t))};eventVerify=e=>{const t=w(this.originData.filter((t=>this.isPreview?this.verifyPreview(t,e):this.verifyOnline(t,e))))||{};if(I(t))this.isConsuming=!1,this.consumeUnResolvedEvents();else if(t.rule&&(t.rule.triggerDelay||0)>0){const e=setTimeout((()=>{this.pushRenderQueue(t),clearTimeout(e)}),1e3*message.rule.triggerDelay)}else this.pushRenderQueue(t)};pushRenderQueue=e=>{this.renderQueue.push(e),this.dispatchPopRender()};dispatchPopRender=()=>{this.isRendering=!0;const e=this.renderQueue.shift();e&&this.renderFn&&this.renderFn(e)};getTargetConfig=e=>{if(!this.isIntelligent(e))return e.contentMetadata.components[0].config;const t=userStorage.get("cs1"),s=e.contentMetadata.components[0].recommendDate,i=e.contentMetadata.components[0].recommendList,r=this.get(e.id,t);s!==r.recommendDate&&(r.recommendIdx=0,r.recommendDate=s);const n=i[r.recommendIdx%i.length];return r.recommendIdx=r.recommendIdx+1,this.popupStore.set(e.id,t,r),n};isIntelligent=e=>{const t=e.contentMetadata.components[0].recommendList;return y(t)&&t.length>0};trackImp=(e={})=>{this.isPreview||g("in_app_message_imp",{in_app_message_name:e.name});const{userId:t}=n,s=this.popupStore.get(e.id,t);s.showTimes+=1;const i=new Date(Date.now()+1e3*((e.rule?e.rule.triggerCd:0)||0));i.setHours(0),i.setMinutes(0),i.setSeconds(0),s.showDate=i.getTime(),this.popupStore.set(e.id,t,s)};trackClose=(e={})=>{this.isPreview||g("in_app_message_close",{in_app_message_name:e.name}),this.isRendering=!1,this.dispatchPopRender()};handleTarget=e=>{if(this.isPreview||g("in_app_message_cmp_click",{in_app_message_name:e.name}),!this.isIntelligent(e)){const{userId:t}=n,s=this.popupStore.get(e.id,t);s.showTimes+=9999,this.popupStore.set(e.id,t,s)}const t=e.targetConfig&&e.targetConfig.target?e.targetConfig.target["growing."+l]:void 0;t&&this.navigateDistribute(t)};navigateDistribute=e=>{const t=/^MINP::(.*?)::(.*)/,s=["develop","trial","release"];if(t.test(e)){const[i,r,n]=e.match(t);f({appId:r,path:n,envVersion:s.includes(this.envVersion)?this.envVersion:"release"})}else v({url:/^https?:\/\//.test(e)?`${this.h5Page}?url=${e}`:e})}}let O={};Component({props:{h5Page:{type:String,value:"/pages/h5/h5"},envVersion:{type:String,value:"release"}},data:{message:void 0,imageUrl:void 0,visible:!1},didUnmount(){this.setData({message:void 0,imageUrl:void 0,visible:!1}),O&&O.emitterDestroy(),O=void 0},didMount(){if(e.gioSDKInitialized){O=new P;const{envVersion:e,h5Page:t}=this.props;O.envVersion=e,O.h5Page=t,O.renderFn=e=>{const t=O.getTargetConfig(e);c({src:t.src,success:s=>{this.setData({message:Object.assign({targetConfig:t},e),visible:!0,imageUrl:s.path}),O.trackImp(e)},fail:()=>{O.isRendering=!1,O.dispatchPopRender()},complete:()=>{O.isConsuming=!1,O.consumeUnResolvedEvents()}})};const s="saas"===i?{t:"cstm",n:"appOpen"}:{eventType:"CUSTOM",eventName:"appOpen"};O.persistentEvents(s),O.activateInit(),U("GioMarketing 初始化完成!","success")}},methods:{hideModal(){this.setData({visible:!1})},onClose(){this.hideModal(),O&&O.trackClose(this.data.message)},onTapTarget(){O&&O.handleTarget(this.data.message),this.hideModal()}}});
