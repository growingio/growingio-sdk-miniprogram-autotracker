var e,t;(global||$global).gTouchVersion="3.8.0";const s=(null===(e=getApp())||void 0===e?void 0:e.__gio__)||(null===(t=global||$global)||void 0===t?void 0:t.__gio__)||{},{dataStore:i,emitter:r,gioEnvironment:n,minipInstance:a,userStore:o,utils:l,vdsConfig:g,track:u}=s;let{appId:p,debug:h,gtouchHost:d,projectId:c,scheme:m}=g||{};const{getImageInfo:v,getStorageSync:f,navigateTo:T,navigateToMiniProgram:b,request:S,setStorageSync:D}=a||{getImageInfo:()=>{},getStorageSync:()=>{},navigateTo:()=>{},navigateToMiniProgram:()=>{},request:()=>{},setStorageSync:()=>{}},{endsWith:w,head:y,isArray:I,isEmpty:E,isString:$,keys:_,qs:R,startsWith:U}=l||{},M=(e,t)=>{console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},F=e=>h&&console.log("[GrowingIO Debug]:",JSON.stringify(e,null,2));s&&s.gioSDKInitialized||M("未集成或未初始化加载 Gio小程序SDK! GioMarketing 加载失败！","error");let k="";"saas"===n?k=`https://messages.growingio.com/v3/${c}/notifications`:d&&$(d)?(m?w(toString(m),"://")||(m+="://"):m="https://",U(d,"http")&&(d=d.substring(d.indexOf("://")+(w(toString(m),"://")?4:1))),k=`${m}${d}/marketing/automation/v3/${c}/notifications`):M("如果您需要使用触达功能，请在 Gio小程序SDK 中配置 gtouchHost!","info");class x{get=(e,t)=>{const s=f(`push-user-status#${e}${t?"#"+t:""}`)||{},i="userAttrs"===e?432e7:864e5;return Date.now()>s.startAt+i?(this.set(e,0,t),0):s.value};set=(e,t,s)=>{const i=new Date;i.setHours(0),i.setMinutes(0),i.setSeconds(0),D(`push-user-status#${e}${s?"#"+s:""}`,{startAt:i.getTime(),value:t})}}class A{get=(e,t)=>{const s=f(`#push-status#${e}#${t||""}`)||{},i={showTimes:0,showDate:Date.now(),recommendIdx:0,recommendDate:null};let r={};return r=s?{...i,...s}:i,this.set(e,t,r),r};set=(e,t,s)=>{D(`#push-status#${e}#${t||""}`,s)}}const P=function(e){if("t"===e)return!0;if("f"===e)return!1;e="("+e.replace(/&+/g,"&").replace(/\|+/g,"|")+")";const t=[];for(let s=0;s<e.length;s++){let i,r;t.push(e[s]);let n=[];for(;")"===e[s]&&"("!==i&&(i=t.pop(),void 0!==i);)["&","|"].includes(i)?r=i:["t","f",!0,!1].includes(i)&&n.push(i);if(r&&n.length){const e=n.reduce(((e,t)=>{const s=format(e),i=format(t);return"&"===r?s&&i:"|"===r?s||i:void 0}),format(n[0]));t.push(e)}}return t.pop()},C=e=>{const t=e.substr(0,4),s=e.substr(4,2),i=e.substr(6,2);return new Date(`${t}-${s}-${i}`).getTime()};class O{constructor(){M("GioMarketing 初始化中...","info"),this.popupUserStore=new x,this.popupStore=new A,this.isRequested=!1,this.retryTimes=0,this.isPreview=!1,this.isConsuming=!1,this.originData=[],this.unResolvedEvents=[],this.renderQueue=[],this.isRendering=!1,this.renderFn=void 0,r&&(r.on("onComposeAfter",(({composedEvent:e})=>this.persistentEvents(e))),r.on("USERID_UPDATE",(()=>{this.activateInit()})))}activateInit=()=>{this.saveOriginData([]),this.isRequested=!1;const e=this.previewVerify();E(e)?(this.getMarketingData(),clearTimeout(this.t),this.t=null,this.t=setTimeout((()=>{this.activateInit(),clearTimeout(this.t)}),18e5)):(this.isPreview=!0,this.getPreviewMarketingData(e))};previewVerify=()=>{const e=R.parse(i.eventHooks.currentPage.query||"");if(e&&e.scene&&e.scene.gioMessageId){const t={s:"splash",pw:"popupWindow",p:"push",b:"banner",ab:"abTest"};return{messageId:e.scene.gioMessageId,msgType:t[e.scene.mt||""]}}return{}};emitterDestroy=()=>r.all.clear();persistentEvents=e=>{switch(e.t||e.eventType){case"vst":case"vstr":case"ppl":case"VISIT":case"LOGIN_USER_ATTRIBUTES":this.userVariable(e);break;case"cstm":case"CUSTOM":this.cstmVariable(e),!E(this.originData)&&this.isRequested?this.consumeUnResolvedEvents(e):this.unResolvedEvents.push(e)}};userVariable=e=>{const{userId:t}=o,s=e.var||e.attributes,i=this.popupUserStore.get("userAttrs",t)||[];s&&this.popupUserStore.set("userAttrs",[...i,..._(s).map((e=>({key:e,value:s[e]})))],t)};cstmVariable=e=>{const{userId:t}=o,s=e.var||e.attributes,i=this.popupUserStore.get("triggerAttrs",t)||[];this.popupUserStore.set("triggerAttrs",[...i,{key:e.n||e.eventName,value:"",event_variable:s?_(s).map((e=>({key:e,value:s[e]}))):[]}],t)};persistentGroupingData=({bu:e,bcs:t})=>{this.popupUserStore.set("bu",e),this.popupUserStore.set("bcs",t)};generateURL=()=>{const{uid:e,userId:t,gioId:s}=o,i={bu:this.popupUserStore.get("bu",t),bcs:this.popupUserStore.get("bcs",t),u:e,cs:t,gioId:s};let r=`${k}?url_scheme=${p}&enableRecommend=1`;return _(i).forEach((e=>r+=i[e]?`&${e}=${i[e]}`:"")),r};getMarketingData=()=>{S({url:this.generateURL(),header:{"X-Timezone":(((new Date).toString()||"").match(/GMT\+[0-9]+/g)||[])[0]},success:({data:e,statusCode:t})=>{200!==t||E(e)||(this.persistentGroupingData(e.idMappings||{}),this.isPreview=!!e.previewStatus,this.isPreview?this.getPreviewMarketingData(e.previewStatus):this.saveOriginData(e.popupWindows),this.isRequested=!0,this.consumeUnResolvedEvents())},fail:()=>{this.retryTimes+=1,3>this.retryTimes&&this.getMarketingData()},timeout:5e3})};getPreviewMarketingData=({messageId:e,msgType:t})=>{S({url:`${k}/preview?url_scheme=${p}&message_id=${e}&msgType=${t}${"cdp"===n?"&enableRecommend=1":""}`,success:({data:e,statusCode:t})=>{200!==t||E(e)||(this.persistentGroupingData(e.idMappings||{}),this.isRequested=!0)},fail:()=>{this.retryTimes+=1,3>this.retryTimes&&this.getPreviewMarketingData({messageId:e,msgType:t})},timeout:5e3})};verifyOnline=(e,t)=>{const{userId:s}=o;return this.validAbNeedShow(e)&&this.validTimeRange(e)&&this.validTimes(e,s)&&this.validTriggerCd(e,s)&&this.validUserFilter(e)&&this.validTriggerFilter(e,t)};verifyPreview=(e,t)=>this.validAbNeedShow(e)&&this.validTriggerFilter(e,t);validAbNeedShow(e){const t=!(e.abTest&&e.abTest.ctrlGroup);return F(`${e.name} validAbNeedShow ${t}`),t}validTimeRange(e){const t=Date.now(),s=(e.rule.startAt||0)<=t&&t<(e.rule.endAt||t+1);return F(`${e.name} validTimeRange ${s}`),s}validTimes(e,t){const s=this.popupStore.get(e.id,t).showTimes<e.rule.limit;return F(`${e.name} validTimes ${s}`),s}validTriggerCd(e,t){const s=this.popupStore.get(e.id,t).showDate<Date.now();return F(`${e.name} validTriggerCd  ${s}`),s}validUserFilter(e){let t;if(e.rule.filters&&e.rule.filters.expr&&e.rule.filters.exprs&&e.rule.filters.exprs.length){const s=this.getUserFilterMaps(e.rule.filters.exprs),i=this.getBoolExprs(s,e.rule.filters.expr);t=P(i)}else t=!0;return F(`${e.name} validUserFilter ${t}`),t}validTriggerFilter(e,t){let s;if(e.rule.triggerFilter&&e.rule.triggerFilter.conditionExpr&&e.rule.triggerFilter.conditions&&e.rule.triggerFilter.conditions.length){const i=this.getTriggerFilterMaps(t,e.rule.triggerFilter.conditions),r=this.getBoolExprs(i,e.rule.triggerFilter.conditionExpr);s=P(r)}else s=!0;return F(`${e.name} validTriggerFilter ${s}`),s}mergeUserAttrs(e){let t={};return e.forEach((e=>{t[e.key]=e})),Object.values(t)}getUserFilterMaps(e){const{userId:t}=o,s=this.mergeUserAttrs(this.popupUserStore.get("userAttrs",t)||[]);return e.map((e=>({symbol:e.symbol,result:s.some(this.validUserFilterExpression.bind(this,e))?"t":"f"})))}getTriggerFilterMaps(e,t){const{userId:s}=o,i=this.popupUserStore.get("triggerAttrs",s)||[],r=e.eventName||e.n;return t.map((e=>{const t=i.filter((t=>t.key===e.key));return{symbol:e.alias,result:r===e.key&&t.length&&this.validTriggerFilterExpression(e,t)?"t":"f"}}))}getBoolExprs(e,t){return e.reduce(((e,t)=>e.replace(RegExp(t.symbol,"g"),t.result)),t)}validUserFilterExpression(e,t){return t.key===e.key&&this.validExpression(t.value,e)}validTriggerFilterExpression(e,t){const s=e.dimFilters||[];return{count:()=>{const i=this.validDimFilters(t,s).length;return this.validExpression(i,e)},sum:()=>{const i=e.attribute;if(!i)return!1;let r=0;if(s.length){const e=this.validDimFilters(t,s);r=this.sumAttribute(e,i)}else r=this.sumAttribute(t,i);return this.validExpression(r,e)}}[e.aggregator]()||!1}validDimFilters(e,t=[]){return t.length?e.filter((e=>{const s=e.event_variable||[];return t.every((e=>s.some((t=>this.validExpression(t.value,e)))))})):e}sumAttribute(e,t){let s=0;return e.forEach((e=>{(e.event_variable||[]).forEach((e=>{e.key===t&&(s+=Number(e.value)||0)}))})),s}validExpression(e,t){let s=t.values;return"date"===t.valueType&&(s=s.map(C),e=C(e)),"=="===t.op?e==s[0]:"<"===t.op?e<s[0]:">"===t.op?e>s[0]:"<="===t.op?e<=s[0]:">="===t.op?e>=s[0]:"!="===t.op?e!=s[0]:"between"===t.op?e<=s[1]&&e>=s[0]:"in"===t.op?s.find((t=>t===e)):"not in"===t.op&&!s.find((t=>t===e))}saveOriginData=e=>this.originData=e.sort(((e,t)=>t.updateAt-e.updateAt));consumeUnResolvedEvents=e=>{let t={};E(e)||this.unResolvedEvents.push(e),E(this.unResolvedEvents)||(t=this.unResolvedEvents.shift());const s=t.n||t.eventName||"";E(t)||this.isConsuming||E(this.originData)||0===s.indexOf("in_app_message_")||(this.isConsuming=!0,this.eventVerify(t))};eventVerify=e=>{const t=y(this.originData.filter((t=>this.isPreview?this.verifyPreview(t,e):this.verifyOnline(t,e))))||{};if(E(t))this.isConsuming=!1,this.consumeUnResolvedEvents();else if(t.rule&&(t.rule.triggerDelay||0)>0){const e=setTimeout((()=>{this.pushRenderQueue(t),clearTimeout(e)}),1e3*message.rule.triggerDelay)}else this.pushRenderQueue(t)};pushRenderQueue=e=>{this.renderQueue.push(e),this.dispatchPopRender()};dispatchPopRender=()=>{this.isRendering=!0;const e=this.renderQueue.shift();e&&this.renderFn&&this.renderFn(e)};getTargetConfig=e=>{if(!this.isIntelligent(e))return e.contentMetadata.components[0].config;const t=userStorage.get("cs1"),s=e.contentMetadata.components[0].recommendDate,i=e.contentMetadata.components[0].recommendList,r=this.get(e.id,t);s!==r.recommendDate&&(r.recommendIdx=0,r.recommendDate=s);const n=i[r.recommendIdx%i.length];return r.recommendIdx=r.recommendIdx+1,this.popupStore.set(e.id,t,r),n};isIntelligent=e=>{const t=e.contentMetadata.components[0].recommendList;return I(t)&&t.length>0};trackImp=(e={})=>{this.isPreview||u("in_app_message_imp",{in_app_message_name:e.name});const{userId:t}=o,s=this.popupStore.get(e.id,t);s.showTimes+=1;const i=new Date(Date.now()+1e3*((e.rule?e.rule.triggerCd:0)||0));i.setHours(0),i.setMinutes(0),i.setSeconds(0),s.showDate=i.getTime(),this.popupStore.set(e.id,t,s)};trackClose=(e={})=>{this.isPreview||u("in_app_message_close",{in_app_message_name:e.name}),this.isRendering=!1,this.dispatchPopRender()};handleTarget=e=>{if(this.isPreview||u("in_app_message_cmp_click",{in_app_message_name:e.name}),!this.isIntelligent(e)){const{userId:t}=o,s=this.popupStore.get(e.id,t);s.showTimes+=9999,this.popupStore.set(e.id,t,s)}const t=e.targetConfig&&e.targetConfig.target?e.targetConfig.target["growing."+p]:void 0;t&&this.navigateDistribute(t)};navigateDistribute=e=>{const t=/^MINP::(.*?)::(.*)/,s=["develop","trial","release"];if(t.test(e)){const[i,r,n]=e.match(t);b({appId:r,path:n,envVersion:s.includes(this.envVersion)?this.envVersion:"release"})}else T({url:/^https?:\/\//.test(e)?`${this.h5Page}?url=${e}`:e})}}let V={};Component({props:{h5Page:{type:String,value:"/pages/h5/h5"},envVersion:{type:String,value:"release"}},data:{message:void 0,imageUrl:void 0,visible:!1},didUnmount(){this.setData({message:void 0,imageUrl:void 0,visible:!1}),V&&V.emitterDestroy(),V=void 0},didMount(){if(s.gioSDKInitialized){V=new O;const{envVersion:e,h5Page:t}=this.props;V.envVersion=e,V.h5Page=t,V.renderFn=e=>{const t=V.getTargetConfig(e);v({src:t.src,success:s=>{this.setData({message:Object.assign({targetConfig:t},e),visible:!0,imageUrl:s.path}),V.trackImp(e)},fail:()=>{V.isRendering=!1,V.dispatchPopRender()},complete:()=>{V.isConsuming=!1,V.consumeUnResolvedEvents()}})};const s="saas"===n?{t:"cstm",n:"appOpen"}:{eventType:"CUSTOM",eventName:"appOpen"};V.persistentEvents(s),V.activateInit(),M("GioMarketing 初始化完成!","success")}},methods:{hideModal(){this.setData({visible:!1})},onClose(){this.hideModal(),V&&V.trackClose(this.data.message)},onTapTarget(){V&&V.handleTarget(this.data.message),this.hideModal()}}});
