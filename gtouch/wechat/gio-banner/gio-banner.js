var e,t;(global||$global).gTouchVersion="3.8.0";let{gdp:a,gio:r}=global||$global;r=a||r||function(){};const n=(null===(e=getApp())||void 0===e?void 0:e.__gio__)||(null===(t=global||$global)||void 0===t?void 0:t.__gio__)||{},{emitter:i,gioEnvironment:s,minipInstance:o,userStore:g,utils:l,vdsConfig:c}=n;let{appId:h,gtouchHost:u,projectId:d,scheme:m}=c||{};const{getStorageSync:p,navigateTo:b,navigateToMiniProgram:v,request:y,setStorageSync:D}=o||{getImageInfo:()=>{},getStorageSync:()=>{},navigateTo:()=>{},navigateToMiniProgram:()=>{},request:()=>{},setStorageSync:()=>{}},{endsWith:S,has:f,isArray:_,isEmpty:T,isFunction:I,isNumber:w,isString:$,startsWith:B}=l||{},k=(e,t)=>{console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")};n&&n.gioSDKInitialized||k("未集成或未初始化加载 Gio小程序SDK! GioBanner 加载失败！","error");let K="";"saas"===s?K=`https://messages.growingio.com/v3/${d}/notifications`:u&&$(u)?(m?S(toString(m),"://")||(m+="://"):m="https://",B(u,"http")&&(u=u.substring(u.indexOf("://")+(S(toString(m),"://")?4:1))),K=`${m}${u}/marketing/automation/v3/${d}/notifications`):k("如果您需要使用触达功能，请在 Gio小程序SDK 中配置 gtouchHost!","info");const x={id:"default",content:"",name:"default",rule:{target:""}};class P{get=(e,t)=>{const a=p(`push-user-status#${e}${t?"#"+t:""}`)||{};return Date.now()>a.startAt+432e7?(this.set(e,0,t),0):a.value};set=(e,t,a)=>{const r=new Date;r.setHours(0),r.setMinutes(0),r.setSeconds(0),D(`push-user-status#${e}${a?"#"+a:""}`,{startAt:r.getTime(),value:t})}}class C{get=(e,t)=>p(`#gio-banner#${e}#${t||""}`)||[];set=(e,t,a)=>{D(`#gio-banner#${e}#${t||""}`,a)}}class R{constructor(){k("GioBanner 初始化中...","info"),this.bannerUserStore=new P,this.bannerStore=new C,this.bannerKey="",this.retryTimes=0,this.originData=[],this.trackedImg=[],this.renderFn=void 0,i&&i.on("USERID_UPDATE",(()=>{this.activateInit()}))}activateInit=()=>{this.saveOriginData([]),this.getBannerData(),clearTimeout(this.t),this.t=null,this.t=setTimeout((()=>{this.activateInit(),clearTimeout(this.t)}),18e5)};emitterDestroy=()=>i.all.clear();persistentGroupingData=({bu:e,bcs:t})=>{this.bannerUserStore.set("bu",e),this.bannerUserStore.set("bcs",t)};generateURL=()=>{const{uid:e,userId:t}=g,a=this.bannerUserStore.get("bu",t),r=this.bannerUserStore.get("bcs",t);let n=`${K}?url_scheme=${h}`;return n+=a?"&bu="+a:e?"&u="+e:"",n+=r?"&bcs="+r:t?"&cs="+t:"",n};getBannerData=e=>{e||this.abnormalRender(),y({url:this.generateURL(),header:{"X-Timezone":(((new Date).toString()||"").match(/GMT\+[0-9]+/g)||[])[0]},success:({data:t,statusCode:a})=>{200!==a||T(t)||(this.persistentGroupingData(t.idMappings||{}),this.saveOriginData(t.banners),I(e)&&e(this.originData))},fail:()=>{this.retryTimes+=1,3>this.retryTimes?this.getBannerData():e||this.abnormalRender("error")},timeout:5e3})};saveOriginData=e=>{if(_(e)&&!T(e)){const t=e.find((e=>e.key===this.bannerKey));if(!T(t)&&!_(t.messages)){const e=(t.messages||[]).filter((e=>this.verifyTimeRange(e))).sort(((e,t)=>this.verifySorter(e,t))).filter(((e,t,a)=>a.indexOf(e)===t));t.messages=e}if(this.originData=t,this.renderFn){this.renderFn(this.originData.messages);const{userId:e}=g;this.bannerStore.set(this.bannerKey,e,this.originData.messages)}}};verifyTimeRange=e=>{const t=Date.now();return(e.rule.startAt||0)<=t&&t<(e.rule.endAt||t+1)};verifySorter(e,t){return e.index!==t.index?e.index-t.index:e.priority!==t.priority?t.priority-e.priority:t.updateAt-e.updateAt}abnormalRender=(e="default")=>{const{userId:t}=g,a=this.bannerStore.get(this.bannerKey,t);T(a)?this.renderFn([{...x,id:"gioDefault",name:"gioDefault",content:("default"===e?this.placeholderDrawable:this.errorReplaceDrawable)||""}]):this.renderFn(a)};gatherTrackParams=e=>({in_app_message_name:e.name,gio_message_type:"banner",gio_message_id:e.id,gio_message_index:e.index,gio_campaign_key:this.bannerKey});handleChange=e=>{let t;if(t=f(e.detail,"current")?e.detail.current:e.target.dataset.current,w(t)&&!this.trackedImg.includes(t)&&this.originData.messages){const e=this.originData.messages[t];r("track","in_app_message_imp",this.gatherTrackParams(e)),this.trackedImg.push(t)}};handleTarget=e=>{const t=e.target.dataset.message;t&&"gioDefault"!==t.id&&(r("track","in_app_message_cmp_click",this.gatherTrackParams(t)),t.rule.target&&this.navigateDistribute(t.rule.target))};navigateDistribute=e=>{const t=/^MINP::(.*?)::(.*)/,a=["develop","trial","release"];if(t.test(e)){const[r,n,i]=e.match(t);v({appId:n,path:i,envVersion:a.includes(this.envVersion)?this.envVersion:"release"})}else b({url:/^https?:\/\//.test(e)?`${this.h5Page}?url=${e}`:e})}}let F={};(global||$global).getBannerMessages=e=>(T(F)&&(F=new R,F.bannerKey=e),new Promise((e=>{F.getBannerData((t=>{_(t.messages)&&!T(t.messages)?e({...t,messages:t.messages.map((e=>({id:e.id,index:e.index,name:e.name||"",imageUrl:e.content||"",summary:e.summary||"",params:e.bannerParamConfig||[],onShow(){F.onTrackImp(e)},onClick(){F.onClickTarget(e)}})))}):e({...t,messages:[]})}))}))),Component({properties:{bannerKey:String,indicatorDots:{type:Boolean,value:!0},indicatorColor:{type:String,value:"rgba(0,0,0,0.3)"},indicatorActiveColor:{type:String,value:"#000"},autoplay:{type:Boolean,value:!0},interval:{type:Number,value:5e3},duration:{type:Number,value:500},circular:{type:Boolean,value:!0},vertical:{type:Boolean,value:!1},previousMargin:{type:String,value:"0px"},nextMargin:{type:String,value:"0px"},easingFunction:{type:String,value:"default"},placeholderDrawable:String,errorReplaceDrawable:String,h5Page:{type:String,value:"/pages/h5/h5"},envVersion:{type:String,value:"release"}},data:{banners:void 0},lifetimes:{attached(){if(n.gioSDKInitialized){F=new R;const{bannerKey:e,placeholderDrawable:t,errorReplaceDrawable:a,h5Page:r,envVersion:n}=this.properties;F.bannerKey=e,F.h5Page=r,F.envVersion=n,F.placeholderDrawable=t,F.errorReplaceDrawable=a,F.renderFn=e=>{this.setData({banners:e})},e?(F.activateInit(),k("GioBanner 初始化完成!","success")):k("GioBanner 初始化失败！请填写 bannerKey!","error")}},detached(){this.setData({banners:void 0}),F&&F.emitterDestroy(),banner=void 0}},methods:{onImgLoad(e){0===e.target.dataset.current&&F&&F.handleChange(e)},onChange(e){F&&F.handleChange(e)},onTapTarget(e){F&&F.handleTarget(e)}}});
