(global||$global).gTouchVersion="3.8.1";let{gdp:e,gio:t}=global||$global;t=e||t||function(){};const a=getApp()?.__gio__||(global||$global)?.__gio__||{},{emitter:r,gioEnvironment:n,minipInstance:i,userStore:s,utils:o,vdsConfig:g}=a;let{appId:l,gtouchHost:c,projectId:h,scheme:u}=g||{};const{getStorageSync:d,navigateTo:m,navigateToMiniProgram:p,request:b,setStorageSync:v}=i||{getImageInfo:()=>{},getStorageSync:()=>{},navigateTo:()=>{},navigateToMiniProgram:()=>{},request:()=>{},setStorageSync:()=>{}},{endsWith:y,has:D,isArray:S,isEmpty:f,isFunction:_,isNumber:T,isString:I,startsWith:w}=o||{},$=(e,t)=>{console.log("%c[GrowingIO]："+e,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")};a&&a.gioSDKInitialized||$("未集成或未初始化加载 Gio小程序SDK! GioBanner 加载失败！","error");let B="";"saas"===n?B=`https://messages.growingio.com/v3/${h}/notifications`:c&&I(c)?(u?y(toString(u),"://")||(u+="://"):u="https://",w(c,"http")&&(c=c.substring(c.indexOf("://")+(y(toString(u),"://")?4:1))),B=`${u}${c}/marketing/automation/v3/${h}/notifications`):$("如果您需要使用触达功能，请在 Gio小程序SDK 中配置 gtouchHost!","info");const k={id:"default",content:"",name:"default",rule:{target:""}};class K{get=(e,t)=>{const a=d(`push-user-status#${e}${t?"#"+t:""}`)||{};return Date.now()>a.startAt+432e7?(this.set(e,0,t),0):a.value};set=(e,t,a)=>{const r=new Date;r.setHours(0),r.setMinutes(0),r.setSeconds(0),v(`push-user-status#${e}${a?"#"+a:""}`,{startAt:r.getTime(),value:t})}}class x{get=(e,t)=>d(`#gio-banner#${e}#${t||""}`)||[];set=(e,t,a)=>{v(`#gio-banner#${e}#${t||""}`,a)}}class P{constructor(){$("GioBanner 初始化中...","info"),this.bannerUserStore=new K,this.bannerStore=new x,this.bannerKey="",this.retryTimes=0,this.originData=[],this.trackedImg=[],this.renderFn=void 0,r&&r.on("USERID_UPDATE",(()=>{this.activateInit()}))}activateInit=()=>{this.saveOriginData([]),this.getBannerData(),clearTimeout(this.t),this.t=null,this.t=setTimeout((()=>{this.activateInit(),clearTimeout(this.t)}),18e5)};emitterDestroy=()=>r.all.clear();persistentGroupingData=({bu:e,bcs:t})=>{this.bannerUserStore.set("bu",e),this.bannerUserStore.set("bcs",t)};generateURL=()=>{const{uid:e,userId:t}=s,a=this.bannerUserStore.get("bu",t),r=this.bannerUserStore.get("bcs",t);let n=`${B}?url_scheme=${l}`;return n+=a?"&bu="+a:e?"&u="+e:"",n+=r?"&bcs="+r:t?"&cs="+t:"",n};getBannerData=e=>{e||this.abnormalRender(),b({url:this.generateURL(),header:{"X-Timezone":(((new Date).toString()||"").match(/GMT\+[0-9]+/g)||[])[0]},success:({data:t,statusCode:a})=>{200!==a||f(t)||(this.persistentGroupingData(t.idMappings||{}),this.saveOriginData(t.banners),_(e)&&e(this.originData))},fail:()=>{this.retryTimes+=1,3>this.retryTimes?this.getBannerData():e||this.abnormalRender("error")},timeout:5e3})};saveOriginData=e=>{if(S(e)&&!f(e)){const t=e.find((e=>e.key===this.bannerKey));if(!f(t)&&!S(t.messages)){const e=(t.messages||[]).filter((e=>this.verifyTimeRange(e))).sort(((e,t)=>this.verifySorter(e,t))).filter(((e,t,a)=>a.indexOf(e)===t));t.messages=e}if(this.originData=t,this.renderFn){this.renderFn(this.originData.messages);const{userId:e}=s;this.bannerStore.set(this.bannerKey,e,this.originData.messages)}}};verifyTimeRange=e=>{const t=Date.now();return(e.rule.startAt||0)<=t&&t<(e.rule.endAt||t+1)};verifySorter(e,t){return e.index!==t.index?e.index-t.index:e.priority!==t.priority?t.priority-e.priority:t.updateAt-e.updateAt}abnormalRender=(e="default")=>{const{userId:t}=s,a=this.bannerStore.get(this.bannerKey,t);f(a)?this.renderFn([{...k,id:"gioDefault",name:"gioDefault",content:("default"===e?this.placeholderDrawable:this.errorReplaceDrawable)||""}]):this.renderFn(a)};gatherTrackParams=e=>({in_app_message_name:e.name,gio_message_type:"banner",gio_message_id:e.id,gio_message_index:e.index,gio_campaign_key:this.bannerKey});handleChange=e=>{let a;if(a=D(e.detail,"current")?e.detail.current:e.target.dataset.current,T(a)&&!this.trackedImg.includes(a)&&this.originData.messages){const e=this.originData.messages[a];t("track","in_app_message_imp",this.gatherTrackParams(e)),this.trackedImg.push(a)}};handleTarget=e=>{const a=e.target.dataset.message;a&&"gioDefault"!==a.id&&(t("track","in_app_message_cmp_click",this.gatherTrackParams(a)),a.rule.target&&this.navigateDistribute(a.rule.target))};navigateDistribute=e=>{const t=/^MINP::(.*?)::(.*)/,a=["develop","trial","release"];if(t.test(e)){const[r,n,i]=e.match(t);p({appId:n,path:i,envVersion:a.includes(this.envVersion)?this.envVersion:"release"})}else m({url:/^https?:\/\//.test(e)?`${this.h5Page}?url=${e}`:e})}}let C={};(global||$global).getBannerMessages=e=>(f(C)&&(C=new P,C.bannerKey=e),new Promise((e=>{C.getBannerData((t=>{S(t.messages)&&!f(t.messages)?e({...t,messages:t.messages.map((e=>({id:e.id,index:e.index,name:e.name||"",imageUrl:e.content||"",summary:e.summary||"",params:e.bannerParamConfig||[],onShow(){C.onTrackImp(e)},onClick(){C.onClickTarget(e)}})))}):e({...t,messages:[]})}))}))),Component({properties:{bannerKey:String,indicatorDots:{type:Boolean,value:!0},indicatorColor:{type:String,value:"rgba(0,0,0,0.3)"},indicatorActiveColor:{type:String,value:"#000"},autoplay:{type:Boolean,value:!0},interval:{type:Number,value:5e3},duration:{type:Number,value:500},circular:{type:Boolean,value:!0},vertical:{type:Boolean,value:!1},previousMargin:{type:String,value:"0px"},nextMargin:{type:String,value:"0px"},easingFunction:{type:String,value:"default"},placeholderDrawable:String,errorReplaceDrawable:String,h5Page:{type:String,value:"/pages/h5/h5"},envVersion:{type:String,value:"release"}},data:{banners:void 0},lifetimes:{attached(){if(a.gioSDKInitialized){C=new P;const{bannerKey:e,placeholderDrawable:t,errorReplaceDrawable:a,h5Page:r,envVersion:n}=this.properties;C.bannerKey=e,C.h5Page=r,C.envVersion=n,C.placeholderDrawable=t,C.errorReplaceDrawable=a,C.renderFn=e=>{this.setData({banners:e})},e?(C.activateInit(),$("GioBanner 初始化完成!","success")):$("GioBanner 初始化失败！请填写 bannerKey!","error")}},detached(){this.setData({banners:void 0}),C&&C.emitterDestroy(),banner=void 0}},methods:{onImgLoad(e){0===e.target.dataset.current&&C&&C.handleChange(e)},onChange(e){C&&C.handleChange(e)},onTapTarget(e){C&&C.handleTarget(e)}}});
