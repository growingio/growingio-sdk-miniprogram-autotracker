var e,t=function(){return t=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},t.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var r={name:"gioImpressionTracking",method:function(r){var n=this;this.growingIO=r,this.proxyComponentOverriding=function(){var e=n,t=n.growingIO.dataStore.eventHooks.componentOverriding;n.growingIO.dataStore.eventHooks.componentOverriding=function(){var r=t.apply(this,arguments);r.pageLifetimes||(r.pageLifetimes={}),r.pageLifetimes.show||(r.pageLifetimes.show=function(){});var n=r.pageLifetimes.show;return r.pageLifetimes.show=function(){var t=n.apply(this,arguments);return e.growingIO.minipInstance.initImpression(this),t},r}},this.isEqualRects=function(t,r,i){var o,s,a=(null!==(s=(null!==(o=n.rects[r])&&void 0!==o?o:{})[i])&&void 0!==s?s:[]).map((function(t){return e.hashCode(JSON.stringify(t))})),c=(null!=t?t:[]).map((function(t){return e.hashCode(JSON.stringify(t))}));return e.isEqualArray(a,c)},this.rectobserve=function(t,r,i){var o=r.__wxExparserNodeId__,s=r.route?r:n.growingIO.minipInstance.getCurrentPage(),a=!1;if(s.route){var c=n.isEqualRects(t,s.route,o),u=e.get(n.observerIds,"".concat(s.route,".").concat(o,"._disconnected"));a=!c||!1!==u}e.isArray(t)&&!e.isEmpty(t)&&!e.isNil(t[0])&&a&&(e.isEmpty(n.rects[s.route])&&(n.rects[s.route]={}),n.rects[s.route][o]=t,n.creatObserver(r,i))},this.main=function(e,t){var r,i,o=n.growingIO.gioPlatform,s=e.route?null===(r=n.growingIO.minipInstance.minip)||void 0===r?void 0:r.createSelectorQuery():null===(i=n.growingIO.minipInstance.minip)||void 0===i?void 0:i.createSelectorQuery().in(e);["ks","qq"].includes(o)?(s.selectAll(".growing_collect_imp").boundingClientRect((function(r){var i=r[0];n.rectobserve(i,e,t)})),s.exec()):(s.selectAll(".growing_collect_imp").boundingClientRect(),s.exec((function(r){var i=r[0];n.rectobserve(i,e,t)})))},this.creatObserver=function(t,r){var i,o=n.growingIO,s=o.gioPlatform,a=o.minipInstance,c=((i={})[r]=!0,i);["tb","my"].includes(s)&&e.compareVersion(my.SDKVersion,"2.7.0")>=-1&&(c.dataset=!0);var u=t.__wxExparserNodeId__;t.isComponent||!t.route||"component"===t.mpType?function(){var e,t=a.getCurrentPage(),r=null==t?void 0:t.selectComponent(".growing_collect_imp_component");if(r){n.observerIds[t.route]||(n.observerIds[t.route]={});var i=n.observerIds[t.route][u];i&&!i._disconnected&&i.disconnect();var o=null===(e=a.minip)||void 0===e?void 0:e.createIntersectionObserver(r,c);o=o.relativeToViewport(),n.observerIds[t.route][u]=o,n.targetObserve(o,t)}}():function(){var e;n.observerIds[t.route]||(n.observerIds[t.route]={});var r=n.observerIds[t.route][u];r&&!r._disconnected&&r.disconnect();var i=null===(e=a.minip)||void 0===e?void 0:e.createIntersectionObserver(t,c);i=i.relativeToViewport(),n.observerIds[t.route][u]=i,n.targetObserve(i,t)}()},this.targetObserve=function(t,r){var i=n.growingIO.vdsConfig.taro;t.observe(".growing_collect_imp",(function(t){return o=n,s=void 0,c=function(){var n,o,s;return function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,(function(a){if(!e.isEmpty(t)&&t.intersectionRatio>0){if(n=t.dataset,i&&e.isTaro3(i)&&(n=this.getTaro3Dataset(r.route,t.id)),o=this.getImpressionProperties(n),s=t.id){if("once"===n.gioImpType&&e.has(this.sentImps,s))return[2];this.sentImps[s]=o}o.eventId?this.buildImpEvent(o):e.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}return[2]}))},new((a=void 0)||(a=Promise))((function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof a?i:new a((function(e){e(i)}))).then(r,n)}i((c=c.apply(o,s||[])).next())}));var o,s,a,c}))},this.getImpressionProperties=function(t){var r={eventId:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return r;if(r.eventId=t.gioImpTrack,e.has(t,"gioImpAttrs"))r.properties=e.niceTry((function(){return e.isObject(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs)})),r.items=e.niceTry((function(){return e.isObject(t.gioImpItems)?t.gioImpItems:JSON.parse(t.gioImpItems)}));else{var n=/^gioTrack(.+)/;for(var i in t){var o=void 0,s=i.match(n);s&&"track"!==(o=e.lowerFirst(s[1]))&&(r.properties[o]=t[i])}}return r.properties=e.limitObject(r.properties),r.items=e.limitObject(r.items),/^\w+$/.test(r.eventId)&&!Number.isInteger(Number.parseInt(e.head(r.eventId.split("")),10))||(r.eventId=null,r={}),r},this.getTaro3Dataset=function(t,r){var i,o=null===(i=n.growingIO)||void 0===i?void 0:i.taro3VMs[t];if(!o)return!1;var s={},a=function(t){t.some((function(t){var n;return t.uid!==r&&t.sid!==r||-1>=(null===(n=t.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))||e.isEmpty(t.dataset)?!!Array.isArray(t.childNodes)&&a(t.childNodes):(s=t.dataset,!0)}))};return a(o.childNodes),s},this.buildImpEvent=function(e){var r=e.eventId,i=e.properties,o=e.items,s=n.growingIO.dataStore,a=s.eventContextBuilder,c=s.eventInterceptor,u=s.eventHooks;c(t({eventType:"CUSTOM",pageShowTimestamp:u.currentPage.time,eventName:r,attributes:i,resourceItem:o},a()))},e=this.growingIO.utils,this.observerIds={},this.rects={},this.sentImps={},this.proxyComponentOverriding();var i=this.growingIO,o=i.emitter,s=i.minipInstance;this.growingIO.updateImpression=function(e){e||(e=s.getCurrentPage()),s.initImpression(e)},o.on("minipLifecycle",(function(e){var t,r=e.event,i=e.params,o=n.growingIO.minipInstance;if("Page onShowEnd"===r){var s=o.getCurrentPage();o.initImpression(s);var a=s.selectComponent(".growing_collect_imp_component");a&&o.initImpression(a)}if(["Page onHide","Page onUnload"].includes(r)){var c=i.page.route;Object.values(null!==(t=n.observerIds[c])&&void 0!==t?t:{}).forEach((function(e){return e.disconnect()}))}}))}};export{r as default};
