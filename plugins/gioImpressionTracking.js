let e;var t={name:"gioImpressionTracking",method:class{constructor(t){this.growingIO=t,this.main=(t,i)=>{var r,s,n;const{vdsConfig:o,minipInstance:a,gioPlatform:c}=this.growingIO,{uniVue:p,taro:m}=o,l=(e=>{if(e){const i=Number.parseInt((e=>{try{return Array.from(e)[0]}catch(e){return}})("string"==typeof(t=e.version)?t.split("."):t),10);return Number.isNaN(i)?0:i}return 0;var t})(p);p&&2===l&&(t=t.$vm.$scope),this.impressionObserver&&this.impressionObserver.disconnect(),"my"===c?-1>((e="",t="")=>{const i=e=>e.replace(/\s+/g,""),r=e=>e.replace(/[vV]/g,""),s=i(r(e)),n=i(r(t)),o=s.split("."),a=n.split(".");for(var c=0;3>c;c++){var p=Number(o[c]),m=Number(a[c]);if(p>m)return 1;if(m>p)return-1;if(!isNaN(p)&&isNaN(m))return 1;if(isNaN(p)&&!isNaN(m))return-1}return 0})(my.SDKVersion,"2.7.0")||(this.impressionObserver=null===(r=a.minip)||void 0===r?void 0:r.createIntersectionObserver({[i]:!0,dataset:!0})):t.isComponent?this.impressionObserver=t.createIntersectionObserver({[i]:!0}):this.impressionObserver=null===(s=a.minip)||void 0===s?void 0:s.createIntersectionObserver(t,{[i]:!0});const u=null===(n=this.impressionObserver)||void 0===n?void 0:n.relativeToViewport();null==u||u.observe(".growing_collect_imp",(i=>{return r=this,s=void 0,o=function*(){if(!e.isEmpty(i)&&i.intersectionRatio>0){let r=i.dataset;m&&(e=>{const{Current:t,createComponent:i}=e;return!(!e||!t||i)})(m)&&(r=this.getTaro3Dataset(t.route,i.id)),"ks"===c&&(yield this.getKsDataset(i).then((e=>r=e)));const s=this.getImpressionProperties(r),n=i.id;if(n){if("once"===r.gioImpType&&e.has(this.sentImps,n))return;this.sentImps[n]=s}s.eventId?this.buildImpEvent(s):e.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}},new((n=void 0)||(n=Promise))((function(e,t){function i(e){try{c(o.next(e))}catch(e){t(e)}}function a(e){try{c(o.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(i,a)}c((o=o.apply(r,s||[])).next())}));var r,s,n,o}))},this.getImpressionProperties=t=>{let i={eventId:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return i;if(i.eventId=t.gioImpTrack,e.has(t,"gioImpAttrs"))i.properties=e.niceTry((()=>e.isObject(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs))),i.items=e.niceTry((()=>e.isObject(t.gioImpItems)?t.gioImpItems:JSON.parse(t.gioImpItems)));else{const r=/^gioTrack(.+)/;for(const s in t){let n;const o=s.match(r);o&&(n=e.lowerFirst(o[1]),"track"!==n&&(i.properties[n]=t[s]))}}return i.properties=e.limitObject(i.properties),i.items=e.limitObject(i.items),/^\w+$/.test(i.eventId)&&!Number.isInteger(Number.parseInt(e.head(i.eventId.split("")),10))||(i.eventId=null,i={}),i},this.getTaro3Dataset=(t,i)=>{var r;const s=null===(r=this.growingIO)||void 0===r?void 0:r.taro3VMs[t];if(!s)return!1;let n={};const o=t=>{t.some((t=>{var r;return t.uid===i&&(null===(r=t.props)||void 0===r?void 0:r.class.indexOf("growing_collect_imp"))>-1&&!e.isEmpty(t.dataset)?(n=t.dataset,!0):!!Array.isArray(t.childNodes)&&o(t.childNodes)}))};return o(s.childNodes),n},this.getKsDataset=t=>{const{minipInstance:i}=this.growingIO,r=i.minip.createSelectorQuery().selectAll(".growing_collect_imp"),{width:s,height:n}=t.boundingClientRect;return new Promise((t=>{r.boundingClientRect((i=>{const r=i.find((t=>e.fixed(s)===e.fixed(t.width)&&e.fixed(n)===e.fixed(t.height)));t((null==r?void 0:r.dataset)||{})})).exec()}))},this.buildImpEvent=e=>{const{eventId:t,properties:i,items:r}=e,{dataStore:{eventContextBuilder:s,eventInterceptor:n,eventHooks:o}}=this.growingIO;n(Object.assign({eventType:"CUSTOM",pageShowTimestamp:o.currentPage.time,eventName:t,attributes:i,resourceItem:r},s()))},e=this.growingIO.utils,this.sentImps={}}}};export{t as default};
