var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};var t,r={name:"gioImpressionTracking",method:function(r){var n=this;this.growingIO=r,this.main=function(e,t){var r,i,o,s,a,c,u=n.growingIO,l=u.vdsConfig,p=u.minipInstance,v=u.gioPlatform,f=l.uniVue,m=function(e){if(e){var t=Number.parseInt(function(e){try{return Array.from(e)[0]}catch(e){return}}("string"===(r=n=e.version,{}.toString.call(r).slice(8,-1).toLowerCase())?n.split("."):n),10);return Number.isNaN(t)?0:t}var r,n;return 0}(f);f&&2===m&&(e=e.$vm.$scope),n.impressionObserver&&n.impressionObserver.disconnect(),"my"===v?-1>function(e,t){void 0===e&&(e=""),void 0===t&&(t="");for(var r=function(e){return e.replace(/\s+/g,"")},n=function(e){return e.replace(/[vV]/g,"")},i=r(n(e)),o=r(n(t)),s=i.split("."),a=o.split("."),c=0;3>c;c++){var u=Number(s[c]),l=Number(a[c]);if(u>l)return 1;if(l>u)return-1;if(!isNaN(u)&&isNaN(l))return 1;if(isNaN(u)&&!isNaN(l))return-1}return 0}(my.SDKVersion,"2.7.0")||(n.impressionObserver=null===(s=p.minip)||void 0===s?void 0:s.createIntersectionObserver(((r={})[t]=!0,r.dataset=!0,r))):e.isComponent?n.impressionObserver=e.createIntersectionObserver(((i={})[t]=!0,i)):n.impressionObserver=null===(a=p.minip)||void 0===a?void 0:a.createIntersectionObserver(e,((o={})[t]=!0,o)),null===(c=n.growingIO.minipInstance.minip)||void 0===c||c.createSelectorQuery().select(".growing_collect_imp").boundingClientRect((function(t){t&&n.creatObserver(e)})).exec()},this.creatObserver=function(e){var r,i=n.growingIO,o=i.vdsConfig.taro,s=i.gioPlatform,a=null===(r=n.impressionObserver)||void 0===r?void 0:r.relativeToViewport();null==a||a.observe(".growing_collect_imp",(function(r){return i=n,a=void 0,u=function(){var n,i,a;return function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,(function(c){switch(c.label){case 0:return t.isEmpty(r)||0>=r.intersectionRatio?[3,3]:(n=r.dataset,o&&function(e){var t=e.Current,r=e.createComponent;return!(!e||!t||r)}(o)&&(n=this.getTaro3Dataset(e.route,r.id)),"ks"!==s?[3,2]:[4,this.getKsDataset(r).then((function(e){return n=e}))]);case 1:c.sent(),c.label=2;case 2:if(i=this.getImpressionProperties(n),a=r.id){if("once"===n.gioImpType&&t.has(this.sentImps,a))return[2];this.sentImps[a]=i}i.eventId?this.buildImpEvent(i):t.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn"),c.label=3;case 3:return[2]}}))},new((c=void 0)||(c=Promise))((function(e,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(r,n)}o((u=u.apply(i,a||[])).next())}));var i,a,c,u}))},this.getImpressionProperties=function(e){var r={eventId:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return r;if(r.eventId=e.gioImpTrack,t.has(e,"gioImpAttrs"))r.properties=t.niceTry((function(){return t.isObject(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs)})),r.items=t.niceTry((function(){return t.isObject(e.gioImpItems)?e.gioImpItems:JSON.parse(e.gioImpItems)}));else{var n=/^gioTrack(.+)/;for(var i in e){var o=void 0,s=i.match(n);s&&"track"!==(o=t.lowerFirst(s[1]))&&(r.properties[o]=e[i])}}return r.properties=t.limitObject(r.properties),r.items=t.limitObject(r.items),/^\w+$/.test(r.eventId)&&!Number.isInteger(Number.parseInt(t.head(r.eventId.split("")),10))||(r.eventId=null,r={}),r},this.getTaro3Dataset=function(e,r){var i,o=null===(i=n.growingIO)||void 0===i?void 0:i.taro3VMs[e];if(!o)return!1;var s={},a=function(e){e.some((function(e){var n;return e.uid===r&&(null===(n=e.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))>-1&&!t.isEmpty(e.dataset)?(s=e.dataset,!0):!!Array.isArray(e.childNodes)&&a(e.childNodes)}))};return a(o.childNodes),s},this.getKsDataset=function(e){var r=n.growingIO.minipInstance.minip.createSelectorQuery().selectAll(".growing_collect_imp"),i=e.boundingClientRect,o=i.width,s=i.height;return new Promise((function(e){r.boundingClientRect((function(r){var n=r.find((function(e){return t.fixed(o)===t.fixed(e.width)&&t.fixed(s)===t.fixed(e.height)}));e((null==n?void 0:n.dataset)||{})})).exec()}))},this.buildImpEvent=function(t){var r=t.eventId,i=t.properties,o=t.items,s=n.growingIO.dataStore,a=s.eventContextBuilder,c=s.eventInterceptor,u=s.eventHooks;c(e({eventType:"CUSTOM",pageShowTimestamp:u.currentPage.time,eventName:r,attributes:i,resourceItem:o},a()))},t=this.growingIO.utils,this.growingIO.updateImpression=function(){n.main(n.growingIO.minipInstance.getCurrentPage(),"observeAll")},this.sentImps={}}};export{r as default};
