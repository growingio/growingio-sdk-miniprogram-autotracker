let e;var t={name:"gioImpressionTracking",method:class{constructor(t){this.growingIO=t,this.main=(e,t)=>{var i,r,s;const{vdsConfig:n,minipInstance:o,gioPlatform:a}=this.growingIO,{uniVue:c}=n,p=(e=>{if(e){const r=Number.parseInt((e=>{try{return Array.from(e)[0]}catch(e){return}})("string"===(t=i=e.version,{}.toString.call(t).slice(8,-1).toLowerCase())?i.split("."):i),10);return Number.isNaN(r)?0:r}var t,i;return 0})(c);c&&2===p&&(e=e.$vm.$scope),this.impressionObserver&&this.impressionObserver.disconnect(),"my"===a?-1>((e="",t="")=>{const i=e=>e.replace(/\s+/g,""),r=e=>e.replace(/[vV]/g,""),s=i(r(e)),n=i(r(t)),o=s.split("."),a=n.split(".");for(let e=0;3>e;e++){let t=Number(o[e]),i=Number(a[e]);if(t>i)return 1;if(i>t)return-1;if(!isNaN(t)&&isNaN(i))return 1;if(isNaN(t)&&!isNaN(i))return-1}return 0})(my.SDKVersion,"2.7.0")||(this.impressionObserver=null===(i=o.minip)||void 0===i?void 0:i.createIntersectionObserver({[t]:!0,dataset:!0})):e.isComponent?this.impressionObserver=e.createIntersectionObserver({[t]:!0}):this.impressionObserver=null===(r=o.minip)||void 0===r?void 0:r.createIntersectionObserver(e,{[t]:!0}),null===(s=this.growingIO.minipInstance.minip)||void 0===s||s.createSelectorQuery().select(".growing_collect_imp").boundingClientRect((t=>{t&&this.creatObserver(e)})).exec()},this.creatObserver=t=>{var i;const{vdsConfig:{taro:r},gioPlatform:s}=this.growingIO,n=null===(i=this.impressionObserver)||void 0===i?void 0:i.relativeToViewport();null==n||n.observe(".growing_collect_imp",(i=>{return n=this,o=void 0,c=function*(){if(!e.isEmpty(i)&&i.intersectionRatio>0){let n=i.dataset;r&&(e=>{const{Current:t,createComponent:i}=e;return!(!e||!t||i)})(r)&&(n=this.getTaro3Dataset(t.route,i.id)),"ks"===s&&(yield this.getKsDataset(i).then((e=>n=e)));const o=this.getImpressionProperties(n),a=i.id;if(a){if("once"===n.gioImpType&&e.has(this.sentImps,a))return;this.sentImps[a]=o}o.eventId?this.buildImpEvent(o):e.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}},new((a=void 0)||(a=Promise))((function(e,t){function i(e){try{s(c.next(e))}catch(e){t(e)}}function r(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof a?s:new a((function(e){e(s)}))).then(i,r)}s((c=c.apply(n,o||[])).next())}));var n,o,a,c}))},this.getImpressionProperties=t=>{let i={eventId:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return i;if(i.eventId=t.gioImpTrack,e.has(t,"gioImpAttrs"))i.properties=e.niceTry((()=>e.isObject(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs))),i.items=e.niceTry((()=>e.isObject(t.gioImpItems)?t.gioImpItems:JSON.parse(t.gioImpItems)));else{const r=/^gioTrack(.+)/;for(const s in t){let n;const o=s.match(r);o&&(n=e.lowerFirst(o[1]),"track"!==n&&(i.properties[n]=t[s]))}}return i.properties=e.limitObject(i.properties),i.items=e.limitObject(i.items),/^\w+$/.test(i.eventId)&&!Number.isInteger(Number.parseInt(e.head(i.eventId.split("")),10))||(i.eventId=null,i={}),i},this.getTaro3Dataset=(t,i)=>{var r;const s=null===(r=this.growingIO)||void 0===r?void 0:r.taro3VMs[t];if(!s)return!1;let n={};const o=t=>{t.some((t=>{var r;return t.uid===i&&(null===(r=t.props)||void 0===r?void 0:r.class.indexOf("growing_collect_imp"))>-1&&!e.isEmpty(t.dataset)?(n=t.dataset,!0):!!Array.isArray(t.childNodes)&&o(t.childNodes)}))};return o(s.childNodes),n},this.getKsDataset=t=>{const{minipInstance:i}=this.growingIO,r=i.minip.createSelectorQuery().selectAll(".growing_collect_imp"),{width:s,height:n}=t.boundingClientRect;return new Promise((t=>{r.boundingClientRect((i=>{const r=i.find((t=>e.fixed(s)===e.fixed(t.width)&&e.fixed(n)===e.fixed(t.height)));t((null==r?void 0:r.dataset)||{})})).exec()}))},this.buildImpEvent=e=>{const{eventId:t,properties:i,items:r}=e,{dataStore:{eventContextBuilder:s,eventInterceptor:n,eventHooks:o}}=this.growingIO;n(Object.assign({eventType:"CUSTOM",pageShowTimestamp:o.currentPage.time,eventName:t,attributes:i,resourceItem:r},s()))},e=this.growingIO.utils,this.growingIO.updateImpression=()=>{this.main(this.growingIO.minipInstance.getCurrentPage(),"observeAll")},this.sentImps={}}}};export{t as default};
