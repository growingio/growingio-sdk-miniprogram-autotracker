var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,r=function(e){return"[object Object]"==={}.toString.call(e)&&!function(e){return["undefined","null"].includes(i(e))}(e)},n=function(e){return Array.isArray(e)&&"array"===i(e)},i=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},o=function(e){var t,i=0;if((n(t=e)?0===t.length:r(t)?0===function(e){return r(e)?Object.keys(e):[]}(t).length:!t)||"boolean"==typeof e)return i;for(var o=0;o<e.length;)i=(i<<5)-i+e.charCodeAt(o),i&=i,o++;return i},s={name:"gioImpressionTracking",method:function(r){var i=this;this.growingIO=r,this.traverseListen=function(e){var r=i.growingIO.minipInstance;if(t.isFunction(null==e?void 0:e.selectAllComponents)){var n=null==e?void 0:e.selectAllComponents(".growing_collect_imp_component");t.isEmpty(n)||n.forEach((function(e){i.traverseListen(e)}))}r.initImpression(e)},this.isEqualRects=function(e,t,r){var s,a,c,u,l=(null!==(a=(null!==(s=i.rects[t])&&void 0!==s?s:{})[r])&&void 0!==a?a:[]).map((function(e){return o(JSON.stringify(e))})),p=(null!=e?e:[]).map((function(e){return o(JSON.stringify(e))}));return u=p,!(!n(c=l)||!n(u)||c.length!==u.length)&&c.every((function(e,t){return e===u[t]}))},this.rectobserve=function(e,r,n){var o=r.__wxExparserNodeId__,s=r.route?r:i.growingIO.minipInstance.getCurrentPage(),a=!1;if(s.route){var c=i.isEqualRects(e,s.route,o),u=t.get(i.observerIds,"".concat(s.route,".").concat(o,"._disconnected"));a=!c||!1!==u}t.isArray(e)&&!t.isEmpty(e)&&!t.isNil(e[0])&&a&&(t.isEmpty(i.rects[s.route])&&(i.rects[s.route]={}),i.rects[s.route][o]=e,i.creatObserver(r,n))},this.main=function(e,r){var n,o,s=i.growingIO.gioPlatform,a=e.route?null===(n=i.growingIO.minipInstance.minip)||void 0===n?void 0:n.createSelectorQuery():null===(o=i.growingIO.minipInstance.minip)||void 0===o?void 0:o.createSelectorQuery().in(e);["ks","qq"].includes(s)?(a.selectAll(".growing_collect_imp").boundingClientRect((function(n){var o=n[0];o=t.isNil(o)||t.isArray(o)?o:[o],i.rectobserve(o,e,r)})),a.exec()):(a.selectAll(".growing_collect_imp").boundingClientRect(),a.exec((function(t){var n=t[0];i.rectobserve(n,e,r)})))},this.creatObserver=function(e,r){var n,o,s=i.growingIO,a=s.gioPlatform,c=s.minipInstance,u=((n={})[r]=!0,n);["tb","my"].includes(a)&&t.compareVersion(my.SDKVersion,"2.7.0")>=-1&&(u.dataset=!0);var l=e.__wxExparserNodeId__,p=e;!e.isComponent&&e.route&&"component"!==e.mpType||(p=c.getCurrentPage()),i.observerIds[p.route]||(i.observerIds[p.route]={});var v=i.observerIds[p.route][l];v&&!v._disconnected&&v.disconnect();var g="jd"===a?null===(o=c.minip)||void 0===o?void 0:o.createIntersectionObserver(e,u):e.createIntersectionObserver(u);g=g.relativeToViewport(),i.observerIds[p.route][l]=g,i.targetObserve(g,p)},this.targetObserve=function(e,r){var n=i.growingIO.vdsConfig.taro;e.observe(".growing_collect_imp",(function(e){if(!t.isEmpty(e)&&e.intersectionRatio>0){var o=e.dataset;n&&t.isTaro3(n)&&(o=i.getTaro3Dataset(r.route,e.id));var s=i.getImpressionProperties(o),a=e.id;if(a){if("once"===o.gioImpType&&t.has(i.sentImps,a))return;i.sentImps[a]=s}s.eventId?i.buildImpEvent(s):t.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}}))},this.getImpressionProperties=function(e){var r={eventId:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return r;if(r.eventId=e.gioImpTrack,t.has(e,"gioImpAttrs"))r.properties=t.niceTry((function(){return t.isObject(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs)})),r.items=t.niceTry((function(){return t.isObject(e.gioImpItems)?e.gioImpItems:JSON.parse(e.gioImpItems)}));else{var n=/^gioTrack(.+)/;for(var i in e){var o=void 0,s=i.match(n);s&&"track"!==(o=t.lowerFirst(s[1]))&&(r.properties[o]=e[i])}}return r.properties=t.limitObject(r.properties),r.items=t.limitObject(r.items),/^\w+$/.test(r.eventId)&&!Number.isInteger(Number.parseInt(t.head(r.eventId.split("")),10))||(r.eventId=null,r={}),r},this.getTaro3Dataset=function(e,r){var n,o=null===(n=i.growingIO)||void 0===n?void 0:n.taro3VMs[e];if(!o)return!1;var s={},a=function(e){e.some((function(e){var n;return e.uid!==r&&e.sid!==r||-1>=(null===(n=e.props)||void 0===n?void 0:n.class.indexOf("growing_collect_imp"))||t.isEmpty(e.dataset)?!!Array.isArray(e.childNodes)&&a(e.childNodes):(s=e.dataset,!0)}))};return a(o.childNodes),s},this.buildImpEvent=function(t){var r=t.eventId,n=t.properties,o=t.items,s=i.growingIO.dataStore,a=s.eventContextBuilder,c=s.eventInterceptor,u=s.eventHooks;c(e({eventType:"CUSTOM",pageShowTimestamp:u.currentPage.time,eventName:r,attributes:n,resourceItem:o},a()))},t=this.growingIO.utils,this.observerIds={},this.rects={},this.sentImps={};var s=this.growingIO,a=s.emitter,c=s.minipInstance;this.growingIO.updateImpression=function(e){e||(e=c.getCurrentPage()),c.initImpression(e)},a.on("minipLifecycle",(function(e){var t,r=e.event,n=e.params,o=i.growingIO.minipInstance;if("Page onShowEnd"===r){var s=o.getCurrentPage();i.traverseListen(s)}if(["Page onHide","Page onUnload"].includes(r)){var a=n.page.route;Object.values(null!==(t=i.observerIds[a])&&void 0!==t?t:{}).forEach((function(e){return e.disconnect()}))}}))}};export{s as default};
