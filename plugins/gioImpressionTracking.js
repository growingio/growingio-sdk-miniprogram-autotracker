const e=e=>(e=>Array.isArray(e)&&"[object Array]"==={}.toString.call(e))(e)?e[0]:void 0;let t;var i={name:"gioImpressionTracking",method:class{constructor(i){this.growingIO=i,this.main=(i,r)=>{var s,n,o;const{vdsConfig:a,minipInstance:c,gioPlatform:p}=this.growingIO,{uniVue:l,taro:m}=a,d=(t=>{if(t){const r=Number.parseInt(e((".","string"==typeof(i=t.version)?i.split("."):i)),10);return Number.isNaN(r)?0:r}return 0;var i})(l);l&&2===d&&(i=i.$vm.$scope),this.impressionObserver&&this.impressionObserver.disconnect(),"my"===p?((t,i)=>{const r=e=>e.replace(/\s+/g,""),s=e=>e.replace(/[vV]/g,""),n=r(s(my.SDKVersion)),o=r(s("2.7.0")),a=n.split("."),c=o.split(".");return""===e(a)&&a.unshift(0),""===e(c)&&c.unshift(0),(a.length>c.length?a:c).every(((e,t)=>Number.parseInt(a[t]||0,10)>=Number.parseInt(c[t]||0,10)))})()&&(this.impressionObserver=null===(s=c.minip)||void 0===s?void 0:s.createIntersectionObserver({[r]:!0,dataset:!0})):i.isComponent?this.impressionObserver=i.createIntersectionObserver({[r]:!0}):this.impressionObserver=null===(n=c.minip)||void 0===n?void 0:n.createIntersectionObserver(i,{[r]:!0});const v=null===(o=this.impressionObserver)||void 0===o?void 0:o.relativeToViewport();null==v||v.observe(".growing_collect_imp",(e=>{return r=this,s=void 0,o=function*(){if(!t.isEmpty(e)&&e.intersectionRatio>0){let r=e.dataset;m&&(e=>{const{Current:t,createComponent:i}=e;return!(!e||!t||i)})(m)&&(r=this.getTaro3Dataset(i.route,e.id)),"ks"===p&&(yield this.getKsDataset(e).then((e=>r=e)));const s=this.getImpressionProperties(r);s.eventId?this.buildImpEvent(s):t.consoleText("曝光事件格式不正确，事件名只能包含数字、字母和下划线，且不以数字开头!","warn")}},new((n=void 0)||(n=Promise))((function(e,t){function i(e){try{c(o.next(e))}catch(e){t(e)}}function a(e){try{c(o.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(i,a)}c((o=o.apply(r,s||[])).next())}));var r,s,n,o}))},this.getImpressionProperties=e=>{let i={eventId:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return i;if(i.eventId=e.gioImpTrack,t.has(e,"gioImpAttrs"))i.properties=t.niceTry((()=>t.isObject(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs))),i.items=t.niceTry((()=>t.isObject(e.gioImpItems)?e.gioImpItems:JSON.parse(e.gioImpItems)));else{const r=/^gioTrack(.+)/;for(const s in e){let n;const o=s.match(r);o&&(n=t.lowerFirst(o[1]),"track"!==n&&(i.properties[n]=e[s]))}}return i.properties=t.limitObject(i.properties),i.items=t.limitObject(i.items),/^\w+$/.test(i.eventId)&&!Number.isInteger(Number.parseInt(t.head(i.eventId.split("")),10))||(i.eventId=null,i={}),i},this.getTaro3Dataset=(e,i)=>{var r;const s=null===(r=this.growingIO)||void 0===r?void 0:r.taro3VMs[e];if(!s)return!1;let n={};const o=e=>{e.some((e=>{var r;return e.uid===i&&(null===(r=e.props)||void 0===r?void 0:r.class.indexOf("growing_collect_imp"))>-1&&!t.isEmpty(e.dataset)?(n=e.dataset,!0):!!Array.isArray(e.childNodes)&&o(e.childNodes)}))};return o(s.childNodes),n},this.getKsDataset=e=>{const{minipInstance:i}=this.growingIO,r=i.minip.createSelectorQuery().selectAll(".growing_collect_imp"),{width:s,height:n}=e.boundingClientRect;return new Promise((e=>{r.boundingClientRect((i=>{const r=i.find((e=>t.fixed(s)===t.fixed(e.width)&&t.fixed(n)===t.fixed(e.height)));e((null==r?void 0:r.dataset)||{})})).exec()}))},this.buildImpEvent=e=>{const{eventId:t,properties:i,items:r}=e,{dataStore:{eventContextBuilder:s,eventInterceptor:n,eventHooks:o}}=this.growingIO;n(Object.assign({eventType:"CUSTOM",pageShowTimestamp:o.currentPage.time,eventName:t,attributes:i,resourceItem:r},s()))},t=this.growingIO.utils}}};export{i as default};
